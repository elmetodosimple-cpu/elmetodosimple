<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>ElMétodoSimple</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=Instrument+Sans:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--bg:#0F0F0D;--surf:#1A1A17;--surf2:#222220;--bord:rgba(232,197,71,0.12);--y:#E8C547;--yd:rgba(232,197,71,0.15);--ym:rgba(232,197,71,0.4);--txt:#F0EDE4;--mut:#7A7870;--danger:#E87047;--grn:#6BBF7A}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px}
body{background:var(--bg);font-family:'Instrument Sans',sans-serif;color:var(--txt);min-height:100vh;overflow-x:hidden}
button{cursor:pointer;font-family:inherit;border:none;background:none}
input,select{font-family:inherit;outline:none}

/* LAYER SYSTEM */
#layer-auth,#layer-choose,#layer-expired{position:fixed;inset:0;z-index:9999;display:none;align-items:flex-start;justify-content:center;background:var(--bg);overflow-y:auto;padding:20px 16px}
#layer-auth.show,#layer-choose.show,#layer-expired.show{display:flex}

/* AUTH */
.auth-box{background:var(--surf);border:1px solid var(--bord);border-radius:24px;padding:36px 28px;width:100%;max-width:400px;animation:fu .4s ease;margin:auto}
.alogo{font-family:'Syne',sans-serif;font-size:1.5rem;font-weight:800;text-align:center;margin-bottom:5px}
.alogo span{color:var(--y)}
.atag{text-align:center;font-size:.8rem;color:var(--mut);margin-bottom:28px}
.atabs{display:flex;background:var(--bg);border-radius:10px;padding:3px;margin-bottom:20px;gap:3px}
.atab{flex:1;padding:9px;text-align:center;font-size:.83rem;font-weight:500;cursor:pointer;border-radius:8px;color:var(--mut);border:none;background:transparent;transition:all .2s}
.atab.on{background:var(--y);color:var(--bg);font-weight:700}
.fl{margin-bottom:12px}
.fl label{display:block;font-size:.7rem;font-weight:600;color:var(--mut);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px}
.fi{width:100%;background:var(--bg);border:1.5px solid var(--bord);border-radius:9px;padding:11px 14px;color:var(--txt);font-size:.9rem;transition:border-color .2s}
.fi:focus{border-color:var(--ym)}
.fi::placeholder{color:var(--mut)}
.bp{width:100%;padding:13px;background:var(--y);color:var(--bg);border:none;border-radius:11px;font-family:'Syne',sans-serif;font-size:.92rem;font-weight:700;cursor:pointer;transition:opacity .2s;margin-top:4px}
.bp:hover{opacity:.88}
.adiv{text-align:center;font-size:.73rem;color:var(--mut);margin:14px 0;position:relative}
.adiv::before,.adiv::after{content:'';position:absolute;top:50%;width:36%;height:1px;background:var(--bord)}
.adiv::before{left:0}.adiv::after{right:0}
.gbtn{width:100%;padding:11px;background:transparent;border:1px solid var(--bord);border-radius:11px;color:var(--txt);font-size:.85rem;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:9px;transition:all .2s}
.gbtn:hover{border-color:var(--ym);background:var(--yd)}
.anote{text-align:center;font-size:.71rem;color:var(--mut);margin-top:14px;line-height:1.5}

/* CHOOSE */
.choose-box{width:100%;max-width:460px;padding:24px 16px;animation:fu .4s ease;margin:auto}
.clogo{font-family:'Syne',sans-serif;font-size:1.3rem;font-weight:800;text-align:center;margin-bottom:4px}
.clogo span{color:var(--y)}
.ctag{text-align:center;font-size:.78rem;color:var(--mut);margin-bottom:6px}
.cgreet{font-family:'Syne',sans-serif;font-size:1.05rem;font-weight:600;text-align:center;margin-bottom:22px;color:var(--txt)}
.mods{display:flex;flex-direction:column;gap:10px}
.mod{width:100%;background:var(--surf);border:1px solid var(--bord);border-radius:16px;padding:18px 20px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:all .22s;text-align:left}
.mod:hover{border-color:rgba(232,197,71,.3);transform:translateX(3px)}
.mod.locked{opacity:.4;cursor:not-allowed;pointer-events:none}
.mico{font-size:1.6rem;width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.mico.ag{background:rgba(232,197,71,.1)}
.mico.fi{background:rgba(107,191,122,.1)}
.mico.al{background:rgba(201,123,75,.1)}
.minf{flex:1}
.mname{font-family:'Syne',sans-serif;font-size:.95rem;font-weight:700;margin-bottom:2px}
.mdesc{font-size:.75rem;color:var(--mut);line-height:1.4}
.mbadge{font-size:.67rem;padding:3px 9px;border-radius:99px;font-weight:600;white-space:nowrap;flex-shrink:0}
.mbadge.ok{background:rgba(107,191,122,.1);color:var(--grn)}
.mbadge.no{background:rgba(232,112,71,.1);color:var(--danger)}
.mbadge.soon{background:var(--yd);color:var(--y)}
.cfoot{display:flex;justify-content:space-between;align-items:center;margin-top:22px;padding-top:16px;border-top:1px solid var(--bord)}
.cfoot-info{font-size:.73rem;color:var(--mut)}
.cfoot-info strong{color:var(--grn)}
.blogout{background:transparent;border:1px solid rgba(232,112,71,.25);color:var(--danger);border-radius:9px;padding:7px 14px;font-size:.78rem;font-weight:600;cursor:pointer;transition:background .2s}
.blogout:hover{background:rgba(232,112,71,.08)}

/* EXPIRED */
.exp-box{text-align:center;max-width:400px;padding:44px;background:var(--surf);border:1px solid rgba(232,112,71,.2);border-radius:24px;animation:fu .4s ease}
.exp-ico{font-size:2.8rem;margin-bottom:16px}
.exp-box h2{font-family:'Syne',sans-serif;font-size:1.4rem;margin-bottom:10px}
.exp-box p{color:var(--mut);font-size:.87rem;line-height:1.6;margin-bottom:20px}
.price-b{display:inline-block;background:var(--yd);border:1px solid var(--ym);color:var(--y);font-family:'Syne',sans-serif;font-size:1.7rem;font-weight:800;padding:10px 24px;border-radius:10px;margin-bottom:18px}

/* APP TOPBAR */
#app-bar{display:none;background:var(--surf);border-bottom:1px solid var(--bord);padding:0 20px;height:48px;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:500;flex-shrink:0}
#app-bar.show{display:flex}
.barlogo{font-family:'Syne',sans-serif;font-size:.95rem;font-weight:800}
.barlogo span{color:var(--y)}
.bar-right{display:flex;align-items:center;gap:10px}
.abadge{font-size:.68rem;padding:3px 9px;border-radius:99px;font-weight:500}
.abadge.ok{background:rgba(107,191,122,.1);color:var(--grn)}
.abadge.warn{background:var(--yd);color:var(--y)}
.bhome{background:var(--surf2);border:1px solid var(--bord);border-radius:7px;padding:5px 11px;color:var(--mut);font-size:.76rem;font-weight:500;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:4px}
.bhome:hover{border-color:var(--ym);color:var(--txt)}

/* MODULE CONTAINERS */
#mod-agenda,#mod-finanzas{display:none}
#mod-agenda.show,#mod-finanzas.show{display:block}

@keyframes fu{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
</style>
<style id="css-agenda">
#mod-agenda {
  --bg:       #0e0c09;
  --bg2:      #161310;
  --bg3:      #1e1a14;
  --bg4:      #26211a;
  --gold:     #c9a84c;
  --gold2:    #e8d5a0;
  --gold3:    #8a6820;
  --gold4:    #fdf4e0;
  --cream:    #f7f2e8;
  --text:     #f0ead8;
  --text2:    #a89870;
  --text3:    #5a5040;
  --border:   #2e2820;
  --border2:  #3e3528;
  --green:    #4a8c5c;
  --green2:   #d4ede0;
  --red:      #a84a3c;
  --red2:     #fdecea;
  --blue:     #3a6fa8;
  --blue2:    #d4e4f7;
  --r:        16px;
  --r2:       12px;
  --r3:       8px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{font-size:16px;scroll-behavior:smooth}
body{background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif;min-height:100vh;overflow-x:hidden}
button{cursor:pointer;font-family:'Outfit',sans-serif;border:none;background:none}
input,textarea,select{font-family:'Outfit',sans-serif;outline:none}

/* ── ONBOARDING ─────────────────────────────────── */
#onboarding{
  position:fixed;inset:0;z-index:1000;
  background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:32px 24px;
  animation:fadeIn .4s ease;
}
.ob-logo{
  font-family:'Cormorant Garamond',serif;
  font-size:13px;font-weight:400;letter-spacing:5px;
  color:var(--gold);text-transform:uppercase;margin-bottom:48px;
  opacity:.7;
}
.ob-step{width:100%;max-width:360px;display:none;animation:slideUp .35s ease}
.ob-step.active{display:flex;flex-direction:column;align-items:center}
.ob-title{
  font-family:'Cormorant Garamond',serif;
  font-size:32px;font-weight:600;color:var(--cream);
  text-align:center;line-height:1.2;margin-bottom:8px;
}
.ob-sub{font-size:14px;color:var(--text2);text-align:center;margin-bottom:32px;line-height:1.6}
.ob-icon{font-size:48px;margin-bottom:20px}
.ob-input{
  width:100%;padding:14px 18px;
  background:var(--bg3);border:1.5px solid var(--border2);
  border-radius:var(--r3);color:var(--cream);font-size:16px;
  margin-bottom:12px;transition:border-color .2s;
}
.ob-input:focus{border-color:var(--gold)}
.ob-input::placeholder{color:var(--text3)}
.ob-btn{
  width:100%;padding:16px;
  background:var(--gold);color:var(--bg);
  border-radius:var(--r3);font-size:15px;font-weight:600;
  margin-top:8px;transition:all .2s;letter-spacing:.3px;
}
.ob-btn:hover{background:var(--gold2)}
.ob-btn-skip{
  padding:12px;color:var(--text3);font-size:13px;
  margin-top:8px;background:none;border:none;
}
.ob-dots{display:flex;gap:6px;margin-bottom:32px}
.ob-dot{width:6px;height:6px;border-radius:50%;background:var(--border2);transition:all .3s}
.ob-dot.active{width:20px;background:var(--gold);border-radius:3px}

/* ── APP SHELL ──────────────────────────────────── */
#app{display:none;flex-direction:column;min-height:100vh}
#app.visible{display:flex}

/* ── TOP BAR ────────────────────────────────────── */
.topbar{
  position:sticky;top:0;z-index:100;
  background:var(--bg);
  border-bottom:1px solid var(--border);
  padding:0 20px;height:56px;
  display:flex;align-items:center;justify-content:space-between;
}
.topbar-logo{
  font-family:'Cormorant Garamond',serif;
  font-size:20px;font-weight:600;color:var(--gold);
  letter-spacing:.5px;
}
.topbar-user{
  font-size:12px;color:var(--text2);
  font-family:'DM Mono',monospace;letter-spacing:.5px;
}
.topbar-year{
  font-family:'DM Mono',monospace;
  font-size:10px;color:var(--gold3);
  letter-spacing:2px;
}

/* ── YEAR PROGRESS BANNER ───────────────────────── */
.year-banner{
  background:var(--bg2);border-bottom:1px solid var(--border);
  padding:10px 20px;
  display:flex;align-items:center;gap:12px;
}
.year-pct-label{
  font-family:'DM Mono',monospace;
  font-size:11px;color:var(--gold);letter-spacing:1px;white-space:nowrap;
}
.year-bar-wrap{flex:1;height:4px;background:var(--border);border-radius:2px;overflow:hidden}
.year-bar-fill{height:100%;background:linear-gradient(90deg,var(--gold3),var(--gold));border-radius:2px;transition:width 1s ease}
.year-days{font-size:11px;color:var(--text3);white-space:nowrap;font-family:'DM Mono',monospace}

/* ── NAV TABS ───────────────────────────────────── */
.nav-wrap{
  position:sticky;top:56px;z-index:99;
  background:var(--bg);border-bottom:1px solid var(--border);
  overflow-x:auto;scrollbar-width:none;
}
.nav-wrap::-webkit-scrollbar{display:none}
.nav-tabs{display:flex;padding:0 12px;gap:2px;min-width:max-content}
.nav-tab{
  padding:12px 16px;
  font-size:12px;font-weight:500;color:var(--text3);
  border-bottom:2px solid transparent;
  transition:all .2s;white-space:nowrap;
  display:flex;align-items:center;gap:5px;
}
.nav-tab.active{color:var(--gold);border-bottom-color:var(--gold)}
.nav-tab:hover:not(.active){color:var(--text2)}
.nav-icon{font-size:14px}

/* ── CONTENT ────────────────────────────────────── */
.content{flex:1;overflow-y:auto}
.page{display:none;padding:20px 20px 100px;animation:fadeIn .25s ease}
.page.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

/* ── SECTION HEADERS ────────────────────────────── */
.sec-eyebrow{
  font-family:'DM Mono',monospace;font-size:9px;
  color:var(--gold3);letter-spacing:3px;text-transform:uppercase;
  margin-bottom:6px;
}
.sec-title{
  font-family:'Cormorant Garamond',serif;
  font-size:28px;font-weight:600;color:var(--cream);
  line-height:1.15;margin-bottom:4px;
}
.sec-sub{font-size:13px;color:var(--text2);margin-bottom:24px;line-height:1.5}
.page-header{margin-bottom:24px}

/* ── CARDS ──────────────────────────────────────── */
.card{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--r);padding:18px;margin-bottom:16px;
}
.card-title{
  font-size:13px;font-weight:600;color:var(--cream);
  margin-bottom:14px;display:flex;align-items:center;gap:8px;
}
.card-title-icon{font-size:16px}

/* ── KPI GRID ───────────────────────────────────── */
.kpi-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.kpi{
  background:var(--bg3);border:1px solid var(--border);
  border-radius:var(--r2);padding:14px;
  position:relative;overflow:hidden;
}
.kpi::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
}
.kpi-g::before{background:var(--gold)}
.kpi-gr::before{background:var(--green)}
.kpi-r::before{background:var(--red)}
.kpi-b::before{background:var(--blue)}
.kpi-label{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px}
.kpi-val{font-family:'Cormorant Garamond',serif;font-size:30px;font-weight:700;color:var(--cream);line-height:1}
.kpi-sub{font-size:10px;color:var(--text3);margin-top:3px}

/* ── FORMS ──────────────────────────────────────── */
.form-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1.5px;display:block;margin-bottom:5px}
.inp{
  width:100%;padding:11px 14px;
  background:var(--bg3);border:1.5px solid var(--border);
  border-radius:var(--r3);color:var(--cream);font-size:14px;
  transition:border-color .2s;margin-bottom:10px;
}
.inp:focus{border-color:var(--gold)}
.inp::placeholder{color:var(--text3)}
.inp-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
textarea.inp{resize:vertical;min-height:80px;line-height:1.5}
select.inp{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%235a5040' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center}

.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:6px;
  padding:12px 20px;border-radius:var(--r3);
  font-size:13px;font-weight:600;transition:all .2s;letter-spacing:.2px;
}
.btn-gold{background:var(--gold);color:var(--bg);width:100%}
.btn-gold:hover{background:var(--gold2)}
.btn-outline{background:transparent;color:var(--text2);border:1.5px solid var(--border2);width:100%}
.btn-outline:hover{border-color:var(--gold);color:var(--gold)}
.btn-danger{background:var(--red2);color:var(--red);border:1.5px solid #f0c8bd}
.btn-sm{padding:7px 12px;font-size:11px;border-radius:6px}

/* ── ITEMS ──────────────────────────────────────── */
.item-list{list-style:none}
.item{
  display:flex;align-items:flex-start;gap:12px;
  padding:12px 0;border-bottom:1px solid var(--border);
  animation:fadeIn .2s ease;
}
.item:last-child{border-bottom:none}
.check{
  width:22px;height:22px;flex-shrink:0;
  border:2px solid var(--border2);border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:11px;color:transparent;cursor:pointer;
  transition:all .2s;margin-top:1px;
}
.check:hover{border-color:var(--gold)}
.check.done{background:var(--green);border-color:var(--green);color:#fff}
.item-body{flex:1;min-width:0}
.item-title{font-size:14px;font-weight:500;color:var(--cream)}
.item-title.done{text-decoration:line-through;color:var(--text3)}
.item-meta{font-size:11px;color:var(--text3);margin-top:3px}
.del-btn{background:none;border:none;font-size:14px;color:var(--text3);padding:4px;border-radius:4px;opacity:0.5}
.del-btn:hover{opacity:1;color:var(--red)}

/* ── PROGRESS ───────────────────────────────────── */
.prog-wrap{margin-top:8px}
.prog-bar{height:5px;background:var(--border);border-radius:3px;overflow:hidden}
.prog-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--gold3),var(--gold));transition:width .5s ease}
.prog-fill.green{background:linear-gradient(90deg,#3a7a4c,var(--green))}
.prog-fill.red{background:linear-gradient(90deg,#8a3a2c,var(--red))}
.prog-pct{font-family:'DM Mono',monospace;font-size:10px;color:var(--gold);margin-top:4px}

/* ── CHIPS ──────────────────────────────────────── */
.chip{
  display:inline-block;padding:3px 10px;border-radius:20px;
  font-size:10px;font-weight:500;letter-spacing:.3px;
}
.chip-gold{background:#2a2010;color:var(--gold);border:1px solid var(--gold3)}
.chip-green{background:#122018;color:#6abf82;border:1px solid #2a4a32}
.chip-red{background:#201210;color:#e87060;border:1px solid #4a2018}
.chip-blue{background:#101828;color:#70a0e0;border:1px solid #1a3050}
.chip-gray{background:var(--bg3);color:var(--text3);border:1px solid var(--border)}

/* ── DIVIDER ────────────────────────────────────── */
.divider{
  display:flex;align-items:center;gap:10px;
  margin:20px 0 16px;
}
.divider span{font-size:11px;font-weight:600;color:var(--text3);white-space:nowrap;text-transform:uppercase;letter-spacing:1px}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border)}

/* ── HABIT TRACKER ──────────────────────────────── */
.habit-row{
  background:var(--bg3);border:1px solid var(--border);
  border-radius:var(--r2);padding:14px;margin-bottom:10px;
}
.habit-top{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.habit-emoji{font-size:22px;flex-shrink:0}
.habit-info{flex:1;min-width:0}
.habit-name{font-size:14px;font-weight:500;color:var(--cream)}
.habit-streak{font-size:11px;color:var(--gold3);font-family:'DM Mono',monospace;margin-top:2px}
.habit-days{display:flex;gap:5px}
.hday{
  flex:1;height:32px;border-radius:5px;
  border:1.5px solid var(--border2);
  font-size:9px;font-weight:600;color:var(--text3);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.3px;
}
.hday.done{background:var(--green);border-color:var(--green);color:#fff}
.hday.today{border-color:var(--gold);color:var(--gold)}
.hday:hover{border-color:var(--gold3)}

/* ── META CARD ──────────────────────────────────── */
.meta-card{
  background:var(--bg3);border:1px solid var(--border);
  border-radius:var(--r2);padding:16px;margin-bottom:12px;
}
.meta-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:8px}
.meta-name{font-size:15px;font-weight:600;color:var(--cream)}
.meta-pct-big{
  font-family:'Cormorant Garamond',serif;
  font-size:24px;font-weight:700;color:var(--gold);flex-shrink:0;
}
.meta-area{font-size:11px;color:var(--text3);margin-top:2px}
.meta-slider{width:100%;margin-top:10px;accent-color:var(--gold)}

/* ── CALENDARIO ─────────────────────────────────── */
.cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.cal-month{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:600;color:var(--cream)}
.cal-arrow{
  width:32px;height:32px;background:var(--bg3);border:1px solid var(--border);
  border-radius:8px;color:var(--text2);font-size:14px;
  display:flex;align-items:center;justify-content:center;
}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px}
.cal-dow{text-align:center;font-size:9px;font-weight:600;color:var(--text3);letter-spacing:1px;padding:6px 0;text-transform:uppercase}
.cal-day{
  aspect-ratio:1;display:flex;align-items:center;justify-content:center;
  border-radius:6px;font-size:12px;cursor:pointer;
  transition:all .15s;position:relative;
  border:1px solid transparent;color:var(--text2);
}
.cal-day:hover{background:var(--bg3);border-color:var(--border)}
.cal-day.today{background:var(--gold);color:var(--bg);font-weight:700}
.cal-day.has-ev::after{content:'';position:absolute;bottom:2px;width:4px;height:4px;border-radius:50%;background:var(--gold3)}
.cal-day.today.has-ev::after{background:var(--bg)}
.cal-day.other{color:var(--text3);opacity:.4}

/* ── VIAJES ─────────────────────────────────────── */
.viaje-card{
  background:var(--bg3);border:1px solid var(--border);
  border-radius:var(--r);padding:16px;margin-bottom:14px;
  position:relative;overflow:hidden;
}
.viaje-card::before{
  content:'';position:absolute;top:0;left:0;bottom:0;width:3px;
  background:var(--gold);
}
.viaje-dest{font-size:18px;font-weight:600;color:var(--cream);margin-bottom:4px}
.viaje-dates{font-family:'DM Mono',monospace;font-size:11px;color:var(--gold3);margin-bottom:10px}
.viaje-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}
.viaje-stat{background:var(--bg4);border-radius:8px;padding:10px;text-align:center}
.viaje-stat-val{font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:700;color:var(--cream)}
.viaje-stat-label{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-top:2px}

/* ── PRESUPUESTO ────────────────────────────────── */
.budget-summary{
  background:var(--bg3);border:1px solid var(--border);
  border-radius:var(--r);padding:18px;margin-bottom:16px;
}
.budget-main{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:12px}
.budget-ing{font-family:'Cormorant Garamond',serif;font-size:32px;font-weight:700;color:var(--green);line-height:1}
.budget-gas{font-family:'Cormorant Garamond',serif;font-size:32px;font-weight:700;color:var(--red);line-height:1}
.budget-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px}
.budget-ahorro{text-align:center;padding:10px;background:var(--bg4);border-radius:8px;margin-top:8px}
.budget-ahorro-val{font-family:'Cormorant Garamond',serif;font-size:24px;font-weight:700}
.budget-ahorro-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px}
.tx-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)}
.tx-row:last-child{border-bottom:none}
.tx-icon{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.tx-body{flex:1;min-width:0}
.tx-desc{font-size:13px;font-weight:500;color:var(--cream)}
.tx-cat{font-size:10px;color:var(--text3);margin-top:1px}
.tx-amount{font-family:'DM Mono',monospace;font-size:14px;font-weight:500}
.tx-pos{color:#6abf82}
.tx-neg{color:#e87060}

/* ── RUTINA ─────────────────────────────────────── */
.rutina-slot{
  display:flex;align-items:center;gap:12px;
  padding:12px 14px;background:var(--bg3);
  border:1px solid var(--border);border-radius:var(--r2);
  margin-bottom:8px;cursor:pointer;transition:all .2s;
}
.rutina-slot.done{border-color:var(--green);background:#0e1f14}
.rutina-slot:hover{border-color:var(--border2)}
.rutina-time{font-family:'DM Mono',monospace;font-size:11px;color:var(--gold3);flex-shrink:0;width:40px}
.rutina-emoji{font-size:18px;flex-shrink:0}
.rutina-name{font-size:13px;font-weight:500;color:var(--cream);flex:1}
.rutina-check{width:20px;height:20px;border:2px solid var(--border2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;color:transparent;flex-shrink:0}
.rutina-slot.done .rutina-check{background:var(--green);border-color:var(--green);color:#fff}

/* ── WISHLIST ───────────────────────────────────── */
.wish-card{
  background:var(--bg3);border:1px solid var(--border);
  border-radius:var(--r2);padding:14px;margin-bottom:10px;
  display:flex;align-items:center;gap:12px;
}
.wish-emoji{font-size:24px;flex-shrink:0}
.wish-body{flex:1;min-width:0}
.wish-name{font-size:14px;font-weight:500;color:var(--cream)}
.wish-price{font-family:'DM Mono',monospace;font-size:12px;color:var(--gold3);margin-top:2px}
.wish-cat{font-size:10px;color:var(--text3);margin-top:2px}
.wish-check{
  width:28px;height:28px;border-radius:50%;
  border:2px solid var(--border2);
  display:flex;align-items:center;justify-content:center;
  font-size:13px;color:transparent;cursor:pointer;flex-shrink:0;
  transition:all .2s;
}
.wish-check.done{background:var(--gold);border-color:var(--gold);color:var(--bg)}

/* ── DIARIO ─────────────────────────────────────── */
.note-card{
  background:var(--bg3);border:1px solid var(--border);
  border-radius:var(--r2);padding:14px;margin-bottom:12px;
}
.note-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.note-date{font-family:'DM Mono',monospace;font-size:10px;color:var(--gold3)}
.note-mood{font-size:16px}
.note-text{font-size:13px;color:var(--text);line-height:1.65;white-space:pre-wrap}

/* ── TABS INTERNAS ──────────────────────────────── */
.inner-tabs{display:flex;gap:4px;margin-bottom:18px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:4px}
.inner-tab{flex:1;padding:8px 4px;text-align:center;font-size:11px;font-weight:500;color:var(--text3);border-radius:6px;cursor:pointer;transition:all .2s}
.inner-tab.active{background:var(--gold);color:var(--bg)}

/* ── EMPTY STATE ────────────────────────────────── */
.empty{text-align:center;padding:40px 20px;color:var(--text3)}
.empty-icon{font-size:36px;margin-bottom:10px;opacity:.5}
.empty-text{font-size:13px;line-height:1.6}

/* ── TOAST ──────────────────────────────────────── */
.toast{
  position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);
  background:var(--bg4);color:var(--gold2);
  padding:10px 20px;border-radius:20px;
  font-size:13px;font-weight:500;
  box-shadow:0 4px 24px rgba(0,0,0,.5);
  opacity:0;transition:all .3s;z-index:2000;
  border:1px solid var(--border2);white-space:nowrap;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* ── BOTTOM NAV ─────────────────────────────────── */
.bottom-nav{
  position:fixed;bottom:0;left:0;right:0;z-index:100;
  background:var(--bg2);border-top:1px solid var(--border);
  display:flex;justify-content:space-around;padding:8px 0 max(8px,env(safe-area-inset-bottom));
}
.bnav-item{
  display:flex;flex-direction:column;align-items:center;gap:3px;
  padding:4px 12px;flex:1;cursor:pointer;
  color:var(--text3);transition:color .2s;
}
.bnav-item.active{color:var(--gold)}
.bnav-icon{font-size:20px}
.bnav-label{font-size:9px;font-weight:500;letter-spacing:.5px;text-transform:uppercase}

/* ── POMODORO ────────────────────────────────────── */
.pomo-ring-wrap{display:flex;flex-direction:column;align-items:center;padding:24px 0 16px}
.pomo-ring{position:relative;width:200px;height:200px}
.pomo-svg{transform:rotate(-90deg)}
.pomo-track{fill:none;stroke:var(--border);stroke-width:10}
.pomo-fill{fill:none;stroke-width:10;stroke-linecap:round;transition:stroke-dashoffset .5s linear;stroke:var(--gold)}
.pomo-fill.break{stroke:var(--green)}
.pomo-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.pomo-time{font-family:'DM Mono',monospace;font-size:38px;font-weight:500;color:var(--cream);letter-spacing:2px;line-height:1}
.pomo-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:2px;margin-top:4px}
.pomo-controls{display:flex;gap:12px;margin-top:16px}
.pomo-btn{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;transition:all .2s}
.pomo-btn-main{background:var(--gold);color:var(--bg)}
.pomo-btn-main:hover{background:var(--gold2)}
.pomo-btn-sec{background:var(--bg3);border:1px solid var(--border2);color:var(--text2)}
.pomo-btn-sec:hover{border-color:var(--gold);color:var(--gold)}
.pomo-mode-row{display:flex;gap:8px;margin-bottom:16px;justify-content:center}
.pomo-mode{padding:7px 16px;border-radius:20px;font-size:11px;font-weight:500;cursor:pointer;transition:all .2s;border:1.5px solid var(--border2);color:var(--text3)}
.pomo-mode.active{background:var(--gold);color:var(--bg);border-color:var(--gold)}
.pomo-sessions{display:flex;gap:6px;margin-top:14px;justify-content:center}
.pomo-dot{width:10px;height:10px;border-radius:50%;background:var(--border2);transition:background .3s}
.pomo-dot.done{background:var(--gold)}
.pomo-stat-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:16px}
.pomo-stat{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r2);padding:12px;text-align:center}
.pomo-stat-val{font-family:'DM Mono',monospace;font-size:20px;font-weight:500;color:var(--gold)}
.pomo-stat-lbl{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-top:3px}
/* ── ESTADÍSTICAS ────────────────────────────────── */
.stat-bar-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.stat-bar-label{font-size:12px;color:var(--text);min-width:110px;flex-shrink:0}
.stat-bar-wrap{flex:1;height:8px;background:var(--border);border-radius:4px;overflow:hidden}
.stat-bar-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--gold3),var(--gold));transition:width .8s ease}
.stat-bar-fill.green{background:linear-gradient(90deg,#3a7a4c,var(--green))}
.stat-bar-pct{font-family:'DM Mono',monospace;font-size:11px;color:var(--gold3);min-width:34px;text-align:right}
.stat-big-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}
.stat-big{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r2);padding:14px;text-align:center}
.stat-big-val{font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:700;color:var(--cream);line-height:1}
.stat-big-lbl{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-top:3px}
.mini-chart{display:flex;align-items:flex-end;gap:3px;height:48px;margin-top:10px}
.mini-bar{flex:1;border-radius:2px 2px 0 0;background:var(--gold3);transition:height .5s ease;min-height:2px;opacity:.7}
.mini-bar.active{background:var(--gold);opacity:1}
/* ── NOTAS RÁPIDAS ───────────────────────────────── */
.qnote-fab{
  position:fixed;bottom:80px;right:20px;z-index:200;
  width:52px;height:52px;border-radius:50%;
  background:var(--gold);color:var(--bg);
  font-size:22px;display:flex;align-items:center;justify-content:center;
  box-shadow:0 4px 20px rgba(201,168,76,.4);transition:all .2s;
}
.qnote-fab:hover{background:var(--gold2);transform:scale(1.05)}
.qnote-panel{
  position:fixed;inset:0;z-index:500;
  background:rgba(0,0,0,.7);backdrop-filter:blur(4px);
  display:flex;align-items:flex-end;
  opacity:0;pointer-events:none;transition:opacity .25s;
}
.qnote-panel.open{opacity:1;pointer-events:all}
.qnote-sheet{
  width:100%;background:var(--bg2);
  border-radius:20px 20px 0 0;border-top:1px solid var(--border2);
  padding:20px 20px 40px;
  transform:translateY(100%);transition:transform .3s ease;
}
.qnote-panel.open .qnote-sheet{transform:translateY(0)}
.qnote-handle{width:36px;height:4px;background:var(--border2);border-radius:2px;margin:0 auto 16px}
.qnote-title{font-family:'Cormorant Garamond',serif;font-size:20px;color:var(--cream);margin-bottom:14px}
.qnote-list{max-height:220px;overflow-y:auto;margin-bottom:12px}
.qnote-item{display:flex;align-items:flex-start;gap:10px;padding:9px 0;border-bottom:1px solid var(--border)}
.qnote-item:last-child{border:none}
.qnote-dot{width:6px;height:6px;border-radius:50%;background:var(--gold);flex-shrink:0;margin-top:6px}
.qnote-text{font-size:13px;color:var(--text);flex:1;line-height:1.5}
.qnote-time{font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);white-space:nowrap}
/* ── REVIEW MENSUAL ──────────────────────────────── */
.review-area-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)}
.review-area-row:last-child{border:none}
.review-area-name{font-size:13px;color:var(--text);flex:1}
.review-area-score{display:flex;gap:4px}
.rev-pip{width:20px;height:20px;border-radius:5px;border:1.5px solid var(--border2);cursor:pointer;transition:all .15s}
.rev-pip.active{background:var(--gold);border-color:var(--gold)}
.review-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r2);padding:14px;margin-bottom:10px}
.review-card-month{font-family:'DM Mono',monospace;font-size:10px;color:var(--gold3);margin-bottom:6px}
.review-card-pip{width:12px;height:12px;border-radius:3px;background:var(--border);display:inline-block;margin-right:2px}
.review-card-pip.active{background:var(--gold)}
/* ── RESPONSIVE HELPERS ─────────────────────────── */
@media(max-width:380px){
  .sec-title{font-size:24px}
  .kpi-val{font-size:26px}
}
</style>
<style id="css-finanzas">
  #mod-finanzas {
    --bg: #0d0f14; --bg2: #13161e; --bg3: #1a1e2a;
    --card: #1e2330; --border: rgba(255,255,255,0.07); --border2: rgba(255,255,255,0.12);
    --green: #4ade80; --green2: #22c55e; --green-dim: rgba(74,222,128,0.12);
    --red: #f87171; --red-dim: rgba(248,113,113,0.12);
    --amber: #fbbf24; --amber-dim: rgba(251,191,36,0.12);
    --blue: #60a5fa; --blue-dim: rgba(96,165,250,0.1);
    --purple: #a78bfa; --purple-dim: rgba(167,139,250,0.12);
    --text: #f0f2f8; --text2: #9ba3b8; --text3: #5a6278;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; overflow-x:hidden; }

  /* ONBOARDING */
  .onboarding {
    position:fixed; inset:0; background:var(--bg); z-index:9999;
    display:flex; align-items:center; justify-content:center;
    overflow-y:auto; padding:20px;
  }
  .onboarding.hidden { display:none !important; }
  .ob-card {
    width:480px; max-width:100%; background:var(--card);
    border:1px solid var(--border2); border-radius:24px; padding:36px;
    animation:modalIn .3s ease;
  }
  .ob-step-content { display:none; }
  .ob-step-content.active { display:block; }
  @keyframes modalIn { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
  .ob-dots { display:flex; gap:6px; margin-bottom:24px; }
  .ob-dot { height:6px; border-radius:99px; background:var(--bg3); transition:all .3s; flex:1; }
  .ob-dot.active { background:var(--green); }
  .ob-dot.done { background:rgba(74,222,128,0.4); }
  .ob-step-label { font-size:.68rem; letter-spacing:.1em; text-transform:uppercase; color:var(--text3); font-weight:600; margin-bottom:6px; }
  .ob-title { font-family:'Playfair Display',serif; font-size:1.7rem; font-weight:700; letter-spacing:-.02em; line-height:1.15; margin-bottom:8px; }
  .ob-desc { font-size:.85rem; color:var(--text2); line-height:1.5; margin-bottom:24px; }
  .ob-nav { display:flex; justify-content:space-between; align-items:center; margin-top:20px; gap:10px; }
  .ob-toggle-wrap { display:flex; gap:12px; }
  .ob-toggle {
    flex:1; padding:18px 12px; border:1px solid var(--border); border-radius:14px;
    cursor:pointer; text-align:center; transition:all .15s; background:var(--bg3);
    font-size:.88rem; font-weight:500; color:var(--text2);
  }
  .ob-toggle:hover { border-color:var(--border2); color:var(--text); }
  .ob-toggle.selected { border-color:var(--green); background:var(--green-dim); color:var(--green); }
  .ob-toggle .tog-icon { font-size:1.6rem; display:block; margin-bottom:8px; }
  .ob-sub-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
  .ob-sub-item {
    padding:14px 8px; border:1px solid var(--border); border-radius:12px;
    background:var(--bg3); cursor:pointer; text-align:center; transition:all .15s;
  }
  .ob-sub-item:hover { border-color:var(--border2); }
  .ob-sub-item.selected { border-color:var(--green); background:var(--green-dim); }
  .ob-sub-icon { font-size:1.3rem; }
  .ob-sub-name { font-size:.75rem; font-weight:500; margin-top:4px; color:var(--text); }
  .ob-goal-item {
    display:flex; align-items:center; gap:12px; padding:14px 16px;
    border:1px solid var(--border); border-radius:12px; cursor:pointer;
    transition:all .15s; background:var(--bg3); margin-bottom:8px;
  }
  .ob-goal-item:hover { border-color:var(--border2); }
  .ob-goal-item.selected { border-color:var(--green); background:var(--green-dim); }
  .ob-goal-icon { font-size:1.2rem; }
  .ob-goal-label { font-size:.88rem; font-weight:500; }

  /* APP LAYOUT */
  .app { display:flex; min-height:100vh; }
  .sidebar {
    width:240px; background:var(--bg2); border-right:1px solid var(--border);
    display:flex; flex-direction:column; position:fixed; top:0; left:0; bottom:0; z-index:100;
  }
  .sidebar-brand { padding:26px 22px 18px; border-bottom:1px solid var(--border); }
  .brand-name { font-family:'Playfair Display',serif; font-size:1.25rem; font-weight:700; letter-spacing:-.02em; }
  .brand-currency { font-size:.7rem; color:var(--text3); letter-spacing:.06em; text-transform:uppercase; margin-top:2px; }
  .sidebar-nav { padding:14px 10px; flex:1; overflow-y:auto; }
  .nav-section { font-size:.63rem; letter-spacing:.12em; text-transform:uppercase; color:var(--text3); padding:8px 12px 5px; font-weight:600; }
  .nav-item {
    display:flex; align-items:center; gap:10px; padding:10px 12px;
    border-radius:10px; cursor:pointer; transition:all .2s; font-size:.865rem;
    color:var(--text2); font-weight:400; margin-bottom:2px; border:1px solid transparent;
  }
  .nav-item:hover { background:var(--bg3); color:var(--text); }
  .nav-item.active { background:var(--green-dim); color:var(--green); border-color:rgba(74,222,128,.2); font-weight:500; }
  .nav-icon { font-size:1rem; width:20px; text-align:center; }
  .sidebar-bottom { padding:14px 10px; border-top:1px solid var(--border); }
  .month-nav {
    display:flex; align-items:center; justify-content:space-between;
    background:var(--bg3); border-radius:10px; padding:8px 12px;
  }
  .month-name { font-size:.85rem; font-weight:500; }
  .month-btn { background:none; border:none; color:var(--text3); cursor:pointer; font-size:1rem; padding:2px 6px; }
  .month-btn:hover { color:var(--text); }

  /* MAIN */
  .main { margin-left:240px; flex:1; padding:28px 32px; max-width:calc(100vw - 240px); }
  .page { display:none; }
  .page.active { display:block; }
  .page-header { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:28px; flex-wrap:wrap; gap:12px; }
  .page-title { font-family:'Playfair Display',serif; font-size:1.85rem; font-weight:700; letter-spacing:-.03em; line-height:1.1; }
  .page-subtitle { font-size:.82rem; color:var(--text2); margin-top:4px; }

  /* BUTTONS */
  .btn { display:inline-flex; align-items:center; gap:7px; padding:10px 18px; border-radius:10px; font-size:.85rem; font-weight:500; cursor:pointer; border:none; transition:all .2s; font-family:'DM Sans',sans-serif; }
  .btn-primary { background:var(--green); color:#0d0f14; }
  .btn-primary:hover { background:var(--green2); transform:translateY(-1px); }
  .btn-ghost { background:var(--bg3); color:var(--text2); border:1px solid var(--border2); }
  .btn-ghost:hover { color:var(--text); }
  .btn-sm { padding:6px 12px; font-size:.78rem; }
  .btn-danger { background:var(--red-dim); color:var(--red); border:1px solid rgba(248,113,113,.2); }

  /* CARDS */
  .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:22px; }
  .grid-4 { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:20px; }
  .grid-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:14px; margin-bottom:20px; }
  .grid-2 { display:grid; grid-template-columns:repeat(2,1fr); gap:14px; margin-bottom:20px; }
  .grid-21 { display:grid; grid-template-columns:2fr 1fr; gap:14px; margin-bottom:20px; }

  /* STAT CARDS */
  .stat-label { font-size:.68rem; letter-spacing:.08em; text-transform:uppercase; color:var(--text3); font-weight:600; margin-bottom:8px; }
  .stat-amount { font-family:'DM Mono',monospace; font-size:1.55rem; font-weight:500; letter-spacing:-.02em; line-height:1; }
  .stat-sub { font-size:.72rem; color:var(--text3); margin-top:6px; }
  .stat-icon { position:absolute; top:18px; right:18px; font-size:1.3rem; opacity:.18; }

  /* SEMAFORO */
  .semaforo { display:flex; align-items:center; gap:8px; padding:11px 16px; border-radius:10px; font-size:.83rem; font-weight:500; margin-bottom:20px; }
  .sem-green { background:var(--green-dim); color:var(--green); border:1px solid rgba(74,222,128,.2); }
  .sem-amber { background:var(--amber-dim); color:var(--amber); border:1px solid rgba(251,191,36,.2); }
  .sem-red { background:var(--red-dim); color:var(--red); border:1px solid rgba(248,113,113,.2); }

  /* SCORE */
  .score-wrap { display:flex; align-items:center; gap:18px; padding:18px; background:var(--bg3); border-radius:12px; margin-bottom:20px; }
  .score-ring-box { position:relative; width:76px; height:76px; flex-shrink:0; }
  .score-ring { width:76px; height:76px; transform:rotate(-90deg); }
  .ring-bg { fill:none; stroke:var(--bg2); stroke-width:7; }
  .ring-fill { fill:none; stroke-width:7; stroke-linecap:round; transition:stroke-dashoffset 1s ease; }
  .score-num { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-family:'DM Mono',monospace; font-size:1.05rem; font-weight:500; }
  .score-info { flex:1; }
  .score-title { font-size:.9rem; font-weight:600; margin-bottom:3px; }
  .score-desc { font-size:.77rem; color:var(--text2); line-height:1.4; }

  /* TX */
  .tx-item { display:flex; align-items:center; gap:12px; padding:11px 0; border-bottom:1px solid var(--border); transition:padding .15s; }
  .tx-item:last-child { border-bottom:none; }
  .tx-item:hover { padding-left:4px; }
  .tx-icon { width:36px; height:36px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:.95rem; flex-shrink:0; }
  .tx-info { flex:1; min-width:0; }
  .tx-name { font-size:.85rem; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .tx-meta { font-size:.7rem; color:var(--text3); margin-top:1px; }
  .tx-amount { font-family:'DM Mono',monospace; font-size:.88rem; font-weight:500; white-space:nowrap; }
  .tx-del { width:24px; height:24px; border-radius:6px; background:var(--red-dim); color:var(--red); border:none; cursor:pointer; font-size:.7rem; display:flex; align-items:center; justify-content:center; opacity:0; transition:opacity .15s; }
  .tx-item:hover .tx-del { opacity:1; }

  /* DONUT */
  .donut-wrap { position:relative; width:130px; height:130px; margin:0 auto 14px; }
  .donut-svg { width:130px; height:130px; transform:rotate(-90deg); }
  .donut-center { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; }
  .donut-val { font-family:'DM Mono',monospace; font-size:.95rem; font-weight:500; }
  .donut-lbl { font-size:.6rem; color:var(--text3); text-transform:uppercase; letter-spacing:.06em; }
  .legend-item { display:flex; align-items:center; gap:7px; margin-bottom:6px; }
  .legend-dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
  .legend-name { font-size:.77rem; color:var(--text2); flex:1; }
  .legend-pct { font-size:.75rem; font-family:'DM Mono',monospace; }

  /* STREAK */
  .streak-days { display:flex; gap:5px; flex-wrap:wrap; margin-top:8px; }
  .s-day { width:30px; height:30px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:.62rem; font-weight:600; }
  .s-done { background:var(--green-dim); color:var(--green); border:1px solid rgba(74,222,128,.3); }
  .s-today { background:var(--green); color:#0d0f14; }
  .s-miss { background:var(--bg3); color:var(--text3); border:1px solid var(--border); }

  /* ALERTS */
  .alert-item { display:flex; gap:10px; padding:11px 14px; border-radius:10px; margin-bottom:7px; font-size:.8rem; line-height:1.4; }
  .al-green { background:var(--green-dim); border:1px solid rgba(74,222,128,.15); color:var(--green); }
  .al-amber { background:var(--amber-dim); border:1px solid rgba(251,191,36,.15); color:var(--amber); }
  .al-red { background:var(--red-dim); border:1px solid rgba(248,113,113,.15); color:var(--red); }
  .al-blue { background:var(--blue-dim); border:1px solid rgba(96,165,250,.15); color:var(--blue); }
  .al-purple { background:var(--purple-dim); border:1px solid rgba(167,139,250,.15); color:var(--purple); }

  /* PROGRESS */
  .prog-bar { height:6px; background:var(--bg3); border-radius:99px; overflow:hidden; margin-top:6px; }
  .prog-fill { height:100%; border-radius:99px; transition:width .8s ease; }

  /* TABS */
  .tabs { display:flex; gap:3px; background:var(--bg3); padding:4px; border-radius:11px; width:fit-content; margin-bottom:18px; }
  .tab { padding:7px 14px; border-radius:8px; font-size:.8rem; font-weight:500; cursor:pointer; color:var(--text2); border:none; background:none; font-family:'DM Sans',sans-serif; transition:all .15s; }
  .tab.active { background:var(--card); color:var(--text); box-shadow:0 1px 4px rgba(0,0,0,.3); }

  /* MODAL */
  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:1000; align-items:center; justify-content:center; backdrop-filter:blur(4px); overflow-y:auto; padding:20px; }
  .modal-overlay.open { display:flex; }
  .modal { background:var(--card); border:1px solid var(--border2); border-radius:20px; padding:26px; width:440px; max-width:100%; animation:modalIn .25s ease; margin:auto; }
  .modal-title { font-family:'Playfair Display',serif; font-size:1.25rem; font-weight:700; margin-bottom:18px; }
  .form-group { margin-bottom:14px; }
  .form-label { font-size:.72rem; text-transform:uppercase; letter-spacing:.08em; color:var(--text2); font-weight:600; margin-bottom:5px; display:block; }
  .form-input { width:100%; background:var(--bg3); border:1px solid var(--border2); border-radius:10px; padding:10px 13px; color:var(--text); font-family:'DM Sans',sans-serif; font-size:.88rem; outline:none; transition:border-color .2s; }
  .form-input:focus { border-color:var(--green); }
  .form-input option { background:var(--card); }
  .form-row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .form-actions { display:flex; gap:10px; margin-top:18px; }
  .cat-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:7px; }
  .cat-btn { padding:8px 4px; border-radius:10px; border:1px solid var(--border); background:var(--bg3); color:var(--text2); cursor:pointer; font-size:.67rem; text-align:center; transition:all .15s; display:flex; flex-direction:column; align-items:center; gap:3px; font-family:'DM Sans',sans-serif; }
  .cat-btn:hover { border-color:var(--border2); color:var(--text); }
  .cat-btn.selected { border-color:var(--green); background:var(--green-dim); color:var(--green); }
  .cat-btn .ce { font-size:1.05rem; }

  /* SUBS */
  .sub-item { display:flex; align-items:center; gap:12px; padding:13px 0; border-bottom:1px solid var(--border); }
  .sub-item:last-child { border-bottom:none; }
  .sub-logo { width:38px; height:38px; border-radius:10px; background:var(--bg3); display:flex; align-items:center; justify-content:center; font-size:1rem; flex-shrink:0; }
  .sub-info { flex:1; }
  .sub-name { font-size:.86rem; font-weight:500; }
  .sub-meta { font-size:.7rem; color:var(--text3); margin-top:2px; }
  .badge { font-size:.62rem; padding:2px 7px; border-radius:99px; font-weight:600; text-transform:uppercase; letter-spacing:.05em; }
  .b-red { background:var(--red-dim); color:var(--red); }
  .b-amber { background:var(--amber-dim); color:var(--amber); }
  .b-green { background:var(--green-dim); color:var(--green); }

  /* META */
  .meta-item { padding:16px 0; border-bottom:1px solid var(--border); }
  .meta-item:last-child { border-bottom:none; }
  .meta-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px; gap:10px; flex-wrap:wrap; }

  /* CREDIT CARD */
  .cc-card {
    background:linear-gradient(135deg,#1a1e3a,#2d1f4e);
    border:1px solid rgba(167,139,250,.3);
    border-radius:16px; padding:22px;
    position:relative; overflow:hidden; margin-bottom:14px;
  }
  .cc-card::before {
    content:''; position:absolute; top:-30px; right:-30px;
    width:120px; height:120px; border-radius:50%;
    background:rgba(167,139,250,.08);
  }
  .cc-card::after {
    content:''; position:absolute; bottom:-20px; right:40px;
    width:80px; height:80px; border-radius:50%;
    background:rgba(167,139,250,.05);
  }
  .cc-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:18px; }
  .cc-bank { font-size:.75rem; color:rgba(255,255,255,.5); text-transform:uppercase; letter-spacing:.1em; }
  .cc-chip { font-size:1.2rem; }
  .cc-number { font-family:'DM Mono',monospace; font-size:.9rem; letter-spacing:.12em; color:rgba(255,255,255,.7); margin-bottom:14px; }
  .cc-bottom { display:flex; justify-content:space-between; align-items:flex-end; }
  .cc-label { font-size:.6rem; text-transform:uppercase; letter-spacing:.1em; color:rgba(255,255,255,.4); margin-bottom:2px; }
  .cc-value { font-family:'DM Mono',monospace; font-size:.85rem; color:rgba(255,255,255,.85); }
  .cc-limit-bar { margin-top:14px; }
  .cc-limit-info { display:flex; justify-content:space-between; font-size:.72rem; margin-bottom:5px; }

  .vehicle-stat { text-align:center; padding:16px; background:var(--bg3); border-radius:12px; }
  .vehicle-stat-icon { font-size:1.4rem; margin-bottom:5px; }
  .vehicle-stat-val { font-family:'DM Mono',monospace; font-size:1.05rem; font-weight:500; }
  .vehicle-stat-lbl { font-size:.67rem; color:var(--text3); margin-top:2px; text-transform:uppercase; letter-spacing:.06em; }

  .empty-state { text-align:center; padding:36px 20px; color:var(--text3); }
  .empty-icon { font-size:2.2rem; margin-bottom:10px; }
  .empty-text { font-size:.85rem; line-height:1.5; }

  .green { color:var(--green); } .red { color:var(--red); } .amber { color:var(--amber); } .blue { color:var(--blue); } .purple { color:var(--purple); }

  ::-webkit-scrollbar { width:5px; }
  ::-webkit-scrollbar-track { background:transparent; }
  ::-webkit-scrollbar-thumb { background:var(--bg3); border-radius:99px; }

  @media print {
    body > *:not(#informe-print) { display:none !important; }
    #informe-print { display:block !important; }
    .informe-wrap { font-family:'DM Sans',sans-serif; padding:20px; color:#111; }
    .informe-header { border-bottom:3px solid #111; padding-bottom:16px; margin-bottom:24px; }
    .informe-title { font-size:24px; font-weight:700; margin-bottom:4px; }
    .informe-sub { font-size:12px; color:#666; }
    .informe-kpis { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:24px; }
    .informe-kpi { border:1px solid #ddd; border-radius:8px; padding:14px; }
    .informe-kpi-label { font-size:9px; text-transform:uppercase; letter-spacing:.08em; color:#888; margin-bottom:6px; font-weight:600; }
    .informe-kpi-val { font-size:20px; font-weight:700; }
    .informe-kpi-val.g { color:#16a34a; }
    .informe-kpi-val.r { color:#dc2626; }
    .informe-section { margin-bottom:24px; }
    .informe-section-title { font-size:13px; font-weight:700; text-transform:uppercase; letter-spacing:.08em; border-bottom:1px solid #eee; padding-bottom:6px; margin-bottom:12px; color:#333; }
    .informe-table { width:100%; border-collapse:collapse; font-size:11px; }
    .informe-table th { background:#f5f5f5; padding:7px 10px; text-align:left; font-weight:600; font-size:9px; text-transform:uppercase; letter-spacing:.06em; color:#555; }
    .informe-table td { padding:7px 10px; border-bottom:1px solid #f0f0f0; }
    .informe-table tr:last-child td { border-bottom:none; }
    .informe-cat-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
    .informe-cat { display:flex; justify-content:space-between; padding:8px 12px; background:#f9f9f9; border-radius:6px; font-size:11px; }
    .informe-footer { margin-top:32px; border-top:1px solid #eee; padding-top:12px; font-size:9px; color:#aaa; text-align:center; }
    .informe-score { display:inline-block; padding:6px 16px; border-radius:99px; font-size:13px; font-weight:700; margin-top:8px; }
    .informe-score.g { background:#dcfce7; color:#16a34a; }
    .informe-score.a { background:#fef9c3; color:#ca8a04; }
    .informe-score.r { background:#fee2e2; color:#dc2626; }
  }

  @media (max-width:860px) {
    .sidebar { width:60px; }
    .sidebar-brand .brand-name, .sidebar-brand .brand-currency, .nav-section, .nav-item span:not(.nav-icon), .sidebar-bottom .month-name { display:none; }
    .nav-item { justify-content:center; padding:12px; }
    .month-nav { justify-content:center; gap:0; }
    .month-btn { display:block; }
    .main { margin-left:60px; max-width:calc(100vw - 60px); padding:18px 14px; }
    .grid-4 { grid-template-columns:repeat(2,1fr); }
    .grid-3 { grid-template-columns:repeat(2,1fr); }
    .grid-21 { grid-template-columns:1fr; }
  }
  @media (max-width:600px) {
    .grid-4,.grid-3,.grid-2 { grid-template-columns:1fr; }
    .grid-21 { grid-template-columns:1fr; }
    .form-row { grid-template-columns:1fr; }
  }
</style>
</head>
<body>

<!-- ══ AUTH ══ -->
<div id="layer-auth" class="show">
  <div class="auth-box">
    <div class="alogo">El<span>Método</span>Simple</div>
    <div class="atag">Organizá tu tiempo · Tu plata · Tu energía</div>
    <div class="atabs">
      <button class="atab on" onclick="switchTab('login')">Entrar</button>
      <button class="atab" onclick="switchTab('reg')">Registrarme</button>
    </div>
    <div id="f-login">
      <div class="fl"><label>Email</label><input class="fi" type="email" id="l-email" placeholder="tu@email.com" autocomplete="email"></div>
      <div class="fl"><label>Contraseña</label><input class="fi" type="password" id="l-pass" placeholder="••••••••" autocomplete="current-password"></div>
      <button class="bp" onclick="doLogin()">Entrar →</button>
      <div class="adiv">o</div>
      <button class="gbtn" onclick="doLogin()"><svg width="17" height="17" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> Continuar con Google</button>
    </div>
    <div id="f-reg" style="display:none">
      <div class="fl"><label>Nombre</label><input class="fi" type="text" id="r-name" placeholder="Tu nombre" autocomplete="name"></div>
      <div class="fl"><label>Email</label><input class="fi" type="email" id="r-email" placeholder="tu@email.com" autocomplete="email"></div>
      <div class="fl"><label>Contraseña</label><input class="fi" type="password" id="r-pass" placeholder="Mínimo 8 caracteres" autocomplete="new-password"></div>
      <button class="bp" onclick="doRegister()">Crear cuenta →</button>
      <div class="adiv">o</div>
      <button class="gbtn" onclick="doRegister()"><svg width="17" height="17" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> Continuar con Google</button>
    </div>
    <div class="anote">Acceso anual · Pago único · Sin suscripción mensual</div>
  </div>
</div>

<!-- ══ CHOOSE ══ -->
<div id="layer-choose">
  <div class="choose-box">
    <div class="clogo">El<span>Método</span>Simple</div>
    <div class="ctag">Tu ecosistema de organización personal</div>
    <div class="cgreet" id="ch-greet">Hola 👋</div>
    <div class="mods">
      <button class="mod" id="btn-mod-ag" onclick="openModule('agenda')">
        <div class="mico ag">📅</div>
        <div class="minf"><div class="mname">Agenda 2026</div><div class="mdesc">Metas, hábitos, calendario, diario, focus timer y más.</div></div>
        <span class="mbadge ok" id="badge-ag">Activo ✓</span>
      </button>
      <button class="mod" id="btn-mod-fi" onclick="openModule('finanzas')">
        <div class="mico fi">💰</div>
        <div class="minf"><div class="mname">Finanzas</div><div class="mdesc">Gastos, suscripciones, tarjeta, vehículo y metas de ahorro.</div></div>
        <span class="mbadge ok" id="badge-fi">Activo ✓</span>
      </button>
      <button class="mod locked" onclick="showSoon()">
        <div class="mico al">🥗</div>
        <div class="minf"><div class="mname">Alimentación</div><div class="mdesc">Plan semanal con IA, lista de compras y presupuesto.</div></div>
        <span class="mbadge soon">Próximamente</span>
      </button>
    </div>
    <div class="cfoot">
      <div class="cfoot-info">Acceso hasta <strong id="ch-expiry">—</strong></div>
      <button class="blogout" onclick="doLogout()">Cerrar sesión</button>
    </div>
  </div>
</div>

<!-- ══ EXPIRED ══ -->
<div id="layer-expired">
  <div class="exp-box">
    <div class="exp-ico">🔒</div>
    <h2>Tu acceso venció</h2>
    <p>Tu acceso terminó el <span id="exp-date">—</span>. Renovalo para seguir usando tus herramientas.</p>
    <div class="price-b">$19 / año</div><br>
    <button class="bp" style="max-width:260px;margin:0 auto 10px;display:block" onclick="window.open('https://gumroad.com','_blank')">Renovar acceso →</button>
    <button onclick="doLogout()" style="color:var(--mut);font-size:.78rem;background:none;border:none;cursor:pointer;display:block;margin:0 auto;padding:8px">Cerrar sesión</button>
  </div>
</div>

<!-- ══ APP BAR ══ -->
<div id="app-bar">
  <div class="barlogo">El<span>Método</span>Simple</div>
  <div class="bar-right">
    <span class="abadge ok" id="app-acc-badge">✓ Activo</span>
    <button class="bhome" onclick="goHome()">← Mis productos</button>
  </div>
</div>

<!-- ══ MÓDULO AGENDA ══ -->
<div id="mod-agenda">
<!-- ══════════════ ONBOARDING ══════════════ -->
<div id="onboarding">
  <div class="ob-logo">Agenda Pro · 2025</div>
  <div class="ob-dots" id="obDots">
    <div class="ob-dot active"></div>
    <div class="ob-dot"></div>
    <div class="ob-dot"></div>
  </div>

  <div class="ob-step active" id="ob0">
    <div class="ob-icon">✦</div>
    <div class="ob-title">Bienvenido/a a tu<br>Agenda 2025</div>
    <div class="ob-sub">Tu espacio para organizarte, crecer y alcanzar todo lo que te propusiste este año.</div>
    <button class="ob-btn" onclick="FZ_obNext()">Empezar →</button>
  </div>

  <div class="ob-step" id="ob1">
    <div class="ob-icon">👤</div>
    <div class="ob-title">¿Cómo te llamás?</div>
    <div class="ob-sub">Personalizamos la agenda para vos.</div>
    <input class="ob-input" id="obName" placeholder="Tu nombre" maxlength="30" onkeydown="if(event.key==='Enter')FZ_obNext()">
    <input class="ob-input" id="obWord" placeholder="Tu palabra del año (ej: Crecer, Abundancia...)" maxlength="30">
    <button class="ob-btn" onclick="FZ_obNext()">Continuar →</button>
    <button class="ob-btn-skip" onclick="FZ_obNext()">Omitir</button>
  </div>

  <div class="ob-step" id="ob2">
    <div class="ob-icon">🎯</div>
    <div class="ob-title">¿Cuántas metas<br>tenés en mente?</div>
    <div class="ob-sub">Podés agregarlas ahora o más adelante. La agenda te acompaña en cada paso.</div>
    <button class="ob-btn" onclick="FZ_obFinish()">Abrir mi Agenda ✦</button>
  </div>
</div>

<!-- ══════════════ APP ══════════════ -->
<div id="app">

  <!-- TOPBAR -->
  <header class="topbar">
    <div>
      <div class="topbar-logo">✦ Agenda Pro</div>
      <div class="topbar-year">2026</div>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <div class="topbar-user" id="topUser">Hola —</div>
      <button onclick="openBackup()" title="Backup" style="width:32px;height:32px;border-radius:8px;background:var(--bg3);border:1px solid var(--border2);color:var(--gold);font-size:15px;display:flex;align-items:center;justify-content:center">☁</button>
    </div>
  </header>

  <!-- BACKUP PANEL -->
  <div id="backupPanel" style="display:none;position:fixed;inset:0;z-index:900;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);align-items:flex-end">
    <div style="width:100%;background:var(--bg2);border-radius:20px 20px 0 0;border-top:1px solid var(--border2);padding:24px 22px 40px">
      <div style="width:36px;height:4px;background:var(--border2);border-radius:2px;margin:0 auto 20px"></div>
      <div style="font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:700;color:var(--cream);margin-bottom:4px">☁ Backup de datos</div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:22px;line-height:1.6">Guardá una copia de todos tus datos o restauralos desde un backup anterior. Hacé backup antes de actualizar o cambiar de dispositivo.</div>
      <button onclick="doBackup()" style="width:100%;padding:14px;background:var(--gold);color:var(--bg);border-radius:8px;font-size:14px;font-weight:600;margin-bottom:10px;font-family:'Outfit',sans-serif">⬇ Descargar backup (.json)</button>
      <div style="position:relative;width:100%;margin-bottom:10px">
        <button onclick="document.getElementById('restoreFile').click()" style="width:100%;padding:14px;background:transparent;color:var(--text2);border:1.5px solid var(--border2);border-radius:8px;font-size:14px;font-weight:600;font-family:'Outfit',sans-serif">⬆ Restaurar desde archivo</button>
        <input type="file" id="restoreFile" accept=".json" style="display:none" onchange="doRestore(event)">
      </div>
      <div id="backupInfo" style="font-size:11px;color:var(--text3);text-align:center;margin-bottom:16px"></div>
      <button onclick="closeBackup()" style="width:100%;padding:12px;color:var(--text3);font-size:13px;font-family:'Outfit',sans-serif">Cerrar</button>
    </div>
  </div>

  <!-- YEAR PROGRESS -->
  <div class="year-banner">
    <div class="year-pct-label" id="ypLabel">—%</div>
    <div class="year-bar-wrap"><div class="year-bar-fill" id="ypBar" style="width:0%"></div></div>
    <div class="year-days" id="ypDays">— días</div>
  </div>

  <!-- NAV TABS -->
  <nav class="nav-wrap">
    <div class="nav-tabs" id="navTabs">
      <button class="nav-tab active" data-page="home">   <span class="nav-icon">◈</span> Inicio</button>
      <button class="nav-tab" data-page="metas">         <span class="nav-icon">◎</span> Metas</button>
      <button class="nav-tab" data-page="habitos">       <span class="nav-icon">◐</span> Hábitos</button>
      <button class="nav-tab" data-page="semana">        <span class="nav-icon">▦</span> Semana</button>
      <button class="nav-tab" data-page="mes">           <span class="nav-icon">◫</span> Mes</button>
      <button class="nav-tab" data-page="presupuesto">   <span class="nav-icon">◈</span> $ Presup.</button>
      <button class="nav-tab" data-page="viajes">        <span class="nav-icon">✈</span> Viajes</button>
      <button class="nav-tab" data-page="rutina">        <span class="nav-icon">☀</span> Rutina</button>
      <button class="nav-tab" data-page="wishlist">      <span class="nav-icon">♡</span> Wishlist</button>
      <button class="nav-tab" data-page="diario">        <span class="nav-icon">✎</span> Diario</button>
      <button class="nav-tab" data-page="vision">        <span class="nav-icon">✦</span> Visión</button>
      <button class="nav-tab" data-page="pomodoro">      <span class="nav-icon">⏱</span> Focus</button>
      <button class="nav-tab" data-page="stats">         <span class="nav-icon">◈</span> Stats</button>
      <button class="nav-tab" data-page="review">        <span class="nav-icon">⊞</span> Review</button>
    </div>
  </nav>

  <!-- CONTENT -->
  <div class="content">

    <!-- ── HOME ── -->
    <section class="page active" id="page-home">
      <div class="page-header">
        <div class="sec-eyebrow">Resumen general</div>
        <div class="sec-title" id="homeGreet">Hola ✦</div>
        <div class="sec-sub" id="homeWord"></div>
      </div>

      <div class="kpi-row">
        <div class="kpi kpi-g"><div class="kpi-label">Metas activas</div><div class="kpi-val" id="kMetas">0</div><div class="kpi-sub">en progreso</div></div>
        <div class="kpi kpi-gr"><div class="kpi-label">Hábitos hoy</div><div class="kpi-val" id="kHabitos">0%</div><div class="kpi-sub">completados</div></div>
      </div>
      <div class="kpi-row">
        <div class="kpi kpi-r"><div class="kpi-label">Tareas pend.</div><div class="kpi-val" id="kTareas">0</div><div class="kpi-sub">esta semana</div></div>
        <div class="kpi kpi-b"><div class="kpi-label">Viajes plan.</div><div class="kpi-val" id="kViajes">0</div><div class="kpi-sub">próximos</div></div>
      </div>

      <div class="divider"><span>Metas top</span></div>
      <div id="homeMetasPreview"></div>

      <div class="divider"><span>Hábitos de hoy</span></div>
      <div id="homeHabitosPreview"></div>

      <div class="divider"><span>Próximos eventos</span></div>
      <div id="homeEventosPreview"></div>
    </section>

    <!-- ── METAS ── -->
    <section class="page" id="page-metas">
      <div class="page-header">
        <div class="sec-eyebrow">Objetivos 2025</div>
        <div class="sec-title">Mis Metas</div>
        <div class="sec-sub">Definí y seguí tus objetivos por área de vida.</div>
      </div>

      <div class="card">
        <div class="card-title"><span class="card-title-icon">+</span> Nueva meta</div>
        <label class="form-label">Nombre de la meta</label>
        <input class="inp" id="mNombre" placeholder="¿Qué querés lograr?">
        <div class="inp-row">
          <div>
            <label class="form-label">Área</label>
            <select class="inp" id="mArea">
              <option>🏋️ Salud</option><option>💼 Trabajo</option><option>💰 Finanzas</option>
              <option>💑 Relaciones</option><option>🧠 Aprendizaje</option><option>🎨 Personal</option><option>✈️ Viajes</option>
            </select>
          </div>
          <div>
            <label class="form-label">Prioridad</label>
            <select class="inp" id="mPrio">
              <option>🔴 Alta</option><option>🟡 Media</option><option>🟢 Baja</option>
            </select>
          </div>
        </div>
        <div class="inp-row">
          <div>
            <label class="form-label">Fecha límite</label>
            <input type="date" class="inp" id="mFecha">
          </div>
          <div>
            <label class="form-label">Progreso %</label>
            <input type="number" class="inp" id="mPct" min="0" max="100" value="0" placeholder="0">
          </div>
        </div>
        <label class="form-label">¿Por qué importa?</label>
        <input class="inp" id="mPorque" placeholder="Mi motivación es...">
        <button class="btn btn-gold" onclick="FZ_addMeta()">✦ Agregar meta</button>
      </div>

      <div class="inner-tabs" id="metaTabsEl">
        <div class="inner-tab active" onclick="FZ_setMetaFilter('todas',this)">Todas</div>
        <div class="inner-tab" onclick="FZ_setMetaFilter('🏋️ Salud',this)">Salud</div>
        <div class="inner-tab" onclick="FZ_setMetaFilter('💼 Trabajo',this)">Trabajo</div>
        <div class="inner-tab" onclick="FZ_setMetaFilter('💰 Finanzas',this)">$</div>
        <div class="inner-tab" onclick="FZ_setMetaFilter('🎨 Personal',this)">Personal</div>
      </div>
      <div id="metasList"></div>
    </section>

    <!-- ── HÁBITOS ── -->
    <section class="page" id="page-habitos">
      <div class="page-header">
        <div class="sec-eyebrow">Seguimiento diario</div>
        <div class="sec-title">Hábitos</div>
        <div class="sec-sub">Construí consistencia un día a la vez.</div>
      </div>

      <div class="card">
        <div class="card-title"><span class="card-title-icon">+</span> Nuevo hábito</div>
        <div class="inp-row">
          <div style="max-width:80px">
            <label class="form-label">Emoji</label>
            <input class="inp" id="hEmoji" placeholder="🌟" maxlength="4">
          </div>
          <div style="flex:1">
            <label class="form-label">Nombre</label>
            <input class="inp" id="hName" placeholder="Ej: Meditación...">
          </div>
        </div>
        <label class="form-label">Meta diaria</label>
        <input class="inp" id="hMeta" placeholder="Ej: 20 min, 1 hora, 10 páginas...">
        <button class="btn btn-gold" onclick="addHabit()">+ Agregar hábito</button>
      </div>

      <div id="habitGrid"></div>
    </section>

    <!-- ── SEMANA ── -->
    <section class="page" id="page-semana">
      <div class="page-header">
        <div class="sec-eyebrow">Planificación</div>
        <div class="sec-title">Esta Semana</div>
        <div class="sec-sub" id="weekRangeLabel">—</div>
      </div>

      <div class="card">
        <div class="card-title"><span class="card-title-icon">+</span> Nueva tarea</div>
        <label class="form-label">Tarea</label>
        <input class="inp" id="tTitle" placeholder="¿Qué tenés que hacer?">
        <div class="inp-row">
          <div>
            <label class="form-label">Día</label>
            <select class="inp" id="tDia">
              <option value="0">Lunes</option><option value="1">Martes</option>
              <option value="2">Miércoles</option><option value="3">Jueves</option>
              <option value="4">Viernes</option><option value="5">Sábado</option><option value="6">Domingo</option>
            </select>
          </div>
          <div>
            <label class="form-label">Prioridad</label>
            <select class="inp" id="tPrio"><option>Alta</option><option>Media</option><option>Baja</option></select>
          </div>
        </div>
        <button class="btn btn-gold" onclick="addTarea()">+ Agregar</button>
      </div>

      <div id="semanaGrid"></div>

      <div class="divider"><span>Reflexión semanal</span></div>
      <div class="card">
        <label class="form-label">🏆 3 victorias de la semana</label>
        <textarea class="inp" id="refVictorias" placeholder="1. &#10;2. &#10;3. " style="min-height:90px"></textarea>
        <label class="form-label">🔍 ¿Qué mejorar la próxima semana?</label>
        <textarea class="inp" id="refMejoras" placeholder="La próxima semana voy a..."></textarea>
        <button class="btn btn-outline" onclick="saveRef()" style="margin-top:4px">Guardar reflexión</button>
      </div>
    </section>

    <!-- ── MES ── -->
    <section class="page" id="page-mes">
      <div class="page-header">
        <div class="sec-eyebrow">Vista mensual</div>
        <div class="sec-title">Calendario</div>
      </div>

      <div class="card">
        <div class="cal-nav">
          <button class="cal-arrow" onclick="FZ_changeMonth(-1)">‹</button>
          <div class="cal-month" id="calMonthLabel">—</div>
          <button class="cal-arrow" onclick="FZ_changeMonth(1)">›</button>
        </div>
        <div class="cal-grid" id="calGrid"></div>
      </div>

      <div class="card">
        <div class="card-title">+ Agregar evento</div>
        <label class="form-label">Evento</label>
        <input class="inp" id="evTitle" placeholder="¿Qué tenés programado?">
        <div class="inp-row">
          <div>
            <label class="form-label">Fecha</label>
            <input type="date" class="inp" id="evDate">
          </div>
          <div>
            <label class="form-label">Tipo</label>
            <select class="inp" id="evType">
              <option>📅 Cita</option><option>✈️ Viaje</option><option>🎂 Cumpleaños</option>
              <option>💼 Trabajo</option><option>🎯 Meta</option><option>🎉 Festejo</option>
            </select>
          </div>
        </div>
        <button class="btn btn-gold" onclick="addEvent()">+ Agregar</button>
      </div>

      <div class="divider"><span>Eventos del mes</span></div>
      <ul class="item-list" id="evList"></ul>
    </section>

    <!-- ── PRESUPUESTO ── -->
    <section class="page" id="page-presupuesto">
      <div class="page-header">
        <div class="sec-eyebrow">Finanzas personales</div>
        <div class="sec-title">Presupuesto</div>
        <div class="sec-sub" id="budgetMonthLabel">—</div>
      </div>

      <div class="budget-summary" id="budgetSummary">
        <div class="budget-main">
          <div><div class="budget-label">Ingresos</div><div class="budget-ing" id="bIng">$0</div></div>
          <div style="text-align:right"><div class="budget-label">Gastos</div><div class="budget-gas" id="bGas">$0</div></div>
        </div>
        <div class="prog-bar"><div class="prog-fill" id="bProg" style="width:0%"></div></div>
        <div class="budget-ahorro">
          <div class="budget-ahorro-label">Balance</div>
          <div class="budget-ahorro-val" id="bBalance" style="color:var(--green)">$0</div>
        </div>
      </div>

      <div class="inner-tabs">
        <div class="inner-tab active" onclick="FZ_setBudgetTab('add',this)">+ Agregar</div>
        <div class="inner-tab" onclick="FZ_setBudgetTab('hist',this)">Historial</div>
      </div>

      <div id="budgetAdd">
        <div class="card">
          <label class="form-label">Descripción</label>
          <input class="inp" id="txDesc" placeholder="Ej: Sueldo, Alquiler, Supermercado...">
          <div class="inp-row">
            <div>
              <label class="form-label">Monto</label>
              <input type="number" class="inp" id="txMonto" placeholder="0">
            </div>
            <div>
              <label class="form-label">Tipo</label>
              <select class="inp" id="txTipo"><option value="ing">💚 Ingreso</option><option value="gas">🔴 Gasto</option></select>
            </div>
          </div>
          <div class="inp-row">
            <div>
              <label class="form-label">Categoría</label>
              <select class="inp" id="txCat">
                <option>💼 Trabajo</option><option>🏠 Vivienda</option><option>🛒 Comida</option>
                <option>🚗 Transporte</option><option>💊 Salud</option><option>🎭 Ocio</option>
                <option>📚 Educación</option><option>✈️ Viajes</option><option>🔧 Otros</option>
              </select>
            </div>
            <div>
              <label class="form-label">Fecha</label>
              <input type="date" class="inp" id="txFecha">
            </div>
          </div>
          <button class="btn btn-gold" onclick="addTx()">+ Registrar</button>
        </div>
      </div>
      <div id="budgetHist" style="display:none">
        <div id="txList"></div>
      </div>
    </section>

    <!-- ── VIAJES ── -->
    <section class="page" id="page-viajes">
      <div class="page-header">
        <div class="sec-eyebrow">Explorar el mundo</div>
        <div class="sec-title">Mis Viajes</div>
        <div class="sec-sub">Planificá, presupuestá y soñá.</div>
      </div>

      <div class="card">
        <div class="card-title">✈️ Nuevo viaje</div>
        <label class="form-label">Destino</label>
        <input class="inp" id="vDest" placeholder="¿A dónde vas? 🌍">
        <div class="inp-row">
          <div><label class="form-label">Fecha ida</label><input type="date" class="inp" id="vIda"></div>
          <div><label class="form-label">Fecha vuelta</label><input type="date" class="inp" id="vVuelta"></div>
        </div>
        <div class="inp-row">
          <div><label class="form-label">Presupuesto total</label><input type="number" class="inp" id="vPresup" placeholder="0"></div>
          <div><label class="form-label">Estado</label>
            <select class="inp" id="vEstado">
              <option>💭 Soñando</option><option>📋 Planeando</option>
              <option>✅ Confirmado</option><option>✈️ En curso</option><option>🏡 Completado</option>
            </select>
          </div>
        </div>
        <label class="form-label">Notas / lista de cosas</label>
        <textarea class="inp" id="vNotas" placeholder="Qué llevar, qué ver, qué hacer..."></textarea>
        <button class="btn btn-gold" onclick="addViaje()">✈️ Agregar viaje</button>
      </div>

      <div id="viajesList"></div>
    </section>

    <!-- ── RUTINA ── -->
    <section class="page" id="page-rutina">
      <div class="page-header">
        <div class="sec-eyebrow">Estructura diaria</div>
        <div class="sec-title">Mi Rutina</div>
        <div class="sec-sub">Diseñá tu mañana y tu noche ideal.</div>
      </div>

      <div class="inner-tabs" id="rutinaTabsEl">
        <div class="inner-tab active" onclick="setRutinaTab('man',this)">☀️ Mañana</div>
        <div class="inner-tab" onclick="setRutinaTab('noc',this)">🌙 Noche</div>
      </div>

      <div id="rutinaContent"></div>

      <div class="card" style="margin-top:16px">
        <div class="card-title">+ Nuevo paso</div>
        <div class="inp-row">
          <div style="max-width:70px"><label class="form-label">Emoji</label><input class="inp" id="rEmoji" placeholder="☀️" maxlength="4"></div>
          <div style="flex:1"><label class="form-label">Actividad</label><input class="inp" id="rNombre" placeholder="Ej: Meditar, Leer..."></div>
        </div>
        <div class="inp-row">
          <div><label class="form-label">Hora</label><input class="inp" id="rHora" placeholder="06:30"></div>
          <div><label class="form-label">Tipo</label>
            <select class="inp" id="rTipo"><option value="man">☀️ Mañana</option><option value="noc">🌙 Noche</option></select>
          </div>
        </div>
        <button class="btn btn-gold" onclick="addRutina()">+ Agregar paso</button>
      </div>
    </section>

    <!-- ── WISHLIST ── -->
    <section class="page" id="page-wishlist">
      <div class="page-header">
        <div class="sec-eyebrow">Deseos & objetivos</div>
        <div class="sec-title">Wishlist</div>
        <div class="sec-sub">Todo lo que querés tener, hacer o experimentar.</div>
      </div>

      <div class="card">
        <div class="card-title">♡ Nuevo deseo</div>
        <div class="inp-row">
          <div style="max-width:70px"><label class="form-label">Emoji</label><input class="inp" id="wEmoji" placeholder="🌟" maxlength="4"></div>
          <div style="flex:1"><label class="form-label">Nombre</label><input class="inp" id="wNombre" placeholder="¿Qué querés?"></div>
        </div>
        <div class="inp-row">
          <div><label class="form-label">Precio aprox.</label><input type="number" class="inp" id="wPrecio" placeholder="0"></div>
          <div><label class="form-label">Categoría</label>
            <select class="inp" id="wCat">
              <option>🛍️ Compra</option><option>✈️ Experiencia</option><option>📚 Aprendizaje</option>
              <option>🏠 Hogar</option><option>💄 Personal</option><option>🎁 Regalo</option><option>🔧 Otros</option>
            </select>
          </div>
        </div>
        <button class="btn btn-gold" onclick="addWish()">+ Agregar</button>
      </div>

      <div class="divider"><span>Mi lista</span></div>
      <div id="wishGrid"></div>
    </section>

    <!-- ── DIARIO ── -->
    <section class="page" id="page-diario">
      <div class="page-header">
        <div class="sec-eyebrow">Reflexión personal</div>
        <div class="sec-title">Mi Diario</div>
        <div class="sec-sub">Espacio para procesar, reflexionar y crecer.</div>
      </div>

      <div class="card">
        <div class="inp-row">
          <div><label class="form-label">Fecha</label><input type="date" class="inp" id="dFecha"></div>
          <div><label class="form-label">Ánimo</label>
            <select class="inp" id="dAnimo">
              <option>🔥 Excelente</option><option>😊 Bien</option><option>😐 Neutro</option>
              <option>😔 Difícil</option><option>😴 Cansado/a</option>
            </select>
          </div>
        </div>
        <label class="form-label">Reflexión del día</label>
        <textarea class="inp" id="dTexto" style="min-height:130px"
          placeholder="¿Cómo fue tu día? ¿Qué aprendiste? ¿Por qué estás agradecido/a?

→ Lo mejor del día fue...
→ Me sentí retado/a cuando...
→ Mañana me voy a enfocar en..."></textarea>
        <button class="btn btn-gold" onclick="addNote()">Guardar entrada</button>
      </div>

      <div id="notesList"></div>
    </section>

    <!-- ── VISIÓN ── -->
    <section class="page" id="page-vision">
      <div class="page-header">
        <div class="sec-eyebrow">El gran cuadro</div>
        <div class="sec-title">Visión 2025</div>
        <div class="sec-sub">Definí quién querés ser y qué querés construir este año.</div>
      </div>

      <div class="card">
        <div class="card-title">✦ Propósito del año</div>
        <label class="form-label">Tu palabra del año</label>
        <input class="inp" id="vsPalabra" placeholder="Ej: Crecimiento, Equilibrio, Abundancia...">
        <label class="form-label">Mi declaración personal 2025</label>
        <textarea class="inp" id="vsDecl" style="min-height:100px"
          placeholder="En 2025 me comprometo a...&#10;La persona que quiero ser es...&#10;Mi mayor logro será..."></textarea>
        <button class="btn btn-gold" onclick="saveVision()">Guardar visión</button>
      </div>

      <div class="divider"><span>Las 6 áreas de vida</span></div>
      <div id="vsAreas"></div>

      <div class="divider"><span>Logros que quiero celebrar en diciembre</span></div>
      <div id="vsLogros"></div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <input class="inp" id="vsLogroInput" placeholder="Agregar logro deseado..." style="flex:1;margin:0">
        <button class="btn btn-gold btn-sm" onclick="addLogro()" style="width:auto;white-space:nowrap">+ Agregar</button>
      </div>
    </section>

    <!-- ── POMODORO ── -->
    <section class="page" id="page-pomodoro">
      <div class="page-header">
        <div class="sec-eyebrow">Concentración profunda</div>
        <div class="sec-title">Focus Timer</div>
        <div class="sec-sub">Trabajá en bloques. Descansá con intención.</div>
      </div>
      <div class="card">
        <div class="pomo-mode-row">
          <div class="pomo-mode active" id="pmode-focus" onclick="setPomoMode('focus')">Foco 25'</div>
          <div class="pomo-mode" id="pmode-short" onclick="setPomoMode('short')">Descanso 5'</div>
          <div class="pomo-mode" id="pmode-long"  onclick="setPomoMode('long')">Descanso 15'</div>
        </div>
        <div class="pomo-ring-wrap">
          <div class="pomo-ring">
            <svg class="pomo-svg" width="200" height="200" viewBox="0 0 200 200">
              <circle class="pomo-track" cx="100" cy="100" r="88"/>
              <circle class="pomo-fill" id="pomoFill" cx="100" cy="100" r="88" stroke-dasharray="552.9" stroke-dashoffset="0"/>
            </svg>
            <div class="pomo-center">
              <div class="pomo-time" id="pomoTime">25:00</div>
              <div class="pomo-label" id="pomoLabel">Foco</div>
            </div>
          </div>
          <div class="pomo-controls">
            <button class="pomo-btn pomo-btn-sec" onclick="pomoReset()" title="Reiniciar">↺</button>
            <button class="pomo-btn pomo-btn-main" id="pomoPlayBtn" onclick="pomoToggle()">▶</button>
            <button class="pomo-btn pomo-btn-sec" onclick="pomoSkip()" title="Siguiente">⏭</button>
          </div>
          <div class="pomo-sessions" id="pomoSessions"></div>
        </div>
        <div class="pomo-stat-row">
          <div class="pomo-stat"><div class="pomo-stat-val" id="psToday">0</div><div class="pomo-stat-lbl">Hoy</div></div>
          <div class="pomo-stat"><div class="pomo-stat-val" id="psWeek">0</div><div class="pomo-stat-lbl">Esta semana</div></div>
          <div class="pomo-stat"><div class="pomo-stat-val" id="psTotal">0</div><div class="pomo-stat-lbl">Total</div></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">¿En qué vas a trabajar?</div>
        <input class="inp" id="pomoTask" placeholder="Ej: Terminar informe, Estudiar capítulo 3...">
        <div id="pomoTaskHistory" style="margin-top:4px"></div>
      </div>
    </section>

    <!-- ── STATS ── -->
    <section class="page" id="page-stats">
      <div class="page-header">
        <div class="sec-eyebrow">Tu año en números</div>
        <div class="sec-title">Estadísticas</div>
        <div class="sec-sub">Mirá cuánto avanzaste.</div>
      </div>
      <div class="stat-big-row" id="statsBig"></div>
      <div class="card" id="statsMetasCard">
        <div class="card-title">◎ Progreso de metas</div>
        <div id="statsMetas"></div>
      </div>
      <div class="card" id="statsHabitosCard">
        <div class="card-title">◐ Racha de hábitos</div>
        <div id="statsHabitos"></div>
      </div>
      <div class="card">
        <div class="card-title">💰 Balance mensual</div>
        <div id="statsBalance"></div>
        <div class="mini-chart" id="statsChart"></div>
        <div style="display:flex;justify-content:space-between;margin-top:4px">
          <span style="font-size:9px;color:var(--text3)">Ene</span>
          <span style="font-size:9px;color:var(--text3)">Dic</span>
        </div>
      </div>
      <div class="card">
        <div class="card-title">✎ Entradas en el diario</div>
        <div id="statsDiario"></div>
      </div>
    </section>

    <!-- ── REVIEW ── -->
    <section class="page" id="page-review">
      <div class="page-header">
        <div class="sec-eyebrow">Cierre de mes</div>
        <div class="sec-title">Review Mensual</div>
        <div class="sec-sub">Revisá, aprendé y ajustá el rumbo.</div>
      </div>
      <div class="card">
        <div class="card-title">Mes a revisar</div>
        <select class="inp" id="revMes" onchange="loadReview()">
          <option>Enero</option><option>Febrero</option><option>Marzo</option><option>Abril</option>
          <option>Mayo</option><option>Junio</option><option>Julio</option><option>Agosto</option>
          <option>Septiembre</option><option>Octubre</option><option>Noviembre</option><option>Diciembre</option>
        </select>
        <div class="divider"><span>Evaluación de áreas (1–5)</span></div>
        <div id="revAreas"></div>
        <div class="divider"><span>Reflexión</span></div>
        <label class="form-label">🏆 Top 3 logros del mes</label>
        <textarea class="inp" id="revLogros" placeholder="1. &#10;2. &#10;3. " style="min-height:90px"></textarea>
        <label class="form-label">⚡ Desafíos enfrentados</label>
        <textarea class="inp" id="revDesafios" placeholder="Los momentos difíciles fueron...&#10;Lo que aprendí fue..."></textarea>
        <label class="form-label">🎯 Intención para el próximo mes</label>
        <textarea class="inp" id="revIntencion" placeholder="El mes que viene me voy a enfocar en..."></textarea>
        <button class="btn btn-gold" onclick="saveReview()" style="margin-top:4px">Guardar review</button>
      </div>
      <div class="divider"><span>Reviews guardados</span></div>
      <div id="revList"></div>
    </section>

  </div><!-- /content -->

  <!-- FAB NOTAS RÁPIDAS -->
  <button class="qnote-fab" id="qnoteFab" onclick="toggleQNote()" title="Nota rápida">✎</button>

  <!-- PANEL NOTAS RÁPIDAS -->
  <div class="qnote-panel" id="qnotePanel" onclick="closeQNote(event)">
    <div class="qnote-sheet">
      <div class="qnote-handle"></div>
      <div class="qnote-title">✎ Notas rápidas</div>
      <div class="qnote-list" id="qnoteList"></div>
      <div style="display:flex;gap:8px">
        <input class="inp" id="qnoteInput" placeholder="Capturá una idea al vuelo..." style="flex:1;margin:0" onkeydown="if(event.key==='Enter')addQNote()">
        <button class="btn btn-gold btn-sm" onclick="addQNote()" style="width:auto;padding:11px 16px">+</button>
      </div>
    </div>
  </div>
  <nav class="bottom-nav" id="bottomNav">
    <div class="bnav-item active" onclick="navTo('home',this)"><div class="bnav-icon">◈</div><div class="bnav-label">Inicio</div></div>
    <div class="bnav-item" onclick="navTo('metas',this)"><div class="bnav-icon">◎</div><div class="bnav-label">Metas</div></div>
    <div class="bnav-item" onclick="navTo('habitos',this)"><div class="bnav-icon">◐</div><div class="bnav-label">Hábitos</div></div>
    <div class="bnav-item" onclick="navTo('semana',this)"><div class="bnav-icon">▦</div><div class="bnav-label">Semana</div></div>
    <div class="bnav-item" onclick="navTo('diario',this)"><div class="bnav-icon">✎</div><div class="bnav-label">Diario</div></div>
  </nav>
</div><!-- /app -->

<div class="toast" id="toast"></div>
</div>

<!-- ══ MÓDULO FINANZAS ══ -->
<div id="mod-finanzas">
<!-- ONBOARDING -->
<div class="onboarding hidden" id="onboarding">
  <div class="ob-card">
    <div class="ob-dots" id="ob-dots"></div>

    <div class="ob-step-content active" id="obs-1">
      <div class="ob-step-label">Paso 1 de 6</div>
      <div class="ob-title">Por fin sabrás a dónde va tu dinero.</div>
      <div class="ob-desc">Control total de tus gastos, suscripciones, tarjetas y metas. Todo en tu dispositivo, sin que nadie vea tus datos.</div>
      <div class="ob-nav"><div></div><button class="btn btn-primary" onclick="FZ_obGo(2)">Empezar →</button></div>
    </div>

    <div class="ob-step-content" id="obs-2">
      <div class="ob-step-label">Paso 2 de 6</div>
      <div class="ob-title">¿Qué moneda usas?</div>
      <div class="ob-desc">Usaremos este símbolo en toda la app.</div>
      <div class="form-row" style="margin-bottom:12px">
        <div class="form-group">
          <label class="form-label">Símbolo de moneda</label>
          <input type="text" class="form-input" id="ob-currency" placeholder="€" maxlength="5" value="€">
        </div>
        <div class="form-group">
          <label class="form-label">Ingreso mensual neto (opcional)</label>
          <input type="number" class="form-input" id="ob-income" placeholder="2500" min="0">
        </div>
      </div>
      <div class="ob-nav">
        <button class="btn btn-ghost" onclick="FZ_obGo(1)">← Atrás</button>
        <button class="btn btn-primary" onclick="FZ_obGo(3)">Continuar →</button>
      </div>
    </div>

    <div class="ob-step-content" id="obs-3">
      <div class="ob-step-label">Paso 3 de 6</div>
      <div class="ob-title">¿Tienes vehículo?</div>
      <div class="ob-desc">Activamos el módulo de gastos del coche si lo necesitas.</div>
      <div class="ob-toggle-wrap" id="ob-car-wrap">
        <div class="ob-toggle selected" id="ob-car-no" onclick="FZ_selectCar(false)"><span class="tog-icon">🚶</span>No tengo</div>
        <div class="ob-toggle" id="ob-car-yes" onclick="FZ_selectCar(true)"><span class="tog-icon">🚗</span>Sí tengo</div>
      </div>
      <div class="ob-nav" style="margin-top:16px">
        <button class="btn btn-ghost" onclick="FZ_obGo(2)">← Atrás</button>
        <button class="btn btn-primary" onclick="FZ_obGo(4)">Continuar →</button>
      </div>
    </div>

    <div class="ob-step-content" id="obs-4">
      <div class="ob-step-label">Paso 4 de 6</div>
      <div class="ob-title">¿Tienes tarjeta de crédito?</div>
      <div class="ob-desc">Controlamos cuotas pendientes, límite y gastos.</div>
      <div class="ob-toggle-wrap" id="ob-cc-wrap">
        <div class="ob-toggle selected" id="ob-cc-no" onclick="FZ_selectCC(false)"><span class="tog-icon">🚫</span>No tengo</div>
        <div class="ob-toggle" id="ob-cc-yes" onclick="FZ_selectCC(true)"><span class="tog-icon">💳</span>Sí tengo</div>
      </div>
      <div id="ob-cc-fields" style="display:none;margin-top:16px">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Nombre del banco</label>
            <input type="text" class="form-input" id="ob-cc-bank" placeholder="Ej: BBVA, Santander...">
          </div>
          <div class="form-group">
            <label class="form-label">Límite de crédito</label>
            <input type="number" class="form-input" id="ob-cc-limit" placeholder="3000" min="0">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Últimos 4 dígitos (opcional)</label>
          <input type="text" class="form-input" id="ob-cc-digits" placeholder="1234" maxlength="4">
        </div>
      </div>
      <div class="ob-nav" style="margin-top:16px">
        <button class="btn btn-ghost" onclick="FZ_obGo(3)">← Atrás</button>
        <button class="btn btn-primary" onclick="FZ_obGo(5)">Continuar →</button>
      </div>
    </div>

    <div class="ob-step-content" id="obs-5">
      <div class="ob-step-label">Paso 5 de 6</div>
      <div class="ob-title">¿Qué suscripciones tienes?</div>
      <div class="ob-desc">Selecciona las que pagas. Tú pones el precio real de cada una.</div>
      <div class="ob-sub-grid" id="ob-subs-grid"></div>
      <div id="ob-subs-prices" style="margin-top:12px"></div>
      <div class="ob-nav" style="margin-top:4px">
        <button class="btn btn-ghost" onclick="FZ_obGo(4)">← Atrás</button>
        <button class="btn btn-primary" onclick="FZ_obGo(6)">Continuar →</button>
      </div>
    </div>

    <div class="ob-step-content" id="obs-6">
      <div class="ob-step-label">Paso 6 de 6</div>
      <div class="ob-title">¿Cuál es tu objetivo?</div>
      <div class="ob-desc">Personalizamos alertas y consejos para ti.</div>
      <div id="ob-goals-list"></div>
      <div class="ob-nav">
        <button class="btn btn-ghost" onclick="FZ_obGo(5)">← Atrás</button>
        <button class="btn btn-primary" onclick="FZ_finishOnboarding()">¡Entrar a mis finanzas! 🚀</button>
      </div>
    </div>

  </div>
</div>

<!-- APP -->
<div class="app">
  <aside class="sidebar">
    <div class="sidebar-brand">
      <div class="brand-name">Finanzas</div>
      <div class="brand-currency" id="sidebar-currency-label"></div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">Principal</div>
      <div class="nav-item active" onclick="FZ_showPage('dashboard')"><span class="nav-icon">📊</span><span>Dashboard</span></div>
      <div class="nav-item" onclick="FZ_showPage('gastos')"><span class="nav-icon">💸</span><span>Gastos</span></div>
      <div class="nav-item" onclick="FZ_showPage('presupuesto')"><span class="nav-icon">🎯</span><span>Presupuesto</span></div>
      <div class="nav-section" style="margin-top:6px">Módulos</div>
      <div class="nav-item" onclick="FZ_showPage('suscripciones')"><span class="nav-icon">📱</span><span>Suscripciones</span></div>
      <div class="nav-item" id="nav-tarjeta" onclick="FZ_showPage('tarjeta')"><span class="nav-icon">💳</span><span>Tarjeta</span></div>
      <div class="nav-item" id="nav-vehiculo" onclick="FZ_showPage('vehiculo')"><span class="nav-icon">🚗</span><span>Vehículo</span></div>
      <div class="nav-item" onclick="FZ_showPage('metas')"><span class="nav-icon">🏆</span><span>Metas</span></div>
    </nav>
    <div class="sidebar-bottom">
      <div class="month-nav">
        <button class="month-btn" onclick="FZ_changeMonth(-1)">‹</button>
        <span class="month-name" id="month-label"></span>
        <button class="month-btn" onclick="FZ_changeMonth(1)">›</button>
      </div>
      <div style="margin-top:10px;display:flex;flex-direction:column;gap:5px">
        <button class="nav-item" style="justify-content:flex-start;font-size:.78rem;padding:8px 12px" onclick="FZ_showPage('ajustes')">
          <span class="nav-icon">⚙️</span><span>Ajustes y datos</span>
        </button>
      </div>
    </div>
  </aside>

  <main class="main">

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="page-header">
        <div>
          <div class="page-title">Resumen <span style="color:var(--green)" id="dash-month-title"></span></div>
          <div class="page-subtitle">Tu panorama financiero del mes</div>
        </div>
        <button class="btn btn-primary" onclick="FZ_openModal('gasto')">+ Registrar</button>
      </div>
      <div id="dash-semaforo" class="semaforo sem-green"><span>🟢</span><span id="sem-text">Cargando...</span></div>
      <div class="grid-4" id="stat-cards"></div>
      <div class="score-wrap">
        <div class="score-ring-box">
          <svg class="score-ring" viewBox="0 0 76 76">
            <circle class="ring-bg" cx="38" cy="38" r="32"/>
            <circle class="ring-fill" id="ring-fill" cx="38" cy="38" r="32" stroke-dasharray="201" stroke-dashoffset="201"/>
          </svg>
          <div class="score-num green" id="score-num">—</div>
        </div>
        <div class="score-info">
          <div class="score-title">Puntuación financiera</div>
          <div class="score-desc" id="score-desc">Basada en presupuesto, regularidad y metas.</div>
        </div>
      </div>
      <div class="grid-21">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
            <div style="font-size:.88rem;font-weight:600">Últimos movimientos</div>
            <button class="btn btn-ghost btn-sm" onclick="FZ_showPage('gastos')">Ver todos</button>
          </div>
          <div id="recent-tx"></div>
        </div>
        <div>
          <div class="card" style="margin-bottom:14px">
            <div style="font-size:.88rem;font-weight:600;margin-bottom:14px">Por categoría</div>
            <div class="donut-wrap">
              <svg class="donut-svg" viewBox="0 0 130 130" id="donut-svg"></svg>
              <div class="donut-center"><div class="donut-val" id="donut-val">—</div><div class="donut-lbl">total</div></div>
            </div>
            <div id="chart-legend"></div>
          </div>
          <div class="card" style="padding:18px">
            <div style="font-size:.82rem;font-weight:600;margin-bottom:8px">🔥 Racha de registros</div>
            <div class="streak-days" id="streak-days"></div>
            <div style="font-size:.72rem;color:var(--text2);margin-top:7px" id="streak-text"></div>
          </div>
        </div>
      </div>
      <div class="card" id="alerts-card">
        <div style="font-size:.88rem;font-weight:600;margin-bottom:10px">⚡ Alertas</div>
        <div id="alerts-list"></div>
      </div>
    </div>

    <!-- GASTOS -->
    <div class="page" id="page-gastos">
      <div class="page-header">
        <div>
          <div class="page-title">Gastos</div>
          <div class="page-subtitle" id="gastos-sub">Todos tus movimientos</div>
        </div>
        <button class="btn btn-primary" onclick="FZ_openModal('gasto')">+ Nuevo</button>
      </div>
      <div class="tabs">
        <button class="tab active" onclick="FZ_filterTx('todos',this)">Todos</button>
        <button class="tab" onclick="FZ_filterTx('gasto',this)">Gastos</button>
        <button class="tab" onclick="FZ_filterTx('ingreso',this)">Ingresos</button>
      </div>
      <div class="card"><div id="all-tx"></div></div>
    </div>

    <!-- PRESUPUESTO -->
    <div class="page" id="page-presupuesto">
      <div class="page-header">
        <div><div class="page-title">Presupuesto</div><div class="page-subtitle">Control por categorías</div></div>
        <button class="btn btn-ghost" onclick="FZ_openModal('presupuesto')">⚙️ Configurar límites</button>
      </div>
      <div class="grid-2" id="budget-cards"></div>
    </div>

    <!-- SUSCRIPCIONES -->
    <div class="page" id="page-suscripciones">
      <div class="page-header">
        <div><div class="page-title">Suscripciones</div><div class="page-subtitle" id="subs-sub">Tus pagos recurrentes</div></div>
        <button class="btn btn-primary" onclick="FZ_openModal('suscripcion')">+ Agregar</button>
      </div>
      <div class="card"><div id="subs-list"></div></div>
    </div>

    <!-- TARJETA -->
    <div class="page" id="page-tarjeta">
      <div class="page-header">
        <div><div class="page-title">Tarjetas de crédito</div><div class="page-subtitle">Control de gastos y cuotas</div></div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-ghost" onclick="FZ_openModal('cuota')">+ Cuota</button>
          <button class="btn btn-ghost" onclick="FZ_openModal('cc-gasto')">+ Gasto</button>
          <button class="btn btn-primary" onclick="FZ_openModal('add-card')">+ Tarjeta</button>
        </div>
      </div>
      <div id="cc-visual"></div>
      <div class="grid-3" id="cc-stats" style="margin-bottom:20px"></div>
      <div class="grid-2">
        <div class="card">
          <div style="font-size:.88rem;font-weight:600;margin-bottom:14px">💸 Gastos con tarjeta</div>
          <div id="cc-tx-list"></div>
        </div>
        <div class="card">
          <div style="font-size:.88rem;font-weight:600;margin-bottom:14px">📅 Cuotas pendientes</div>
          <div id="cc-cuotas-list"></div>
        </div>
      </div>
    </div>

    <!-- VEHICULO -->
    <div class="page" id="page-vehiculo">
      <div class="page-header">
        <div><div class="page-title">Vehículo</div><div class="page-subtitle">Gastos de tu coche</div></div>
        <button class="btn btn-primary" onclick="FZ_openModal('vehiculo')">+ Registrar</button>
      </div>
      <div class="grid-3" id="vehicle-stats" style="margin-bottom:20px"></div>
      <div class="card"><div id="vehicle-list"></div></div>
    </div>

    <!-- METAS -->
    <div class="page" id="page-metas">
      <div class="page-header">
        <div><div class="page-title">Metas de ahorro</div><div class="page-subtitle">Tus objetivos financieros</div></div>
        <button class="btn btn-primary" onclick="FZ_openModal('meta')">+ Nueva meta</button>
      </div>
      <div class="card"><div id="metas-list"></div></div>
    </div>

    <!-- AJUSTES -->
    <div class="page" id="page-ajustes">
      <div class="page-header">
        <div><div class="page-title">Ajustes y datos</div><div class="page-subtitle">Gestiona tu información y configuración</div></div>
      </div>

      <!-- Backup -->
      <div class="card" style="margin-bottom:16px">
        <div style="font-size:.95rem;font-weight:600;margin-bottom:4px">💾 Copia de seguridad</div>
        <div style="font-size:.8rem;color:var(--text2);margin-bottom:16px;line-height:1.5">Exporta todos tus datos a un archivo JSON. Guárdalo en un lugar seguro y úsalo para restaurar si cambias de dispositivo o navegador.</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="FZ_exportJSON()">💾 Exportar datos (.json)</button>
          <label class="btn btn-ghost" style="cursor:pointer">
            📂 Importar datos
            <input type="file" accept=".json" style="display:none" onchange="importJSON(this)">
          </label>
        </div>
        <div id="backup-status" style="margin-top:12px;font-size:.78rem;color:var(--text3)"></div>
      </div>

      <!-- Informe PDF -->
      <div class="card" style="margin-bottom:16px">
        <div style="font-size:.95rem;font-weight:600;margin-bottom:4px">📄 Informe mensual</div>
        <div style="font-size:.8rem;color:var(--text2);margin-bottom:16px;line-height:1.5">Genera un informe visual del mes actual con todos tus gastos, ingresos y resumen. Puedes guardarlo como PDF desde el diálogo de impresión de tu navegador.</div>
        <button class="btn btn-ghost" onclick="FZ_generarInforme()">📄 Ver informe de <span id="btn-informe-mes"></span></button>
      </div>

      <!-- Config moneda -->
      <div class="card" style="margin-bottom:16px">
        <div style="font-size:.95rem;font-weight:600;margin-bottom:4px">💱 Moneda</div>
        <div style="font-size:.8rem;color:var(--text2);margin-bottom:12px">Símbolo que aparece en todos los importes.</div>
        <div style="display:flex;gap:10px;align-items:center">
          <input type="text" class="form-input" id="cfg-currency" style="width:100px" maxlength="5" placeholder="€">
          <button class="btn btn-primary btn-sm" onclick="FZ_saveCurrency()">Guardar</button>
        </div>
      </div>

      <!-- Reset -->
      <div class="card" style="border-color:rgba(248,113,113,.2)">
        <div style="font-size:.95rem;font-weight:600;margin-bottom:4px;color:var(--red)">⚠️ Zona de peligro</div>
        <div style="font-size:.8rem;color:var(--text2);margin-bottom:14px">Elimina todos tus datos y vuelve al inicio. Esta acción no se puede deshacer.</div>
        <button class="btn btn-danger" onclick="FZ_resetApp()">🗑️ Borrar todos los datos</button>
      </div>
    </div>

  </main>
</div>

<!-- INFORME PRINT -->
<div id="informe-print" style="display:none">
</div>

<!-- MODAL GASTO/INGRESO -->
<div class="modal-overlay" id="modal-gasto">
  <div class="modal">
    <div class="modal-title">Registrar movimiento</div>
    <div class="tabs">
      <button class="tab active" onclick="FZ_setTxType('gasto',this)">💸 Gasto</button>
      <button class="tab" onclick="FZ_setTxType('ingreso',this)">💰 Ingreso</button>
    </div>
    <div class="form-group">
      <label class="form-label">Importe</label>
      <input type="number" class="form-input" id="tx-amount" placeholder="0.00" min="0" step="0.01">
    </div>
    <div class="form-group">
      <label class="form-label">Descripción</label>
      <input type="text" class="form-input" id="tx-desc" placeholder="Ej: Mercadona, Sueldo...">
    </div>
    <div class="form-group" id="cat-group">
      <label class="form-label">Categoría</label>
      <div class="cat-grid" id="cat-grid"></div>
    </div>
    <div class="form-group">
      <label class="form-label">Fecha</label>
      <input type="date" class="form-input" id="tx-date">
    </div>
    <div class="form-actions">
      <button class="btn btn-ghost" style="flex:1" onclick="FZ_closeModal('gasto')">Cancelar</button>
      <button class="btn btn-primary" style="flex:2" onclick="FZ_saveTx()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL SUSCRIPCION -->
<div class="modal-overlay" id="modal-suscripcion">
  <div class="modal">
    <div class="modal-title">Nueva suscripción</div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Nombre</label>
        <input type="text" class="form-input" id="sub-name" placeholder="Netflix, Spotify...">
      </div>
      <div class="form-group">
        <label class="form-label">Icono (emoji)</label>
        <input type="text" class="form-input" id="sub-icon" placeholder="📱" maxlength="4">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Precio</label>
        <input type="number" class="form-input" id="sub-price" placeholder="9.99" min="0" step="0.01">
      </div>
      <div class="form-group">
        <label class="form-label">Frecuencia</label>
        <select class="form-input" id="sub-freq">
          <option value="mensual">Mensual</option>
          <option value="anual">Anual</option>
          <option value="semanal">Semanal</option>
          <option value="trimestral">Trimestral</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Próxima renovación</label>
      <input type="date" class="form-input" id="sub-renew">
    </div>
    <div class="form-actions">
      <button class="btn btn-ghost" style="flex:1" onclick="FZ_closeModal('suscripcion')">Cancelar</button>
      <button class="btn btn-primary" style="flex:2" onclick="FZ_saveSub()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL CC GASTO -->
<div class="modal-overlay" id="modal-cc-gasto">
  <div class="modal">
    <div class="modal-title">Gasto con tarjeta</div>
    <div class="form-group">
      <label class="form-label">Descripción</label>
      <input type="text" class="form-input" id="cc-desc" placeholder="Ej: Amazon, Ropa...">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Importe total</label>
        <input type="number" class="form-input" id="cc-amount" placeholder="0.00" min="0" step="0.01">
      </div>
      <div class="form-group">
        <label class="form-label">Fecha</label>
        <input type="date" class="form-input" id="cc-date">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Categoría</label>
      <div class="cat-grid" id="cc-cat-grid"></div>
    </div>
    <div class="form-actions">
      <button class="btn btn-ghost" style="flex:1" onclick="FZ_closeModal('cc-gasto')">Cancelar</button>
      <button class="btn btn-primary" style="flex:2" onclick="FZ_saveCCGasto()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL CUOTA -->
<div class="modal-overlay" id="modal-add-card">
  <div class="modal">
    <div class="modal-title">Nueva tarjeta</div>
    <div class="form-group">
      <label class="form-label">Banco / Nombre</label>
      <input type="text" class="form-input" id="card-bank" placeholder="Ej: Visa Galicia, Mastercard BBVA...">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Últimos 4 dígitos</label>
        <input type="text" class="form-input" id="card-digits" placeholder="1234" maxlength="4">
      </div>
      <div class="form-group">
        <label class="form-label">Límite</label>
        <input type="number" class="form-input" id="card-limit" placeholder="0" min="0">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Cierre (día del mes)</label>
      <input type="number" class="form-input" id="card-close-day" placeholder="Ej: 15" min="1" max="31">
    </div>
    <div class="form-group">
      <label class="form-label">Color</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <div onclick="selectCardColor(this,'#2d2d3a')" style="width:32px;height:32px;border-radius:8px;background:#2d2d3a;cursor:pointer;border:2px solid #E8C547"></div>
        <div onclick="selectCardColor(this,'#1a3a5c')" style="width:32px;height:32px;border-radius:8px;background:#1a3a5c;cursor:pointer"></div>
        <div onclick="selectCardColor(this,'#2d4a3e')" style="width:32px;height:32px;border-radius:8px;background:#2d4a3e;cursor:pointer"></div>
        <div onclick="selectCardColor(this,'#4a2d2d')" style="width:32px;height:32px;border-radius:8px;background:#4a2d2d;cursor:pointer"></div>
        <div onclick="selectCardColor(this,'#3a2d4a')" style="width:32px;height:32px;border-radius:8px;background:#3a2d4a;cursor:pointer"></div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="FZ_closeModal('add-card')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveCard()">Guardar tarjeta</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-cuota">
  <div class="modal">
    <div class="modal-title">Añadir cuota pendiente</div>
    <div class="form-group">
      <label class="form-label">Descripción</label>
      <input type="text" class="form-input" id="cuota-desc" placeholder="Ej: Televisor, Viaje...">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Importe por cuota</label>
        <input type="number" class="form-input" id="cuota-amount" placeholder="50.00" min="0" step="0.01">
      </div>
      <div class="form-group">
        <label class="form-label">Cuotas restantes</label>
        <input type="number" class="form-input" id="cuota-remaining" placeholder="12" min="1">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Día de cobro</label>
      <input type="number" class="form-input" id="cuota-day" placeholder="15" min="1" max="31">
    </div>
    <div class="form-actions">
      <button class="btn btn-ghost" style="flex:1" onclick="FZ_closeModal('cuota')">Cancelar</button>
      <button class="btn btn-primary" style="flex:2" onclick="FZ_saveCuota()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL VEHICULO -->
<div class="modal-overlay" id="modal-vehiculo">
  <div class="modal">
    <div class="modal-title">Gasto de vehículo</div>
    <div class="form-group">
      <label class="form-label">Tipo</label>
      <select class="form-input" id="veh-type">
        <option value="gasolina">⛽ Gasolina / Diesel</option>
        <option value="seguro">🛡️ Seguro</option>
        <option value="revision">🔧 Revisión / Taller</option>
        <option value="itv">🔍 ITV</option>
        <option value="aparcamiento">🅿️ Aparcamiento / Peaje</option>
        <option value="multa">🚨 Multa</option>
        <option value="otro">📦 Otro</option>
      </select>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Importe</label>
        <input type="number" class="form-input" id="veh-amount" placeholder="50.00" min="0" step="0.01">
      </div>
      <div class="form-group">
        <label class="form-label">Fecha</label>
        <input type="date" class="form-input" id="veh-date">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Notas (opcional)</label>
      <input type="text" class="form-input" id="veh-notes" placeholder="Ej: Full tank 45L, Taller Pepe...">
    </div>
    <div class="form-actions">
      <button class="btn btn-ghost" style="flex:1" onclick="FZ_closeModal('vehiculo')">Cancelar</button>
      <button class="btn btn-primary" style="flex:2" onclick="FZ_saveVehiculo()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL META -->
<div class="modal-overlay" id="modal-meta">
  <div class="modal">
    <div class="modal-title">Nueva meta de ahorro</div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Nombre</label>
        <input type="text" class="form-input" id="meta-name" placeholder="Vacaciones, Coche...">
      </div>
      <div class="form-group">
        <label class="form-label">Icono</label>
        <input type="text" class="form-input" id="meta-icon" placeholder="🏖️" maxlength="4">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Objetivo</label>
        <input type="number" class="form-input" id="meta-target" placeholder="3000" min="0">
      </div>
      <div class="form-group">
        <label class="form-label">Ya ahorrado</label>
        <input type="number" class="form-input" id="meta-saved" placeholder="0" min="0">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Fecha objetivo</label>
      <input type="date" class="form-input" id="meta-date">
    </div>
    <div class="form-actions">
      <button class="btn btn-ghost" style="flex:1" onclick="FZ_closeModal('meta')">Cancelar</button>
      <button class="btn btn-primary" style="flex:2" onclick="FZ_saveMeta()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL PRESUPUESTO -->
<div class="modal-overlay" id="modal-presupuesto">
  <div class="modal">
    <div class="modal-title">Límites de presupuesto</div>
    <div id="budget-form" style="max-height:60vh;overflow-y:auto"></div>
    <div class="form-actions">
      <button class="btn btn-ghost" style="flex:1" onclick="FZ_closeModal('presupuesto')">Cancelar</button>
      <button class="btn btn-primary" style="flex:2" onclick="FZ_saveBudgets()">Guardar</button>
    </div>
  </div>
</div>
</div>

<script>

// ── SUPABASE CONFIG ──
const SUPA_URL = 'https://ilhlcwesmkaycekbnamm.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsaGxjd2VzbWtheWNla2JuYW1tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2OTYxOTMsImV4cCI6MjA4NzI3MjE5M30.N7TAeoiAIEg-KBTjKeBpFmSUQz58XiZdlF-cdnSnTyE';

async function supaFetch(path, options={}) {
  const res = await fetch(SUPA_URL + path, {
    ...options,
    headers: {
      'apikey': SUPA_KEY,
      'Authorization': 'Bearer ' + (getSession()?.access_token || SUPA_KEY),
      'Content-Type': 'application/json',
      'Prefer': 'return=representation',
      ...(options.headers || {})
    }
  });
  const data = await res.json();
  return { data, error: res.ok ? null : data };
}

// ── SESSION ──
function getSession() {
  try { return JSON.parse(localStorage.getItem('ems_session') || 'null'); } catch { return null; }
}
function setSession(s) { localStorage.setItem('ems_session', JSON.stringify(s)); }
function clearSession() { localStorage.removeItem('ems_session'); localStorage.removeItem('ems_usuario'); }

function getCachedUser() {
  try { return JSON.parse(localStorage.getItem('ems_usuario') || 'null'); } catch { return null; }
}
function setCachedUser(u) { localStorage.setItem('ems_usuario', JSON.stringify(u)); }

// ── UI HELPERS ──
function showLayer(id) {
  ['layer-auth','layer-choose','layer-expired'].forEach(l => {
    document.getElementById(l).classList.remove('show');
  });
  document.getElementById('app-bar').classList.remove('show');
  document.getElementById('mod-agenda').classList.remove('show');
  document.getElementById('mod-finanzas').classList.remove('show');
  if (['auth','choose','expired'].includes(id)) {
    document.getElementById('layer-' + id).classList.add('show');
  }
}

function switchTab(t) {
  document.querySelectorAll('.atab').forEach((el,i) => el.classList.toggle('on',(i===0&&t==='login')||(i===1&&t==='reg')));
  document.getElementById('f-login').style.display = t==='login'?'block':'none';
  document.getElementById('f-reg').style.display = t==='reg'?'block':'none';
}

function showMsg(msg, color) {
  let el = document.getElementById('auth-msg');
  if (!el) {
    el = document.createElement('div');
    el.id = 'auth-msg';
    el.style.cssText = 'text-align:center;font-size:.8rem;padding:8px;border-radius:8px;margin-top:10px';
    document.querySelector('.auth-box').appendChild(el);
  }
  el.textContent = msg;
  el.style.background = color === 'red' ? 'rgba(232,112,71,.15)' : 'rgba(107,191,122,.15)';
  el.style.color = color === 'red' ? '#E87047' : '#6BBF7A';
}

function cap(s) { return s ? s.charAt(0).toUpperCase()+s.slice(1) : ''; }

// ── AUTH ──
async function doLogin() {
  const email = document.getElementById('l-email').value.trim();
  const pass = document.getElementById('l-pass').value;
  if (!email || !pass) { showMsg('Completá email y contraseña', 'red'); return; }
  
  const btn = document.querySelector('#f-login .bp');
  btn.textContent = 'Entrando...'; btn.disabled = true;
  
  const res = await fetch(SUPA_URL + '/auth/v1/token?grant_type=password', {
    method: 'POST',
    headers: { 'apikey': SUPA_KEY, 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password: pass })
  });
  const data = await res.json();
  btn.textContent = 'Entrar →'; btn.disabled = false;
  
  if (!res.ok) { showMsg('Email o contraseña incorrectos', 'red'); return; }
  
  setSession(data);
  await loadAndEnterApp(data.user.id, data.access_token);
}

async function doRegister() {
  const name = document.getElementById('r-name').value.trim();
  const email = document.getElementById('r-email').value.trim();
  const pass = document.getElementById('r-pass').value;
  if (!name || !email || !pass) { showMsg('Completá todos los campos', 'red'); return; }
  if (pass.length < 8) { showMsg('La contraseña debe tener al menos 8 caracteres', 'red'); return; }
  
  const btn = document.querySelector('#f-reg .bp');
  btn.textContent = 'Creando cuenta...'; btn.disabled = true;

  try {
    // 1. Crear usuario en Auth
    const res = await fetch(SUPA_URL + '/auth/v1/signup', {
      method: 'POST',
      headers: { 'apikey': SUPA_KEY, 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password: pass })
    });
    const data = await res.json();

    if (!res.ok) {
      btn.textContent = 'Crear cuenta →'; btn.disabled = false;
      showMsg(data.error_description || data.message || 'Error al crear cuenta', 'red');
      return;
    }

    // 2. Hacer login inmediato para obtener sesión válida
    const loginRes = await fetch(SUPA_URL + '/auth/v1/token?grant_type=password', {
      method: 'POST',
      headers: { 'apikey': SUPA_KEY, 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password: pass })
    });
    const loginData = await loginRes.json();
    btn.textContent = 'Crear cuenta →'; btn.disabled = false;

    if (!loginRes.ok) {
      showMsg('Cuenta creada. Iniciá sesión con tu email y contraseña.', 'green');
      switchTab('login');
      document.getElementById('l-email').value = email;
      return;
    }

    setSession(loginData);

    // 3. Crear perfil en tabla usuarios con token válido
    const expiry = new Date();
    expiry.setFullYear(expiry.getFullYear() + 1);
    const usuario = {
      id: loginData.user.id,
      email,
      nombre: name,
      modulos: { agenda: false, finanzas: false, alimentacion: false },
      expiry: expiry.toISOString().split('T')[0]
    };

    await fetch(SUPA_URL + '/rest/v1/usuarios', {
      method: 'POST',
      headers: {
        'apikey': SUPA_KEY,
        'Authorization': 'Bearer ' + loginData.access_token,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      },
      body: JSON.stringify(usuario)
    });

    setCachedUser(usuario);
    enterApp(usuario);

  } catch(e) {
    btn.textContent = 'Crear cuenta →'; btn.disabled = false;
    showMsg('Error de conexión: ' + e.message, 'red');
  }
}

async function loadAndEnterApp(userId, token) {
  const { data } = await supaFetch('/rest/v1/usuarios?id=eq.' + userId + '&select=*');
  if (!data || !data[0]) { showMsg('No encontramos tu perfil. Contactá soporte.', 'red'); return; }
  const usuario = data[0];
  setCachedUser(usuario);
  enterApp(usuario);
}

function doLogout() {
  clearSession();
  showLayer('auth');
}

function enterApp(usuario) {
  const exp = new Date(usuario.expiry);
  const now = new Date();
  
  if (exp < now) {
    document.getElementById('exp-date').textContent = exp.toLocaleDateString('es-AR',{day:'numeric',month:'long',year:'numeric'});
    showLayer('expired'); return;
  }
  
  document.getElementById('ch-greet').textContent = 'Hola, ' + usuario.nombre + ' 👋';
  document.getElementById('ch-expiry').textContent = exp.toLocaleDateString('es-AR',{day:'numeric',month:'long',year:'numeric'});
  
  const mods = usuario.modulos || {};
  setBadge('btn-mod-ag', 'badge-ag', mods.agenda);
  setBadge('btn-mod-fi', 'badge-fi', mods.finanzas);
  
  const days = Math.ceil((exp-now)/(864e5));
  const ab = document.getElementById('app-acc-badge');
  ab.textContent = days > 60 ? '✓ Activo' : '⚠ '+days+'d';
  ab.className = 'abadge ' + (days > 60 ? 'ok' : 'warn');
  
  showLayer('choose');
}

function setBadge(btnId, badgeId, active) {
  const btn = document.getElementById(btnId);
  const badge = document.getElementById(badgeId);
  if (!active) {
    btn.classList.add('locked');
    badge.textContent = '🔒 No incluido';
    badge.className = 'mbadge no';
  } else {
    btn.classList.remove('locked');
    badge.textContent = 'Activo ✓';
    badge.className = 'mbadge ok';
  }
}

function openModule(mod) {
  const usuario = getCachedUser();
  if (!usuario || !usuario.modulos || !usuario.modulos[mod]) {
    if(confirm('Este módulo no está en tu plan.\n\n¿Querés agregarlo?')) window.open('https://gumroad.com','_blank');
    return;
  }
  showLayer('none');
  document.getElementById('app-bar').classList.add('show');
  document.getElementById('mod-' + mod).classList.add('show');
  if (mod === 'agenda' && window.startAgenda) window.startAgenda();
  if (mod === 'finanzas' && window.startFinanzas) window.startFinanzas();
}

function goHome() {
  document.getElementById('app-bar').classList.remove('show');
  document.getElementById('mod-agenda').classList.remove('show');
  document.getElementById('mod-finanzas').classList.remove('show');
  showLayer('choose');
}

function showSoon() { alert('🥗 Alimentación está en desarrollo. Te avisamos cuando esté listo.'); }

// ── AUTO-LOGIN ──
document.addEventListener('DOMContentLoaded', async () => {
  const session = getSession();
  const cached = getCachedUser();
  if (session && cached) {
    // Verificar que el token no expiró
    const exp = session.expires_at;
    if (exp && Date.now() / 1000 < exp) {
      enterApp(cached);
      // Refrescar perfil en background
      loadAndEnterApp(session.user.id, session.access_token).catch(() => {});
      return;
    }
  }
  clearSession();
  showLayer('auth');
});


// ── CLOUD SYNC ──
const SYNC_DEBOUNCE = {};

async function cloudSave(tabla, key, valor) {
  const session = getSession();
  if (!session) return;
  const userId = session.user.id;
  const token = session.access_token;
  
  try {
    await fetch(SUPA_URL + '/rest/v1/' + tabla, {
      method: 'POST',
      headers: {
        'apikey': SUPA_KEY,
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json',
        'Prefer': 'resolution=merge-duplicates'
      },
      body: JSON.stringify(
        tabla === 'datos_agenda' 
          ? { user_id: userId, key: key, valor: valor, updated_at: new Date().toISOString() }
          : { user_id: userId, valor: valor, updated_at: new Date().toISOString() }
      )
    });
  } catch(e) {
    // Fallo silencioso - los datos ya están en localStorage
  }
}

function cloudSaveDebounced(tabla, key, valor) {
  const dKey = tabla + '_' + key;
  clearTimeout(SYNC_DEBOUNCE[dKey]);
  SYNC_DEBOUNCE[dKey] = setTimeout(() => cloudSave(tabla, key, valor), 1500);
}

async function cloudLoadAgenda() {
  const session = getSession();
  if (!session) return;
  try {
    const res = await fetch(SUPA_URL + '/rest/v1/datos_agenda?user_id=eq.' + session.user.id + '&select=key,valor', {
      headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + session.access_token }
    });
    const rows = await res.json();
    if (Array.isArray(rows)) {
      rows.forEach(row => {
        localStorage.setItem('ems_ag_' + row.key, JSON.stringify(row.valor));
      });
    }
  } catch(e) {}
}

async function cloudLoadFinanzas() {
  const session = getSession();
  if (!session) return;
  try {
    const res = await fetch(SUPA_URL + '/rest/v1/datos_finanzas?user_id=eq.' + session.user.id + '&select=valor', {
      headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + session.access_token }
    });
    const rows = await res.json();
    if (Array.isArray(rows) && rows[0]) {
      localStorage.setItem('fz_v2', JSON.stringify(rows[0].valor));
    }
  } catch(e) {}
}

</script>

<script>// ══════ DATA ══════
const S = {
  g(k,d){try{const v=localStorage.getItem('ems_ag_'+k);return v?JSON.parse(v):d}catch{return d}},
  s(k,v){try{localStorage.setItem('ems_ag_'+k,JSON.stringify(v));if(window.cloudSaveDebounced)cloudSaveDebounced('datos_agenda',k,v);}catch{}}
};

const TODAY = new Date();
const fmt   = d=>d.toISOString().split('T')[0];
const DIAS  = ['L','M','X','J','V','S','D'];
const DIAS_F= ['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado','Domingo'];
const MESES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const M_SHORT=['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];

function toast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2200);
}
function fmtDate(s){
  if(!s)return'';
  const d=new Date(s+'T12:00:00');
  return d.getDate()+' '+M_SHORT[d.getMonth()];
}
function getMonday(d){
  const c=new Date(d);const day=c.getDay();
  const diff=day===0?-6:1-day;c.setDate(c.getDate()+diff);return c;
}

// ══════ ONBOARDING ══════
let obStep=0;
function FZ_obNext(){
  if(obStep===0){obStep=1;showOb(1);return}
  if(obStep===1){
    const n=document.getElementById('obName').value.trim();
    const w=document.getElementById('obWord').value.trim();
    if(n){S.s('userName',n);S.s('userWord',w||'');}
    obStep=2;showOb(2);return;
  }
}
function showOb(i){
  document.querySelectorAll('.ob-step').forEach((s,j)=>{s.classList.toggle('active',j===i)});
  document.querySelectorAll('.ob-dot').forEach((d,j)=>{d.classList.toggle('active',j===i)});
}
function FZ_obFinish(){
  document.getElementById('onboarding').style.display='none';
  document.getElementById('app').classList.add('visible');
  initApp();
}

// check if already onboarded
window.startAgenda = async function() {
  await cloudLoadAgenda();
  renderPomoTime();
  renderPomoStats();
  document.getElementById('evDate').value=fmt(TODAY);
  document.getElementById('txFecha').value=fmt(TODAY);
  document.getElementById('dFecha').value=fmt(TODAY);
  if(S.g('onboarded',false)){
    document.getElementById('onboarding').style.display='none';
    document.getElementById('app').classList.add('visible');
    initApp();
  }
};

// ══════ INIT ══════
function initApp(){
  S.s('onboarded',true);
  initYearProg();
  initTopBar();
  renderHome();
  renderMetas();
  renderHabitos();
  renderSemana();
  renderMes();
  renderPresupuesto();
  renderViajes();
  renderRutina();
  renderWishlist();
  renderDiario();
  renderVision();
  // nav tabs click
  document.querySelectorAll('.nav-tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
      const p=tab.dataset.page;
      document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      showPage(p);
    });
  });
}

// ══════ YEAR PROGRESS ══════
function initYearProg(){
  const start=new Date(TODAY.getFullYear(),0,1);
  const end  =new Date(TODAY.getFullYear(),11,31);
  const pct  =Math.round((TODAY-start)/(end-start)*100);
  const days =Math.ceil((end-TODAY)/86400000);
  document.getElementById('ypLabel').textContent=pct+'%';
  document.getElementById('ypBar').style.width=pct+'%';
  document.getElementById('ypDays').textContent=days+' días';
}

function initTopBar(){
  const n=S.g('userName','');
  document.getElementById('topUser').textContent=n?'Hola, '+n+' ✦':'✦ 2025';
}

// ══════ NAVIGATION ══════
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  if(id==='home')renderHome();
  if(id==='semana')renderSemana();
  if(id==='mes')renderMes();
  if(id==='presupuesto')renderPresupuesto();
  if(id==='viajes')renderViajes();
  if(id==='rutina')renderRutina();
  if(id==='wishlist')renderWishlist();
  if(id==='diario')renderDiario();
  if(id==='vision')renderVision();
  if(id==='stats')renderStats();
  if(id==='review')renderReview();
  if(id==='pomodoro')renderPomoStats();
}

function navTo(id,el){
  document.querySelectorAll('.bnav-item').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  // sync top nav
  document.querySelectorAll('.nav-tab').forEach(t=>{
    t.classList.toggle('active',t.dataset.page===id);
  });
  showPage(id);
}

// ══════ HOME ══════
function renderHome(){
  const n=S.g('userName','');
  const w=S.g('userWord','');
  document.getElementById('homeGreet').textContent=n?'Hola, '+n+' ✦':'Agenda Pro ✦';
  document.getElementById('homeWord').textContent=w?'✦ Tu palabra del año: "'+w+'"':'Definí tu visión anual en la sección Visión.';

  const metas=S.g('metas',[]);
  const habitos=S.g('habitos',[]);
  const tareas=S.g('tareas',[]);
  const viajes=S.g('viajes',[]);
  const events=S.g('events',[]);

  document.getElementById('kMetas').textContent=metas.filter(m=>m.pct<100).length;
  document.getElementById('kTareas').textContent=tareas.filter(t=>!t.done).length;
  document.getElementById('kViajes').textContent=viajes.filter(v=>v.estado!=='🏡 Completado').length;

  const todayDow=(TODAY.getDay()+6)%7;
  let hdone=0;
  habitos.forEach(h=>{if(h.days&&h.days[todayDow])hdone++;});
  const hpct=habitos.length?Math.round(hdone/habitos.length*100):0;
  document.getElementById('kHabitos').textContent=hpct+'%';

  // Top metas
  const pm=document.getElementById('homeMetasPreview');
  const top=metas.filter(m=>m.pct<100).sort((a,b)=>{
    const p={'🔴 Alta':0,'🟡 Media':1,'🟢 Baja':2};
    return (p[a.prio]||1)-(p[b.prio]||1);
  }).slice(0,3);
  pm.innerHTML=top.length?top.map(m=>`
    <div class="meta-card" style="margin-bottom:10px">
      <div class="meta-top">
        <div><div class="meta-name">${m.nombre}</div><div class="meta-area">${m.area}</div></div>
        <div class="meta-pct-big">${m.pct}%</div>
      </div>
      <div class="prog-bar"><div class="prog-fill" style="width:${m.pct}%"></div></div>
    </div>`).join(''):'<div class="empty"><div class="empty-icon">◎</div><div class="empty-text">No hay metas activas.</div></div>';

  // Hábitos hoy
  const ph=document.getElementById('homeHabitosPreview');
  ph.innerHTML=habitos.length?habitos.slice(0,4).map((h,i)=>{
    const done=h.days&&h.days[todayDow];
    return`<div class="item">
      <div class="check ${done?'done':''}" onclick="toggleHabitDay(${i},${todayDow});renderHome()">${done?'✓':''}</div>
      <div class="item-body"><div class="item-title ${done?'done':''}">${h.emoji} ${h.name}</div><div class="item-meta">${h.meta}</div></div>
    </div>`;
  }).join(''):'<div class="empty"><div class="empty-icon">◐</div><div class="empty-text">Sin hábitos configurados.</div></div>';

  // Próximos eventos
  const pe=document.getElementById('homeEventosPreview');
  const todayStr=fmt(TODAY);
  const upcoming=events.filter(e=>e.date>=todayStr).sort((a,b)=>a.date.localeCompare(b.date)).slice(0,3);
  pe.innerHTML=upcoming.length?upcoming.map(e=>`
    <div class="item">
      <div class="item-body">
        <div class="item-title">${e.type} ${e.title}</div>
        <div class="item-meta">${fmtDate(e.date)}</div>
      </div>
    </div>`).join(''):'<div class="empty"><div class="empty-icon">◫</div><div class="empty-text">Sin eventos próximos.</div></div>';
}

// ══════ METAS ══════
let metaFilter='todas';
function FZ_setMetaFilter(f,el){
  metaFilter=f;
  document.querySelectorAll('#metaTabsEl .inner-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  renderMetas();
}
function FZ_addMeta(){
  const n=document.getElementById('mNombre').value.trim();if(!n)return;
  const metas=S.g('metas',[]);
  metas.push({
    nombre:n,area:document.getElementById('mArea').value,
    prio:document.getElementById('mPrio').value,
    fecha:document.getElementById('mFecha').value,
    pct:parseInt(document.getElementById('mPct').value)||0,
    porque:document.getElementById('mPorque').value,
    id:Date.now()
  });
  S.s('metas',metas);
  ['mNombre','mFecha','mPorque'].forEach(i=>document.getElementById(i).value='');
  document.getElementById('mPct').value=0;
  renderMetas();toast('◎ Meta agregada');
}
function renderMetas(){
  const all=FZ_S.goals||[];
  const list=metaFilter==='todas'?all:all.filter(m=>m.area===metaFilter);
  const el=document.getElementById('metasList');
  if(!list.length){el.innerHTML='<div class="empty"><div class="empty-icon">◎</div><div class="empty-text">No hay metas en esta categoría.</div></div>';return;}
  el.innerHTML=list.map(m=>{
    const i=all.indexOf(m);
    const c=m.pct>=80?'green':m.pct>=40?'':'red';
    return`<div class="meta-card">
      <div class="meta-top">
        <div>
          <div class="meta-name">${m.nombre}</div>
          <div class="meta-area">${m.area} · ${m.prio}${m.fecha?' · '+fmtDate(m.fecha):''}</div>
          ${m.porque?`<div style="font-size:11px;color:var(--text3);margin-top:4px;font-style:italic">💡 ${m.porque}</div>`:''}
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
          <div class="meta-pct-big">${m.pct}%</div>
          <button class="del-btn" onclick="FZ_delMeta(${i})">🗑</button>
        </div>
      </div>
      <div class="prog-bar"><div class="prog-fill ${c}" style="width:${m.pct}%"></div></div>
      <input type="range" class="meta-slider" min="0" max="100" value="${m.pct}" oninput="updateMeta(${i},this.value)">
    </div>`;
  }).join('');
}
function updateMeta(i,v){
  const m=S.g('metas',[]);m[i].pct=parseInt(v);S.s('metas',m);renderMetas();
}
function FZ_delMeta(i){const m=S.g('metas',[]);m.splice(i,1);S.s('metas',m);renderMetas();toast('Meta eliminada');}

// ══════ HÁBITOS ══════
function addHabit(){
  const n=document.getElementById('hName').value.trim();if(!n)return;
  const h=S.g('habitos',[]);
  h.push({emoji:document.getElementById('hEmoji').value||'⭐',name:n,meta:document.getElementById('hMeta').value||'Diario',days:{}});
  S.s('habitos',h);
  ['hEmoji','hName','hMeta'].forEach(i=>document.getElementById(i).value='');
  renderHabitos();toast('◐ Hábito creado');
}
function toggleHabitDay(hi,di){
  const h=S.g('habitos',[]);if(!h[hi].days)h[hi].days={};
  h[hi].days[di]=!h[hi].days[di];S.s('habitos',h);renderHabitos();
}
function calcStreak(h){
  if(!h.days)return 0;
  let s=0;const d=(TODAY.getDay()+6)%7;
  for(let i=d;i>=0;i--){if(h.days[i])s++;else break;}
  return s;
}
function renderHabitos(){
  const h=S.g('habitos',[]);
  const el=document.getElementById('habitGrid');
  if(!h.length){el.innerHTML='<div class="empty"><div class="empty-icon">◐</div><div class="empty-text">Agregá tu primer hábito arriba.</div></div>';return;}
  const todayDow=(TODAY.getDay()+6)%7;
  el.innerHTML=h.map((hab,i)=>`
    <div class="habit-row">
      <div class="habit-top">
        <div class="habit-emoji">${hab.emoji}</div>
        <div class="habit-info">
          <div class="habit-name">${hab.name}</div>
          <div class="habit-streak">🔥 ${calcStreak(hab)} días · ${hab.meta}</div>
        </div>
        <button class="del-btn" onclick="delHabit(${i})">🗑</button>
      </div>
      <div class="habit-days">
        ${DIAS.map((d,di)=>`<div class="hday ${hab.days&&hab.days[di]?'done':''} ${di===todayDow?'today':''}" onclick="toggleHabitDay(${i},${di})">${d}</div>`).join('')}
      </div>
    </div>`).join('');
}
function delHabit(i){const h=S.g('habitos',[]);h.splice(i,1);S.s('habitos',h);renderHabitos();}

// ══════ SEMANA ══════
function renderSemana(){
  const monday=getMonday(TODAY);
  const sunday=new Date(monday);sunday.setDate(monday.getDate()+6);
  document.getElementById('weekRangeLabel').textContent=
    monday.toLocaleDateString('es-AR',{day:'numeric',month:'long'})+' — '+
    sunday.toLocaleDateString('es-AR',{day:'numeric',month:'long',year:'numeric'});
  const tareas=S.g('tareas',[]);
  const el=document.getElementById('semanaGrid');
  el.innerHTML=DIAS_F.map((dia,di)=>{
    const ts=tareas.filter(t=>t.dia===di);
    return`<div style="margin-bottom:12px">
      <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;padding-left:4px">${dia}</div>
      <div style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--r2);min-height:60px;padding:8px">
        ${ts.length?ts.map((t,i)=>{
          const ri=tareas.indexOf(t);
          const col=t.prio==='Alta'?'var(--red)':'var(--gold3)';
          return`<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);cursor:pointer" onclick="toggleTarea(${ri})">
            <div style="width:4px;height:4px;border-radius:50%;background:${col};flex-shrink:0"></div>
            <span style="font-size:12px;flex:1;${t.done?'text-decoration:line-through;color:var(--text3)':'color:var(--cream)'}">${t.title}</span>
            <button class="del-btn btn-sm" onclick="event.stopPropagation();delTarea(${ri})" style="font-size:11px">✕</button>
          </div>`;
        }).join(''):`<div style="color:var(--text3);font-size:11px;padding:4px">Vacío</div>`}
      </div>
    </div>`;
  }).join('');
  const r=S.g('reflexion',{});
  if(r.victorias)document.getElementById('refVictorias').value=r.victorias;
  if(r.mejoras)document.getElementById('refMejoras').value=r.mejoras;
}
function addTarea(){
  const t=document.getElementById('tTitle').value.trim();if(!t)return;
  const ts=S.g('tareas',[]);
  ts.push({title:t,dia:parseInt(document.getElementById('tDia').value),prio:document.getElementById('tPrio').value,done:false});
  S.s('tareas',ts);document.getElementById('tTitle').value='';
  renderSemana();toast('▦ Tarea agregada');
}
function toggleTarea(i){const t=S.g('tareas',[]);t[i].done=!t[i].done;S.s('tareas',t);renderSemana();}
function delTarea(i){const t=S.g('tareas',[]);t.splice(i,1);S.s('tareas',t);renderSemana();}
function saveRef(){
  S.s('reflexion',{victorias:document.getElementById('refVictorias').value,mejoras:document.getElementById('refMejoras').value});
  toast('✦ Reflexión guardada');
}

// ══════ CALENDARIO ══════
let calY=TODAY.getFullYear(),calM=TODAY.getMonth();
function FZ_changeMonth(d){
  calM+=d;if(calM<0){calM=11;calY--;}if(calM>11){calM=0;calY++;}
  renderMes();
}
function renderMes(){
  document.getElementById('calMonthLabel').textContent=MESES[calM]+' '+calY;
  const events=S.g('events',[]);
  const first=new Date(calY,calM,1);
  const last =new Date(calY,calM+1,0);
  let startDow=(first.getDay()+6)%7;
  let html=['L','M','X','J','V','S','D'].map(d=>`<div class="cal-dow">${d}</div>`).join('');
  for(let i=0;i<startDow;i++)html+=`<div class="cal-day other"></div>`;
  for(let d=1;d<=last.getDate();d++){
    const ds=`${calY}-${String(calM+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isT=d===TODAY.getDate()&&calM===TODAY.getMonth()&&calY===TODAY.getFullYear();
    const hasE=events.some(e=>e.date===ds);
    html+=`<div class="cal-day ${isT?'today':''} ${hasE?'has-ev':''}" title="${hasE?events.filter(e=>e.date===ds).map(e=>e.title).join(', '):''}">${d}</div>`;
  }
  document.getElementById('calGrid').innerHTML=html;

  const monthEvs=events.filter(e=>{const d=new Date(e.date+'T12:00:00');return d.getFullYear()===calY&&d.getMonth()===calM;}).sort((a,b)=>a.date.localeCompare(b.date));
  document.getElementById('evList').innerHTML=monthEvs.map((e,i)=>{
    const ri=events.indexOf(e);
    return`<li class="item">
      <div class="item-body"><div class="item-title">${e.type} ${e.title}</div><div class="item-meta">${fmtDate(e.date)}</div></div>
      <button class="del-btn" onclick="delEvent(${ri})">🗑</button>
    </li>`;
  }).join('')||'<li class="item"><div class="item-meta" style="padding:12px 0">Sin eventos este mes</div></li>';
}
function addEvent(){
  const t=document.getElementById('evTitle').value.trim();if(!t)return;
  const dt=document.getElementById('evDate').value;if(!dt){toast('Ingresá una fecha');return;}
  const ev=S.g('events',[]);
  ev.push({title:t,date:dt,type:document.getElementById('evType').value});
  S.s('events',ev);document.getElementById('evTitle').value='';
  renderMes();toast('📅 Evento agregado');
}
function delEvent(i){const e=S.g('events',[]);e.splice(i,1);S.s('events',e);renderMes();}

// ══════ PRESUPUESTO ══════
let budgetTab='add';
function FZ_setBudgetTab(t,el){
  budgetTab=t;
  document.querySelectorAll('#page-presupuesto .inner-tab').forEach(x=>x.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('budgetAdd').style.display=t==='add'?'block':'none';
  document.getElementById('budgetHist').style.display=t==='hist'?'block':'none';
  if(t==='hist')renderTxList();
}
function addTx(){
  const desc=document.getElementById('txDesc').value.trim();if(!desc)return;
  const monto=parseFloat(document.getElementById('txMonto').value)||0;if(!monto)return;
  const txs=S.g('txs',[]);
  txs.push({desc,monto,tipo:document.getElementById('txTipo').value,cat:document.getElementById('txCat').value,fecha:document.getElementById('txFecha').value,id:Date.now()});
  S.s('txs',txs);
  ['txDesc','txMonto'].forEach(i=>document.getElementById(i).value='');
  renderPresupuesto();toast('💰 Transacción registrada');
}
function renderPresupuesto(){
  document.getElementById('budgetMonthLabel').textContent=MONTHS[curMonth]+' '+curYear;
  const txs=FZ_S.transactions||[];
  const m=curMonth,y=curYear;
  const month=txs.filter(t=>{const d=new Date(t.date+'T12:00:00');return d.getMonth()===m&&d.getFullYear()===y;});
  const ing=month.filter(t=>t.type==='ingreso').reduce((s,t)=>s+t.amount,0);
  const gas=month.filter(t=>t.type==='gasto').reduce((s,t)=>s+t.amount,0);
  const bal=ing-gas;
  document.getElementById('bIng').textContent='$'+ing.toLocaleString('es-AR');
  document.getElementById('bGas').textContent='$'+gas.toLocaleString('es-AR');
  document.getElementById('bBalance').textContent='$'+Math.abs(bal).toLocaleString('es-AR');
  document.getElementById('bBalance').style.color=bal>=0?'var(--green)':'var(--red)';
  const pct=ing?Math.min(100,Math.round(gas/ing*100)):0;
  document.getElementById('bProg').style.width=pct+'%';
  document.getElementById('bProg').className='prog-fill '+(pct>80?'red':pct>60?'':'green');
}
function renderTxList(){
  const txs=S.g('txs',[]).slice().reverse();
  const el=document.getElementById('txList');
  if(!txs.length){el.innerHTML='<div class="empty"><div class="empty-icon">◈</div><div class="empty-text">Sin transacciones registradas.</div></div>';return;}
  el.innerHTML='<div class="card">'+txs.slice(0,20).map((t,i)=>`
    <div class="tx-row">
      <div class="tx-icon" style="background:${t.tipo==='ing'?'#122018':'#201210'}">${t.cat.split(' ')[0]}</div>
      <div class="tx-body"><div class="tx-desc">${t.desc}</div><div class="tx-cat">${t.cat} · ${fmtDate(t.fecha)}</div></div>
      <div class="tx-amount ${t.tipo==='ing'?'tx-pos':'tx-neg'}">${t.tipo==='ing'?'+':'-'}$${t.monto.toLocaleString('es-AR')}</div>
      <button class="del-btn" onclick="FZ_delTx(${txs.length-1-i})">🗑</button>
    </div>`).join('')+'</div>';
}
function FZ_delTx(i){const t=S.g('txs',[]);t.splice(i,1);S.s('txs',t);renderPresupuesto();renderTxList();}

// ══════ VIAJES ══════
function addViaje(){
  const d=document.getElementById('vDest').value.trim();if(!d)return;
  const vs=S.g('viajes',[]);
  const ida=document.getElementById('vIda').value;
  const vuelta=document.getElementById('vVuelta').value;
  let dias=0;
  if(ida&&vuelta){const a=new Date(ida),b=new Date(vuelta);dias=Math.max(0,Math.round((b-a)/86400000));}
  vs.push({dest:d,ida,vuelta,dias,presup:parseFloat(document.getElementById('vPresup').value)||0,estado:document.getElementById('vEstado').value,notas:document.getElementById('vNotas').value,gastado:0,id:Date.now()});
  S.s('viajes',vs);
  ['vDest','vIda','vVuelta','vPresup','vNotas'].forEach(i=>document.getElementById(i).value='');
  renderViajes();toast('✈️ Viaje agregado');
}
function renderViajes(){
  const vs=S.g('viajes',[]);
  const el=document.getElementById('viajesList');
  if(!vs.length){el.innerHTML='<div class="empty"><div class="empty-icon">✈️</div><div class="empty-text">Todavía no planificaste ningún viaje.</div></div>';return;}
  el.innerHTML=vs.map((v,i)=>{
    const pct=v.presup?Math.min(100,Math.round(v.gastado/v.presup*100)):0;
    return`<div class="viaje-card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div class="viaje-dest">✈️ ${v.dest}</div>
          <div class="viaje-dates">${v.ida?fmtDate(v.ida):''} ${v.vuelta?'→ '+fmtDate(v.vuelta):''}</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="chip chip-gold" style="font-size:9px">${v.estado}</span>
          <button class="del-btn" onclick="delViaje(${i})">🗑</button>
        </div>
      </div>
      <div class="viaje-stats">
        <div class="viaje-stat"><div class="viaje-stat-val">${v.dias||'?'}</div><div class="viaje-stat-label">Días</div></div>
        <div class="viaje-stat"><div class="viaje-stat-val">$${(v.presup||0).toLocaleString('es-AR')}</div><div class="viaje-stat-label">Presupuesto</div></div>
        <div class="viaje-stat"><div class="viaje-stat-val">${pct}%</div><div class="viaje-stat-label">Gastado</div></div>
      </div>
      ${v.presup?`<div class="prog-wrap"><div class="prog-bar"><div class="prog-fill ${pct>80?'red':''}" style="width:${pct}%"></div></div></div>`:''}
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <label class="form-label" style="margin:0;white-space:nowrap">Gastado:</label>
        <input type="number" style="flex:1;padding:6px 10px;background:var(--bg4);border:1px solid var(--border);border-radius:6px;color:var(--cream);font-size:12px" value="${v.gastado||0}" onchange="updateGastado(${i},this.value)">
      </div>
      ${v.notas?`<div style="margin-top:10px;font-size:12px;color:var(--text2);line-height:1.5;white-space:pre-wrap">${v.notas}</div>`:''}
    </div>`;
  }).join('');
}
function updateGastado(i,v){const vs=S.g('viajes',[]);vs[i].gastado=parseFloat(v)||0;S.s('viajes',vs);renderViajes();}
function delViaje(i){const v=S.g('viajes',[]);v.splice(i,1);S.s('viajes',v);renderViajes();}

// ══════ RUTINA ══════
let rutinaTab='man';
function setRutinaTab(t,el){
  rutinaTab=t;
  document.querySelectorAll('#rutinaTabsEl .inner-tab').forEach(x=>x.classList.remove('active'));
  el.classList.add('active');
  renderRutina();
}
function addRutina(){
  const n=document.getElementById('rNombre').value.trim();if(!n)return;
  const rs=S.g('rutina',[]);
  rs.push({emoji:document.getElementById('rEmoji').value||'⭐',nombre:n,hora:document.getElementById('rHora').value,tipo:document.getElementById('rTipo').value,done:false,id:Date.now()});
  S.s('rutina',rs);
  ['rEmoji','rNombre','rHora'].forEach(i=>document.getElementById(i).value='');
  renderRutina();toast('☀️ Paso agregado');
}
function toggleRutina(i){const r=S.g('rutina',[]);r[i].done=!r[i].done;S.s('rutina',r);renderRutina();}
function renderRutina(){
  const rs=S.g('rutina',[]).filter(r=>r.tipo===rutinaTab);
  const el=document.getElementById('rutinaContent');
  if(!rs.length){
    el.innerHTML=`<div class="empty"><div class="empty-icon">${rutinaTab==='man'?'☀️':'🌙'}</div><div class="empty-text">No hay pasos en tu rutina ${rutinaTab==='man'?'matutina':'nocturna'}.<br>Agregá el primero abajo.</div></div>`;
    return;
  }
  const all=S.g('rutina',[]);
  const done=rs.filter(r=>r.done).length;
  el.innerHTML=`
    <div style="text-align:right;margin-bottom:12px">
      <span style="font-family:'DM Mono',monospace;font-size:12px;color:var(--gold)">${done}/${rs.length} completados</span>
    </div>
    ${rs.map(r=>{
      const ri=all.indexOf(r);
      return`<div class="rutina-slot ${r.done?'done':''}" onclick="toggleRutina(${ri})">
        <div class="rutina-time">${r.hora||'—'}</div>
        <div class="rutina-emoji">${r.emoji}</div>
        <div class="rutina-name">${r.nombre}</div>
        <div class="rutina-check">${r.done?'✓':''}</div>
        <button class="del-btn" onclick="event.stopPropagation();delRutina(${ri})">🗑</button>
      </div>`;
    }).join('')}`;
}
function delRutina(i){const r=S.g('rutina',[]);r.splice(i,1);S.s('rutina',r);renderRutina();}

// ══════ WISHLIST ══════
function addWish(){
  const n=document.getElementById('wNombre').value.trim();if(!n)return;
  const ws=S.g('wishlist',[]);
  ws.push({emoji:document.getElementById('wEmoji').value||'✨',nombre:n,precio:parseFloat(document.getElementById('wPrecio').value)||0,cat:document.getElementById('wCat').value,done:false,id:Date.now()});
  S.s('wishlist',ws);
  ['wEmoji','wNombre','wPrecio'].forEach(i=>document.getElementById(i).value='');
  renderWishlist();toast('♡ Deseo agregado');
}
function toggleWish(i){const w=S.g('wishlist',[]);w[i].done=!w[i].done;S.s('wishlist',w);renderWishlist();}
function renderWishlist(){
  const ws=S.g('wishlist',[]);
  const el=document.getElementById('wishGrid');
  if(!ws.length){el.innerHTML='<div class="empty"><div class="empty-icon">♡</div><div class="empty-text">Tu wishlist está vacía.</div></div>';return;}
  el.innerHTML=ws.map((w,i)=>`
    <div class="wish-card" style="${w.done?'opacity:.6':''}">
      <div class="wish-emoji">${w.emoji}</div>
      <div class="wish-body">
        <div class="wish-name" style="${w.done?'text-decoration:line-through':''}">${w.nombre}</div>
        ${w.precio?`<div class="wish-price">$${w.precio.toLocaleString('es-AR')}</div>`:''}
        <div class="wish-cat">${w.cat}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
        <div class="wish-check ${w.done?'done':''}" onclick="toggleWish(${i})">${w.done?'✓':''}</div>
        <button class="del-btn" onclick="delWish(${i})">🗑</button>
      </div>
    </div>`).join('');
}
function delWish(i){const w=S.g('wishlist',[]);w.splice(i,1);S.s('wishlist',w);renderWishlist();}

// ══════ DIARIO ══════
function addNote(){
  const t=document.getElementById('dTexto').value.trim();if(!t)return;
  const ns=S.g('notas',[]);
  ns.push({fecha:document.getElementById('dFecha').value,animo:document.getElementById('dAnimo').value,texto:t,id:Date.now()});
  S.s('notas',ns);document.getElementById('dTexto').value='';
  renderDiario();toast('✎ Entrada guardada');
}
function renderDiario(){
  const ns=S.g('notas',[]).slice().reverse();
  const el=document.getElementById('notesList');
  if(!ns.length){el.innerHTML='<div class="empty"><div class="empty-icon">✎</div><div class="empty-text">Todavía no escribiste ninguna entrada.</div></div>';return;}
  const all=S.g('notas',[]);
  el.innerHTML=ns.map(n=>{
    const ri=all.slice().reverse().indexOf(n);
    return`<div class="note-card">
      <div class="note-header">
        <div class="note-date">${fmtDate(n.fecha)}</div>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="note-mood">${n.animo.split(' ')[0]}</div>
          <button class="del-btn" onclick="delNote(${all.length-1-ri})">🗑</button>
        </div>
      </div>
      <div class="note-text">${n.texto}</div>
    </div>`;
  }).join('');
}
function delNote(i){const n=S.g('notas',[]);n.splice(i,1);S.s('notas',n);renderDiario();}

// ══════ VISIÓN ══════
const AREAS=['🏋️ Salud & Energía','💼 Carrera & Trabajo','💰 Finanzas','💑 Relaciones','🧠 Aprendizaje','🎨 Desarrollo personal'];
function saveVision(){
  const v=S.g('vision',{});
  v.palabra=document.getElementById('vsPalabra').value;
  v.decl   =document.getElementById('vsDecl').value;
  S.s('vision',v);S.s('userWord',v.palabra);
  toast('✦ Visión guardada');
}
function renderVision(){
  const v=S.g('vision',{});
  if(v.palabra)document.getElementById('vsPalabra').value=v.palabra;
  if(v.decl)   document.getElementById('vsDecl').value=v.decl;
  const el=document.getElementById('vsAreas');
  el.innerHTML=AREAS.map((a,i)=>`
    <div class="card" style="padding:14px;margin-bottom:10px">
      <div class="card-title" style="margin-bottom:10px;font-size:13px">${a}</div>
      <input class="inp" style="margin:0" data-ai="${i}" placeholder="Mi meta en esta área es..." value="${v.areas&&v.areas[i]||''}" oninput="updateArea(${i},this.value)">
    </div>`).join('');
  renderLogros();
}
function updateArea(i,val){
  const v=S.g('vision',{});if(!v.areas)v.areas={};v.areas[i]=val;S.s('vision',v);
}
function renderLogros(){
  const ls=S.g('logros',[]);
  const el=document.getElementById('vsLogros');
  el.innerHTML=ls.map((l,i)=>`
    <div class="item">
      <div class="check ${l.done?'done':''}" onclick="toggleLogro(${i})">${l.done?'✓':''}</div>
      <div class="item-body"><div class="item-title ${l.done?'done':''}">${l.text}</div></div>
      <button class="del-btn" onclick="delLogro(${i})">🗑</button>
    </div>`).join('')||'<div class="empty" style="padding:16px"><div class="empty-text">Agregá tus logros soñados para diciembre.</div></div>';
}
function addLogro(){
  const t=document.getElementById('vsLogroInput').value.trim();if(!t)return;
  const l=S.g('logros',[]);l.push({text:t,done:false});
  S.s('logros',l);document.getElementById('vsLogroInput').value='';
  renderLogros();toast('◫ Logro agregado');
}
function toggleLogro(i){const l=S.g('logros',[]);l[i].done=!l[i].done;S.s('logros',l);renderLogros();}
// ══════ QUICK NOTES ══════
function toggleQNote(){
  document.getElementById('qnotePanel').classList.toggle('open');
  renderQNotes();
  setTimeout(()=>document.getElementById('qnoteInput').focus(),350);
}
function closeQNote(e){
  if(e.target===document.getElementById('qnotePanel'))
    document.getElementById('qnotePanel').classList.remove('open');
}
function addQNote(){
  const t=document.getElementById('qnoteInput').value.trim();if(!t)return;
  const ns=S.g('qnotes',[]);
  const now=new Date();
  ns.unshift({text:t,time:now.getHours()+':'+String(now.getMinutes()).padStart(2,'0'),date:fmt(now),id:Date.now()});
  S.s('qnotes',ns);document.getElementById('qnoteInput').value='';
  renderQNotes();toast('✎ Nota guardada');
}
function renderQNotes(){
  const ns=S.g('qnotes',[]);
  const el=document.getElementById('qnoteList');
  if(!ns.length){el.innerHTML='<div style="color:var(--text3);font-size:13px;padding:8px 0">Sin notas aún. Capturá ideas al vuelo.</div>';return;}
  el.innerHTML=ns.slice(0,20).map((n,i)=>`
    <div class="qnote-item">
      <div class="qnote-dot"></div>
      <div class="qnote-text">${n.text}</div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
        <div class="qnote-time">${n.time}</div>
        <button class="del-btn" style="font-size:11px" onclick="delQNote(${i})">✕</button>
      </div>
    </div>`).join('');
}
function delQNote(i){const n=S.g('qnotes',[]);n.splice(i,1);S.s('qnotes',n);renderQNotes();}

// ══════ POMODORO ══════
const POMO_MODES={focus:{mins:25,label:'Foco'},short:{mins:5,label:'Descanso corto'},long:{mins:15,label:'Descanso largo'}};
let pomoMode='focus',pomoSecs=25*60,pomoRunning=false,pomoInterval=null,pomoSessionCount=0,pomoCycle=0;

function setPomoMode(m){
  if(pomoRunning)return;
  pomoMode=m;
  pomoSecs=POMO_MODES[m].mins*60;
  pomoCycle=0;
  document.querySelectorAll('.pomo-mode').forEach(el=>el.classList.remove('active'));
  document.getElementById('pmode-'+m).classList.add('active');
  document.getElementById('pomoFill').className='pomo-fill'+(m!=='focus'?' break':'');
  renderPomoTime();
}
function pomoToggle(){
  if(pomoRunning){
    clearInterval(pomoInterval);pomoRunning=false;
    document.getElementById('pomoPlayBtn').textContent='▶';
  } else {
    pomoRunning=true;
    document.getElementById('pomoPlayBtn').textContent='⏸';
    pomoInterval=setInterval(()=>{
      pomoSecs--;
      if(pomoSecs<=0){
        clearInterval(pomoInterval);pomoRunning=false;
        document.getElementById('pomoPlayBtn').textContent='▶';
        if(pomoMode==='focus'){
          pomoSessionCount++;pomoCycle++;
          const stats=S.g('pomoStats',{today:0,week:0,total:0,lastDate:''});
          const todayStr=fmt(TODAY);
          if(stats.lastDate!==todayStr){stats.today=0;stats.lastDate=todayStr;}
          stats.today++;stats.week++;stats.total++;
          S.s('pomoStats',stats);
          renderPomoStats();
        }
        pomoSecs=0;
        renderPomoTime();
        try{new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAA').play();}catch(e){}
        toast(pomoMode==='focus'?'🔥 ¡Sesión completada! Tomá un descanso.':'✦ Descanso terminado. ¡A enfocarse!');
        return;
      }
      renderPomoTime();
    },1000);
  }
}
function pomoReset(){
  clearInterval(pomoInterval);pomoRunning=false;
  pomoSecs=POMO_MODES[pomoMode].mins*60;pomoCycle=0;
  document.getElementById('pomoPlayBtn').textContent='▶';
  renderPomoTime();
}
function pomoSkip(){pomoReset();}
function renderPomoTime(){
  const m=Math.floor(pomoSecs/60),s=pomoSecs%60;
  document.getElementById('pomoTime').textContent=String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
  document.getElementById('pomoLabel').textContent=POMO_MODES[pomoMode].label;
  const total=POMO_MODES[pomoMode].mins*60;
  const circ=2*Math.PI*88;
  const offset=circ*(pomoSecs/total);
  document.getElementById('pomoFill').style.strokeDashoffset=offset;
  // sessions dots
  const dots=document.getElementById('pomoSessions');
  dots.innerHTML=[0,1,2,3].map(i=>`<div class="pomo-dot ${i<pomoCycle%4?'done':''}"></div>`).join('');
}
function renderPomoStats(){
  const st=S.g('pomoStats',{today:0,week:0,total:0});
  document.getElementById('psToday').textContent=st.today||0;
  document.getElementById('psWeek').textContent=st.week||0;
  document.getElementById('psTotal').textContent=st.total||0;
  // task history
  const tasks=S.g('pomoTasks',[]);
  const task=document.getElementById('pomoTask');
  const hist=document.getElementById('pomoTaskHistory');
  if(tasks.length){
    hist.innerHTML=`<div style="font-size:10px;color:var(--text3);margin-top:4px">Recientes: ${tasks.slice(0,3).map(t=>`<span style="color:var(--text2)">${t}</span>`).join(' · ')}</div>`;
  }
  if(task&&!task.value&&tasks[0])task.value=tasks[0];
}
// save task on focus session complete — hook into pomoToggle via task
// pomo init handled by startAgenda

// ══════ STATS ══════
function renderStats(){
  const metas=S.g('metas',[]);
  const habitos=S.g('habitos',[]);
  const notas=S.g('notas',[]);
  const txs=S.g('txs',[]);
  const qnotes=S.g('qnotes',[]);
  const viajes=S.g('viajes',[]);
  const pomoSt=S.g('pomoStats',{total:0});

  // Big numbers
  const metasDone=metas.filter(m=>m.pct>=100).length;
  const avgMeta=metas.length?Math.round(metas.reduce((s,m)=>s+m.pct,0)/metas.length):0;
  const habitStreak=habitos.length?Math.max(...habitos.map(h=>calcStreak(h))):0;
  document.getElementById('statsBig').innerHTML=`
    <div class="stat-big"><div class="stat-big-val">${metasDone}</div><div class="stat-big-lbl">Metas logradas</div></div>
    <div class="stat-big"><div class="stat-big-val">${notas.length}</div><div class="stat-big-lbl">Días en diario</div></div>
    <div class="stat-big"><div class="stat-big-val">${pomoSt.total||0}</div><div class="stat-big-lbl">Sesiones foco</div></div>`;

  // Metas progress bars
  const mEl=document.getElementById('statsMetas');
  mEl.innerHTML=metas.length?metas.slice(0,6).map(m=>`
    <div class="stat-bar-row">
      <div class="stat-bar-label" style="font-size:11px;max-width:130px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${m.nombre}</div>
      <div class="stat-bar-wrap"><div class="stat-bar-fill ${m.pct>=100?'green':''}" style="width:${m.pct}%"></div></div>
      <div class="stat-bar-pct">${m.pct}%</div>
    </div>`).join(''):'<div class="empty" style="padding:12px 0"><div class="empty-text">Sin metas registradas.</div></div>';

  // Habitos streaks
  const hEl=document.getElementById('statsHabitos');
  hEl.innerHTML=habitos.length?habitos.map(h=>{
    const streak=calcStreak(h);
    const pct=Math.min(100,streak/7*100);
    return`<div class="stat-bar-row">
      <div class="stat-bar-label">${h.emoji} ${h.name}</div>
      <div class="stat-bar-wrap"><div class="stat-bar-fill green" style="width:${pct}%"></div></div>
      <div class="stat-bar-pct">🔥${streak}</div>
    </div>`;
  }).join(''):'<div class="empty" style="padding:12px 0"><div class="empty-text">Sin hábitos registrados.</div></div>';

  // Balance chart (monthly)
  const MESES_S=['E','F','M','A','M','J','J','A','S','O','N','D'];
  const balances=MESES_S.map((_,mi)=>{
    const month=txs.filter(t=>{const d=new Date(t.fecha+'T12:00:00');return d.getMonth()===mi&&d.getFullYear()===TODAY.getFullYear();});
    const ing=month.filter(t=>t.tipo==='ing').reduce((s,t)=>s+t.monto,0);
    const gas=month.filter(t=>t.tipo==='gas').reduce((s,t)=>s+t.monto,0);
    return ing-gas;
  });
  const maxAbs=Math.max(1,...balances.map(b=>Math.abs(b)));
  const bEl=document.getElementById('statsBalance');
  const totalBal=balances.reduce((s,b)=>s+b,0);
  bEl.innerHTML=`<div style="font-family:'DM Mono',monospace;font-size:13px;color:${totalBal>=0?'var(--green)':'var(--red)'}">Balance anual: $${Math.abs(totalBal).toLocaleString('es-AR')} ${totalBal>=0?'superávit':'déficit'}</div>`;
  document.getElementById('statsChart').innerHTML=balances.map((b,i)=>`
    <div class="mini-bar ${i===TODAY.getMonth()?'active':''}" style="height:${Math.max(4,Math.abs(b)/maxAbs*100)}%;background:${b>=0?'var(--green)':'var(--red)'};" title="${MESES_S[i]}: $${b.toLocaleString('es-AR')}"></div>`).join('');

  // Diario moods
  const moodCount={};
  notas.forEach(n=>{const m=n.animo.split(' ')[0];moodCount[m]=(moodCount[m]||0)+1;});
  const dEl=document.getElementById('statsDiario');
  dEl.innerHTML=notas.length?`
    <div style="font-size:13px;color:var(--text2);margin-bottom:10px">${notas.length} entradas escritas este año</div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      ${Object.entries(moodCount).map(([m,c])=>`<div style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:8px 12px;text-align:center"><div style="font-size:20px">${m}</div><div style="font-family:'DM Mono',monospace;font-size:12px;color:var(--gold)">${c}x</div></div>`).join('')}
    </div>`:'<div class="empty" style="padding:12px 0"><div class="empty-text">Sin entradas en el diario.</div></div>';
}

// ══════ REVIEW MENSUAL ══════
const REV_AREAS=['🏋️ Salud','💼 Trabajo','💰 Finanzas','💑 Relaciones','🧠 Aprendizaje','🎨 Personal'];
let revScores={};

function renderReview(){
  const mes=document.getElementById('revMes');
  mes.value=mes.value||'Enero';
  renderRevAreas();
  renderRevList();
  loadReview();
}
function renderRevAreas(){
  const el=document.getElementById('revAreas');
  el.innerHTML=REV_AREAS.map((a,ai)=>`
    <div class="review-area-row">
      <div class="review-area-name">${a}</div>
      <div class="review-area-score">
        ${[1,2,3,4,5].map(v=>`<div class="rev-pip ${(revScores[ai]||0)>=v?'active':''}" onclick="setRevScore(${ai},${v})"></div>`).join('')}
      </div>
    </div>`).join('');
}
function setRevScore(ai,v){
  revScores[ai]=v;renderRevAreas();
}
function loadReview(){
  const mes=document.getElementById('revMes').value;
  const reviews=S.g('reviews',[]);
  const rv=reviews.find(r=>r.mes===mes);
  revScores=rv?{...rv.scores}:{};
  document.getElementById('revLogros').value=rv?rv.logros||'':'';
  document.getElementById('revDesafios').value=rv?rv.desafios||'':'';
  document.getElementById('revIntencion').value=rv?rv.intencion||'':'';
  renderRevAreas();
}
function saveReview(){
  const mes=document.getElementById('revMes').value;
  const reviews=S.g('reviews',[]);
  const idx=reviews.findIndex(r=>r.mes===mes);
  const data={mes,scores:{...revScores},logros:document.getElementById('revLogros').value,desafios:document.getElementById('revDesafios').value,intencion:document.getElementById('revIntencion').value};
  if(idx>=0)reviews[idx]=data;else reviews.push(data);
  S.s('reviews',reviews);
  renderRevList();toast('⊞ Review de '+mes+' guardado');
}
function renderRevList(){
  const reviews=S.g('reviews',[]);
  const el=document.getElementById('revList');
  if(!reviews.length){el.innerHTML='<div class="empty"><div class="empty-icon">⊞</div><div class="empty-text">Todavía no guardaste ningún review.</div></div>';return;}
  el.innerHTML=[...reviews].reverse().map((rv,i)=>{
    const avg=Object.keys(rv.scores||{}).length?
      (Object.values(rv.scores).reduce((s,v)=>s+v,0)/Object.values(rv.scores).length).toFixed(1):'—';
    return`<div class="review-card">
      <div class="review-card-month">${rv.mes} · Promedio: ${avg}/5</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">
        ${REV_AREAS.map((a,ai)=>`<span style="font-size:10px;color:var(--text3)">${a.split(' ')[0]} ${[1,2,3,4,5].map(v=>`<span class="review-card-pip ${(rv.scores&&rv.scores[ai]||0)>=v?'active':''}"></span>`).join('')}</span>`).join('')}
      </div>
      ${rv.logros?`<div style="font-size:12px;color:var(--text2);line-height:1.5"><strong style="color:var(--cream)">🏆</strong> ${rv.logros.split('\n')[0]}</div>`:''}
    </div>`;
  }).join('');
}

// ══════ BACKUP / RESTORE ══════
const BACKUP_KEYS=['userName','userWord','metas','habitos','tareas','reflexion','events','txs','viajes','rutina','wishlist','notas','vision','logros','qnotes','pomoStats','pomoTasks','reviews','onboarded'];
function openBackup(){
  const panel=document.getElementById('backupPanel');
  panel.style.display='flex';
  const last=S.g('lastBackup','');
  const info=document.getElementById('backupInfo');
  if(last){const d=new Date(last);info.textContent='Último backup: '+d.toLocaleDateString('es-AR',{day:'numeric',month:'long'})+' a las '+d.toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'});}
  else info.textContent='Todavía no hiciste ningún backup.';
}
function closeBackup(){document.getElementById('backupPanel').style.display='none';}
function doBackup(){
  const data={_version:1,_fecha:new Date().toISOString(),_app:'AgendaPro2026'};
  BACKUP_KEYS.forEach(k=>{const v=S.g(k,null);if(v!==null)data[k]=v;});
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='agenda_pro_backup_'+new Date().toISOString().split('T')[0]+'.json';
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  URL.revokeObjectURL(url);
  S.s('lastBackup',new Date().toISOString());
  openBackup();toast('✦ Backup descargado');
}
function doRestore(event){
  const file=event.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const data=JSON.parse(e.target.result);
      if(!data._app){toast('❌ Archivo inválido');return;}
      Object.keys(data).filter(k=>!k.startsWith('_')).forEach(k=>S.s(k,data[k]));
      toast('✅ Datos restaurados — recargando...');
      setTimeout(()=>location.reload(),1500);
    }catch{toast('❌ Error al leer el archivo');}
  };
  reader.readAsText(file);
}</script>

<script>
// ── CLOUD SYNC ──
const FZ_DEBOUNCE={};
function FZ_cloudSave(val){
  const sess=window.getSession&&getSession();
  if(!sess)return;
  clearTimeout(FZ_DEBOUNCE.fz);
  FZ_DEBOUNCE.fz=setTimeout(async()=>{
    try{
      await fetch(SUPA_URL+'/rest/v1/datos_finanzas',{
        method:'POST',
        headers:{'apikey':SUPA_KEY,'Authorization':'Bearer '+sess.access_token,'Content-Type':'application/json','Prefer':'resolution=merge-duplicates'},
        body:JSON.stringify({user_id:sess.user.id,valor:val,updated_at:new Date().toISOString()})
      });
    }catch(e){}
  },1500);
}
async function FZ_cloudLoad(){
  const sess=window.getSession&&getSession();
  if(!sess)return;
  try{
    const r=await fetch(SUPA_URL+'/rest/v1/datos_finanzas?user_id=eq.'+sess.user.id+'&select=valor',{
      headers:{'apikey':SUPA_KEY,'Authorization':'Bearer '+sess.access_token}
    });
    const rows=await r.json();
    if(Array.isArray(rows)&&rows[0]&&rows[0].valor){
      localStorage.setItem('fz_v2',JSON.stringify(rows[0].valor));
      S=rows[0].valor;
    }
  }catch(e){}
}

// ======= CATEGORIES =======
const CATS = [
  {id:'vivienda',l:'Vivienda',e:'🏠',c:'#60a5fa'},
  {id:'alimentacion',l:'Alimentación',e:'🛒',c:'#4ade80'},
  {id:'transporte',l:'Transporte',e:'🚌',c:'#fbbf24'},
  {id:'salud',l:'Salud',e:'💊',c:'#f87171'},
  {id:'restaurantes',l:'Restaurantes',e:'🍽️',c:'#fb923c'},
  {id:'ocio',l:'Ocio',e:'🎉',c:'#a78bfa'},
  {id:'ropa',l:'Ropa',e:'👕',c:'#38bdf8'},
  {id:'educacion',l:'Educación',e:'📚',c:'#34d399'},
  {id:'suscripciones',l:'Suscripciones',e:'📱',c:'#e879f9'},
  {id:'seguros',l:'Seguros',e:'🛡️',c:'#94a3b8'},
  {id:'regalos',l:'Regalos',e:'🎁',c:'#f472b6'},
  {id:'otros',l:'Otros',e:'📦',c:'#6b7280'},
];

const COMMON_SUBS = [
  {name:'Netflix',icon:'🎬'},{name:'Spotify',icon:'🎵'},{name:'Amazon Prime',icon:'📦'},
  {name:'HBO Max',icon:'📺'},{name:'Disney+',icon:'🏰'},{name:'YouTube Premium',icon:'▶️'},
  {name:'Gimnasio',icon:'💪'},{name:'iCloud',icon:'☁️'},{name:'Office 365',icon:'💼'},
  {name:'Apple TV+',icon:'🍎'},{name:'Crunchyroll',icon:'⛩️'},{name:'Otro',icon:'➕'},
];

const GOALS_LIST = [
  {id:'ahorrar',l:'Quiero ahorrar más cada mes',e:'💰'},
  {id:'finde',l:'Quiero llegar mejor a fin de mes',e:'📅'},
  {id:'controlar',l:'Solo quiero saber en qué gasto',e:'🔍'},
  {id:'deuda',l:'Quiero salir de deudas',e:'📉'},
];

// ======= STATE =======
function FZ_defaultState() {
  return { onboarded:false, currency:'$', income:0, hasCar:false, hasCC:false,
    ccData:{bank:'',limit:0,digits:''},
    cards:[],
    transactions:[], subscriptions:[], vehicleExpenses:[],
    ccTransactions:[], ccCuotas:[], goals:[], budgets:{} };
}

let S = (() => { try { return JSON.parse(localStorage.getItem('fz_v2')) || FZ_defaultState(); } catch(e) { return FZ_defaultState(); } })();
let curMonth = new Date().getMonth();
let curYear = new Date().getFullYear();
let txType = 'gasto';
let selCat = '';
let ccSelCat = '';
let txFilter = 'todos';

function FZ_save() { localStorage.setItem('fz_v2', JSON.stringify(S)); FZ_cloudSave(S); }

// ======= ONBOARDING =======
let obCur = 1;
const OB_TOTAL = 6;
let obHasCar = false;
let obHasCC = false;
let obSelSubs = {};
let obSelGoal = '';

function FZ_initOB() {
  // dots
  const dc = document.getElementById('ob-dots');
  for (let i=1;i<=OB_TOTAL;i++) {
    const d = document.createElement('div');
    d.className='ob-dot'+(i===1?' active':''); d.id=`obd-${i}`; dc.appendChild(d);
  }
  // subs grid
  const sg = document.getElementById('ob-subs-grid');
  COMMON_SUBS.forEach(s => {
    const el = document.createElement('div');
    el.className='ob-sub-item'; el.id=`obs-sub-${s.name.replace(/\s+/g,'_')}`;
    el.innerHTML=`<div class="ob-sub-icon">${s.icon}</div><div class="ob-sub-name">${s.name}</div>`;
    el.onclick = () => {
      el.classList.toggle('selected');
      if (el.classList.contains('selected')) obSelSubs[s.name] = {name:s.name, icon:s.icon, price:0};
      else delete obSelSubs[s.name];
      FZ_renderSubPrices();
    };
    sg.appendChild(el);
  });
  // goals
  const gl = document.getElementById('ob-goals-list');
  GOALS_LIST.forEach(g => {
    const el = document.createElement('div');
    el.className='ob-goal-item'; el.id=`obg-${g.id}`;
    el.innerHTML=`<span class="ob-goal-icon">${g.e}</span><span class="ob-goal-label">${g.l}</span>`;
    el.onclick=()=>{ document.querySelectorAll('.ob-goal-item').forEach(x=>x.classList.remove('selected')); el.classList.add('selected'); obSelGoal=g.id; };
    gl.appendChild(el);
  });
}

function FZ_renderSubPrices() {
  const el = document.getElementById('ob-subs-prices');
  const subs = Object.values(obSelSubs);
  if (subs.length === 0) { el.innerHTML=''; return; }
  el.innerHTML = '<div style="font-size:.72rem;text-transform:uppercase;letter-spacing:.08em;color:var(--text3);font-weight:600;margin-bottom:8px">Precio de cada una (en tu moneda):</div>' +
    subs.map(s=>`<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
      <span style="font-size:.85rem;font-weight:500;flex:1">${s.icon} ${s.name}</span>
      <input type="number" style="width:100px" class="form-input" id="subp-${s.name.replace(/\s+/g,'_')}" placeholder="9.99" value="${s.price||''}" min="0" step="0.01" onchange="obSelSubs['${s.name}'].price=parseFloat(this.value)||0">
    </div>`).join('');
}

function FZ_obGo(step) {
  document.getElementById(`obs-${obCur}`).classList.remove('active');
  obCur = step;
  document.getElementById(`obs-${obCur}`).classList.add('active');
  for (let i=1;i<=OB_TOTAL;i++) {
    const d = document.getElementById(`obd-${i}`);
    d.className = 'ob-dot' + (i===step?' active':'') + (i<step?' done':'');
  }
}

function FZ_selectCar(v) {
  obHasCar = v;
  document.getElementById('ob-car-yes').classList.toggle('selected',v);
  document.getElementById('ob-car-no').classList.toggle('selected',!v);
}

function FZ_selectCC(v) {
  obHasCC = v;
  document.getElementById('ob-cc-yes').classList.toggle('selected',v);
  document.getElementById('ob-cc-no').classList.toggle('selected',!v);
  document.getElementById('ob-cc-fields').style.display = v ? 'block' : 'none';
}

function FZ_finishOnboarding() {
  S.onboarded = true;
  S.currency = document.getElementById('ob-currency').value.trim() || '€';
  S.income = parseFloat(document.getElementById('ob-income').value) || 0;
  S.hasCar = obHasCar;
  S.hasCC = obHasCC;
  if (obHasCC) {
    S.ccData = {
      bank: document.getElementById('ob-cc-bank').value.trim() || 'Mi Tarjeta',
      limit: parseFloat(document.getElementById('ob-cc-limit').value) || 0,
      digits: document.getElementById('ob-cc-digits').value.trim() || '****',
    };
  }
  S.goal = obSelGoal;
  // add subs
  Object.values(obSelSubs).forEach(s => {
    S.subscriptions.push({ id:FZ_uid(), name:s.name, icon:s.icon, price:s.price||0, freq:'mensual', renew:FZ_futureDate(1) });
  });
  FZ_save();
  document.getElementById('onboarding').classList.add('hidden');
  FZ_initApp();
}

// ======= NAVIGATION =======
const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

function FZ_showPage(id) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(`page-${id}`).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>{ if(n.getAttribute('onclick')?.includes(`'${id}'`)) n.classList.add('active'); });
  FZ_renderPage(id);
}

function FZ_curPage() { const p=document.querySelector('.page.active'); return p?p.id.replace('page-',''):'dashboard'; }

function FZ_renderPage(id) {
  const map = {dashboard:renderDash, gastos:renderGastos, presupuesto:renderPresupuesto,
    suscripciones:renderSubs, tarjeta:renderTarjeta, vehiculo:renderVehiculo, metas:renderMetas, ajustes:renderAjustes};
  map[id]?.();
}

function FZ_changeMonth(d) {
  curMonth += d;
  if(curMonth>11){curMonth=0;curYear++;} if(curMonth<0){curMonth=11;curYear--;}
  document.getElementById('month-label').textContent = MONTHS[curMonth].slice(0,3)+' '+curYear;
  FZ_renderPage(FZ_curPage());
}

function FZ_monthTxs() {
  return S.transactions.filter(t=>{ const d=new Date(t.date); return d.getMonth()===curMonth&&d.getFullYear()===curYear; });
}

// ======= DASHBOARD =======
function FZ_renderDash() {
  const txs = FZ_monthTxs();
  const gastos = txs.filter(t=>t.type==='gasto');
  const ingresos = txs.filter(t=>t.type==='ingreso');
  const tGasto = FZ_sum(gastos);
  const tIngreso = FZ_sum(ingresos) + (S.income||0);
  const balance = tIngreso - tGasto;
  const subsCost = S.subscriptions.reduce((a,s)=>a+FZ_mPrice(s),0);
  const ccGastos = S.ccTransactions.filter(t=>{ const d=new Date(t.date); return d.getMonth()===curMonth&&d.getFullYear()===curYear; });
  const tCC = FZ_sum(ccGastos);
  const cuotasMes = S.ccCuotas.reduce((a,c)=>a+(c.remaining>0?c.amount:0),0);

  document.getElementById('dash-month-title').textContent = MONTHS[curMonth];

  // Semaforo
  const pct = tIngreso>0 ? tGasto/tIngreso : 0;
  const sem = document.getElementById('dash-semaforo');
  const st = document.getElementById('sem-text');
  if(pct<0.7){ sem.className='semaforo sem-green'; st.innerHTML='🟢 <b>Muy bien.</b> Has gastado el '+Math.round(pct*100)+'% de tus ingresos.'; }
  else if(pct<0.9){ sem.className='semaforo sem-amber'; st.innerHTML='🟡 <b>Atención.</b> Has usado el '+Math.round(pct*100)+'% de tus ingresos.'; }
  else { sem.className='semaforo sem-red'; st.innerHTML='🔴 <b>Alerta.</b> Has gastado el '+Math.round(pct*100)+'% — revisa tus gastos.'; }

  // Stats
  let statsHTML = `
    <div class="card" style="position:relative"><div class="stat-icon">💸</div>
      <div class="stat-label">Gastos del mes</div><div class="stat-amount red">${FZ_fmt(tGasto)}</div>
      <div class="stat-sub">${gastos.length} movimientos</div></div>
    <div class="card" style="position:relative"><div class="stat-icon">💰</div>
      <div class="stat-label">Ingresos</div><div class="stat-amount green">${FZ_fmt(tIngreso)}</div>
      <div class="stat-sub">${S.income>0?'Salario incluido':ingresos.length+' registros'}</div></div>
    <div class="card" style="position:relative"><div class="stat-icon">${balance>=0?'📈':'📉'}</div>
      <div class="stat-label">Balance</div><div class="stat-amount ${balance>=0?'green':'red'}">${FZ_fmt(balance)}</div>
      <div class="stat-sub">${balance>=0?'✓ Positivo':'✗ Negativo'}</div></div>`;
  if (S.hasCC) {
    statsHTML += `<div class="card" style="position:relative"><div class="stat-icon">💳</div>
      <div class="stat-label">Tarjeta + Cuotas</div><div class="stat-amount purple">${FZ_fmt(tCC+cuotasMes)}</div>
      <div class="stat-sub">${FZ_fmt(cuotasMes)} en cuotas</div></div>`;
  } else {
    statsHTML += `<div class="card" style="position:relative"><div class="stat-icon">📱</div>
      <div class="stat-label">Suscripciones</div><div class="stat-amount amber">${FZ_fmt(subsCost)}</div>
      <div class="stat-sub">${S.subscriptions.length} activas/mes</div></div>`;
  }
  document.getElementById('stat-cards').innerHTML = statsHTML;

  // Score
  const score = FZ_calcScore(txs, pct);
  const ringFill = document.getElementById('ring-fill');
  const circ = 201;
  ringFill.style.strokeDashoffset = circ - (circ*score/100);
  ringFill.style.stroke = score>=70?'var(--green)':score>=40?'var(--amber)':'var(--red)';
  document.getElementById('score-num').textContent = score;
  document.getElementById('score-num').className = 'score-num '+(score>=70?'green':score>=40?'amber':'red');
  document.getElementById('score-desc').textContent = FZ_scoreMsg(score);

  // Recent
  const rec = [...S.transactions].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5);
  document.getElementById('recent-tx').innerHTML = rec.length ? rec.map(t=>FZ_txHTML(t)).join('') : FZ_emptyState('💸','Aún sin movimientos.<br>¡Registra tu primer gasto!');

  FZ_renderDonut(gastos);
  FZ_renderStreak();
  FZ_renderAlerts(txs, subsCost, pct, cuotasMes);
}

function FZ_calcScore(txs, pct) {
  let s=55;
  if(pct<0.7) s+=25; else if(pct<0.9) s+=10; else s-=10;
  const days = new Set(txs.map(t=>t.date)).size;
  s += Math.min(days*2,20);
  if(S.goals.length>0) s += Math.round(S.goals.filter(g=>g.saved>=g.target*.1).length/S.goals.length*15);
  return Math.max(0,Math.min(100,s));
}
function FZ_scoreMsg(s) {
  if(s>=80) return '¡Excelente! Lo estás haciendo muy bien.';
  if(s>=60) return 'Buen control. Hay margen de mejora.';
  if(s>=40) return 'Regular. Registra más y ajusta gastos.';
  return 'Mes difícil. ¡El próximo mejor!';
}

function FZ_renderDonut(gastos) {
  const byCat = {};
  gastos.forEach(t=>{ byCat[t.category]=(byCat[t.category]||0)+t.amount; });
  const total = Object.values(byCat).reduce((a,b)=>a+b,0);
  document.getElementById('donut-val').textContent = FZ_fmt(total);
  const svg = document.getElementById('donut-svg');
  const legend = document.getElementById('chart-legend');
  if(total===0){ svg.innerHTML=`<circle fill="none" stroke="var(--bg3)" stroke-width="16" cx="65" cy="65" r="50"/>`; legend.innerHTML='<div style="font-size:.75rem;color:var(--text3);text-align:center">Sin datos</div>'; return; }
  const sorted = Object.entries(byCat).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const r=50,cx=65,cy=65,circ=2*Math.PI*r;
  let off=0, svgH='', legH='';
  sorted.forEach(([cid,amt])=>{
    const cat=CATS.find(c=>c.id===cid)||{c:'#666',e:'📦',l:cid};
    const p=amt/total, dash=p*circ, gap=circ-dash;
    svgH+=`<circle fill="none" stroke="${cat.c}" stroke-width="16" cx="${cx}" cy="${cy}" r="${r}" stroke-dasharray="${dash} ${gap}" stroke-dashoffset="${-off*circ}" stroke-linecap="butt"/>`;
    off+=p;
    legH+=`<div class="legend-item"><div class="legend-dot" style="background:${cat.c}"></div><div class="legend-name">${cat.e} ${cat.l}</div><div class="legend-pct">${Math.round(p*100)}%</div></div>`;
  });
  svg.innerHTML=svgH; legend.innerHTML=legH;
}

function FZ_renderStreak() {
  const today=new Date(), wrap=document.getElementById('streak-days');
  const days=[], daysWithTx=new Set(S.transactions.map(t=>t.date));
  for(let i=6;i>=0;i--){ const d=new Date(today); d.setDate(d.getDate()-i); days.push(d.toISOString().split('T')[0]); }
  const DAY=['D','L','M','X','J','V','S'];
  wrap.innerHTML=days.map(d=>{
    const dn=new Date(d).getDay(), isT=d===today.toISOString().split('T')[0], hasTx=daysWithTx.has(d);
    let cls='s-day s-miss';
    if(isT&&hasTx) cls='s-day s-done'; else if(isT) cls='s-day s-today'; else if(hasTx) cls='s-day s-done';
    return `<div class="${cls}">${hasTx?'✓':DAY[dn]}</div>`;
  }).join('');
  let streak=0;
  const ts=today.toISOString().split('T')[0];
  for(let i=0;i<60;i++){ const d=new Date(today); d.setDate(d.getDate()-i); if(daysWithTx.has(d.toISOString().split('T')[0])) streak++; else break; }
  document.getElementById('streak-text').textContent = streak===0 ? 'Registra hoy para iniciar tu racha 🔥' : `${streak} día${streak>1?'s':''} seguidos registrando 🔥`;
}

function FZ_renderAlerts(txs, subsCost, pct, cuotasMes) {
  const alerts=[], today=new Date();
  // Subs proximas
  S.subscriptions.forEach(s=>{
    if(!s.renew) return;
    const diff=Math.ceil((new Date(s.renew)-today)/(864e5));
    if(diff>=0&&diff<=5) alerts.push({t:'amber',m:`📱 <b>${s.name}</b> renueva en ${diff} días (${FZ_fmt(s.price)})`});
  });
  // Budget
  Object.entries(S.budgets).forEach(([cid,bud])=>{
    if(!bud||bud<=0) return;
    const spent=FZ_sum(txs.filter(t=>t.category===cid&&t.type==='gasto'));
    const p=spent/bud, cat=CATS.find(c=>c.id===cid);
    if(p>=1) alerts.push({t:'red',m:`${cat?.e} <b>${cat?.l}</b>: ¡Presupuesto superado! ${FZ_fmt(spent)} de ${FZ_fmt(bud)}`});
    else if(p>=0.8) alerts.push({t:'amber',m:`${cat?.e} <b>${cat?.l}</b>: ${Math.round(p*100)}% del presupuesto usado`});
  });
  // Cuotas
  if(cuotasMes>0) alerts.push({t:'purple',m:`💳 Este mes tienes <b>${FZ_fmt(cuotasMes)}</b> en cuotas de tarjeta pendientes`});
  // Positivo
  if(pct<0.6&&txs.length>3) alerts.push({t:'green',m:`💚 ¡Gran mes! Estás ahorrando el ${Math.round((1-pct)*100)}% de tus ingresos`});
  if(subsCost>80) alerts.push({t:'blue',m:`📊 Tus suscripciones suman <b>${FZ_fmt(subsCost)}</b>/mes. ¿Usas todas?`});

  const list=document.getElementById('alerts-list');
  list.innerHTML = alerts.length ? alerts.map(a=>`<div class="alert-item al-${a.t}"><span>•</span><span>${a.m}</span></div>`).join('') : `<div class="alert-item al-green"><span>✅</span><span>Todo en orden. ¡Sigue así!</span></div>`;
}

// ======= GASTOS =======
function FZ_filterTx(f,btn) { txFilter=f; document.querySelectorAll('#page-gastos .tab').forEach(t=>t.classList.remove('active')); btn.classList.add('active'); FZ_renderGastos(); }

function FZ_renderGastos() {
  let txs = FZ_monthTxs();
  if(txFilter!=='todos') txs=txs.filter(t=>t.type===txFilter);
  txs.sort((a,b)=>new Date(b.date)-new Date(a.date));
  document.getElementById('gastos-sub').textContent = `${txs.length} movimiento${txs.length!==1?'s':''} — ${MONTHS[curMonth]} ${curYear}`;
  document.getElementById('all-tx').innerHTML = txs.length ? txs.map(t=>FZ_txHTML(t,true)).join('') : FZ_emptyState('💸','Sin movimientos este mes.');
}

function FZ_txHTML(t, showDel=false) {
  const cat=CATS.find(c=>c.id===t.category)||{e:'📦',l:'Otros',c:'#666'};
  const isIng=t.type==='ingreso';
  return `<div class="tx-item">
    <div class="tx-icon" style="background:${isIng?'var(--green-dim)':cat.c+'22'};color:${isIng?'var(--green)':cat.c}">${isIng?'💰':cat.e}</div>
    <div class="tx-info">
      <div class="tx-name">${t.desc||cat.l}</div>
      <div class="tx-meta">${isIng?'Ingreso':cat.l} · ${FZ_fmtDate(t.date)}</div>
    </div>
    <div class="tx-amount ${isIng?'green':'red'}">${isIng?'+':'-'}${FZ_fmt(t.amount)}</div>
    ${showDel?`<button class="tx-del" onclick="FZ_delTx('${t.id}')">✕</button>`:''}
  </div>`;
}

function FZ_delTx(id) { if(!confirm('¿Eliminar?')) return; S.transactions=S.transactions.filter(t=>t.id!==id); FZ_save(); FZ_renderPage(FZ_curPage()); }

// ======= PRESUPUESTO =======
function FZ_renderPresupuesto() {
  const txs=FZ_monthTxs();
  document.getElementById('budget-cards').innerHTML = CATS.filter(c=>c.id!=='otros').map(cat=>{
    const spent=FZ_sum(txs.filter(t=>t.category===cat.id&&t.type==='gasto'));
    const bud=S.budgets[cat.id]||0;
    const pct=bud>0?Math.min(spent/bud,1):0;
    const bc=pct>=1?'var(--red)':pct>=0.8?'var(--amber)':'var(--green)';
    return `<div class="card" style="padding:18px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="display:flex;align-items:center;gap:7px"><span style="font-size:1.1rem">${cat.e}</span><span style="font-size:.85rem;font-weight:500">${cat.l}</span></div>
        ${bud>0?`<span class="badge ${pct>=1?'b-red':pct>=0.8?'b-amber':'b-green'}">${Math.round(pct*100)}%</span>`:''}
      </div>
      <div style="font-family:'DM Mono',monospace;font-size:.88rem;margin-bottom:6px">
        <span class="${pct>=1?'red':''}">${FZ_fmt(spent)}</span>${bud>0?`<span style="color:var(--text3)"> / ${FZ_fmt(bud)}</span>`:'<span style="color:var(--text3)"> — sin límite</span>'}
      </div>
      ${bud>0?`<div class="prog-bar"><div class="prog-fill" style="width:${pct*100}%;background:${bc}"></div></div>`:''}
    </div>`;
  }).join('');
}

function FZ_openBudgetModal() {
  document.getElementById('budget-form').innerHTML = CATS.filter(c=>c.id!=='otros').map(cat=>`
    <div class="form-group">
      <label class="form-label">${cat.e} ${cat.l}</label>
      <input type="number" class="form-input" id="bud-${cat.id}" placeholder="0 = sin límite" value="${S.budgets[cat.id]||''}" min="0">
    </div>`).join('');
}

function FZ_saveBudgets() {
  CATS.filter(c=>c.id!=='otros').forEach(cat=>{
    const v=parseFloat(document.getElementById(`bud-${cat.id}`).value);
    if(!isNaN(v)&&v>0) S.budgets[cat.id]=v; else delete S.budgets[cat.id];
  });
  FZ_save(); FZ_closeModal('presupuesto'); FZ_renderPresupuesto();
}

// ======= SUSCRIPCIONES =======
function FZ_renderSubs() {
  const total=S.subscriptions.reduce((a,s)=>a+FZ_mPrice(s),0);
  document.getElementById('subs-sub').textContent = `${S.subscriptions.length} activas · ${FZ_fmt(total)}/mes`;
  const el=document.getElementById('subs-list');
  if(!S.subscriptions.length){ el.innerHTML=FZ_emptyState('📱','Sin suscripciones aún.'); return; }
  const today=new Date();
  el.innerHTML=S.subscriptions.map(s=>{
    const diff=s.renew?Math.ceil((new Date(s.renew)-today)/864e5):null;
    let badge='';
    if(diff!==null){ if(diff<=3) badge=`<span class="badge b-red">Renueva en ${diff}d</span>`; else if(diff<=7) badge=`<span class="badge b-amber">En ${diff} días</span>`; else badge=`<span class="badge b-green">En ${diff}d</span>`; }
    return `<div class="sub-item">
      <div class="sub-logo">${s.icon||'📱'}</div>
      <div class="sub-info"><div class="sub-name">${s.name}</div>
        <div class="sub-meta">${s.freq}${s.renew?' · '+FZ_fmtDate(s.renew):''} ${badge}</div></div>
      <div style="display:flex;align-items:center;gap:8px">
        <div style="font-family:'DM Mono',monospace;font-size:.88rem;color:var(--amber)">${FZ_fmt(FZ_mPrice(s))}/mes</div>
        <button class="tx-del" style="opacity:1" onclick="FZ_delSub('${s.id}')">✕</button>
      </div>
    </div>`;
  }).join('');
}

function FZ_delSub(id){ if(!confirm('¿Eliminar suscripción?')) return; S.subscriptions=S.subscriptions.filter(s=>s.id!==id); FZ_save(); FZ_renderSubs(); }

function FZ_mPrice(s){
  if(s.freq==='anual') return s.price/12;
  if(s.freq==='semanal') return s.price*4.33;
  if(s.freq==='trimestral') return s.price/3;
  return s.price;
}

// ======= TARJETA =======
function FZ_renderTarjeta() {
  const cc=S.ccData;
  const ccTxMonth=S.ccTransactions.filter(t=>{const d=new Date(t.date);return d.getMonth()===curMonth&&d.getFullYear()===curYear;});
  const tCC=FZ_sum(ccTxMonth);
  const tCuotas=S.ccCuotas.reduce((a,c)=>a+(c.remaining>0?c.amount:0),0);
  const usedCredit=tCC+tCuotas;
  const available=cc.limit>0?Math.max(cc.limit-usedCredit,0):0;
  const usePct=cc.limit>0?Math.min(usedCredit/cc.limit,1):0;

  // Card visual
  document.getElementById('cc-visual').innerHTML = `
    <div class="cc-card">
      <div class="cc-top"><div class="cc-bank">${cc.bank||'Mi Tarjeta'}</div><div class="cc-chip">💳</div></div>
      <div class="cc-number">•••• •••• •••• ${cc.digits||'****'}</div>
      <div class="cc-bottom">
        <div><div class="cc-label">Gastado este mes</div><div class="cc-value purple">${FZ_fmt(tCC)}</div></div>
        <div><div class="cc-label">Cuotas pendientes</div><div class="cc-value amber">${FZ_fmt(tCuotas)}</div></div>
        <div><div class="cc-label">Límite</div><div class="cc-value">${cc.limit>0?FZ_fmt(cc.limit):'—'}</div></div>
      </div>
      ${cc.limit>0?`<div class="cc-limit-bar">
        <div class="cc-limit-info"><span style="color:rgba(255,255,255,.5)">Usado</span><span>${FZ_fmt(usedCredit)} de ${FZ_fmt(cc.limit)}</span></div>
        <div class="prog-bar" style="height:5px;background:rgba(255,255,255,.1)"><div class="prog-fill" style="width:${usePct*100}%;background:${usePct>0.8?'var(--red)':usePct>0.6?'var(--amber)':'var(--purple)'}"></div></div>
      </div>`:''}
    </div>`;

  // Stats
  const cuotasActivas=S.ccCuotas.filter(c=>c.remaining>0);
  document.getElementById('cc-stats').innerHTML=`
    <div class="vehicle-stat"><div class="vehicle-stat-icon">💸</div><div class="vehicle-stat-val purple">${FZ_fmt(tCC)}</div><div class="vehicle-stat-lbl">Gastos mes</div></div>
    <div class="vehicle-stat"><div class="vehicle-stat-icon">📅</div><div class="vehicle-stat-val amber">${FZ_fmt(tCuotas)}</div><div class="vehicle-stat-lbl">Cuotas/mes</div></div>
    <div class="vehicle-stat"><div class="vehicle-stat-icon">📋</div><div class="vehicle-stat-val">${cuotasActivas.length}</div><div class="vehicle-stat-lbl">Cuotas activas</div></div>`;

  // TX list
  const txEl=document.getElementById('cc-tx-list');
  txEl.innerHTML=ccTxMonth.length ? ccTxMonth.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(t=>{
    const cat=CATS.find(c=>c.id===t.category)||{e:'💳',l:'Tarjeta',c:'var(--purple)'};
    return `<div class="tx-item">
      <div class="tx-icon" style="background:var(--purple-dim);color:var(--purple)">${cat.e}</div>
      <div class="tx-info"><div class="tx-name">${t.desc||'Gasto tarjeta'}</div><div class="tx-meta">${FZ_fmtDate(t.date)}</div></div>
      <div class="tx-amount purple">-${FZ_fmt(t.amount)}</div>
      <button class="tx-del" style="opacity:1" onclick="FZ_delCCTx('${t.id}')">✕</button>
    </div>`;
  }).join('') : FZ_emptyState('💳','Sin gastos con tarjeta este mes.');

  // Cuotas
  const cuEl=document.getElementById('cc-cuotas-list');
  cuEl.innerHTML=S.ccCuotas.length ? S.ccCuotas.map(c=>`
    <div class="tx-item">
      <div class="tx-icon" style="background:var(--amber-dim);color:var(--amber)">📅</div>
      <div class="tx-info">
        <div class="tx-name">${c.desc}</div>
        <div class="tx-meta">${c.remaining} cuota${c.remaining!==1?'s':''} restante${c.remaining!==1?'s':''} · día ${c.day||'—'}</div>
        <div class="prog-bar" style="margin-top:5px"><div class="prog-fill" style="width:${Math.min((c.total-c.remaining)/c.total*100,100)}%;background:var(--amber)"></div></div>
      </div>
      <div style="text-align:right">
        <div class="tx-amount amber">${FZ_fmt(c.amount)}/mes</div>
        <div style="font-size:.7rem;color:var(--text3)">Total: ${FZ_fmt(c.amount*c.remaining)}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:4px">
        <button class="tx-del" style="opacity:1" onclick="FZ_pagarCuota('${c.id}')">✓</button>
        <button class="tx-del" style="opacity:1" onclick="FZ_delCuota('${c.id}')">✕</button>
      </div>
    </div>`).join('') : FZ_emptyState('📅','Sin cuotas pendientes.');
}

function FZ_delCCTx(id){ S.ccTransactions=S.ccTransactions.filter(t=>t.id!==id); FZ_save(); FZ_renderTarjeta(); }
function FZ_delCuota(id){ if(!confirm('¿Eliminar cuota?')) return; S.ccCuotas=S.ccCuotas.filter(c=>c.id!==id); FZ_save(); FZ_renderTarjeta(); }
function FZ_pagarCuota(id){ const c=S.ccCuotas.find(c=>c.id===id); if(c&&c.remaining>0){ c.remaining--; FZ_save(); FZ_renderTarjeta(); } }

// ======= VEHICULO =======
function FZ_renderVehiculo() {
  const vTxs=S.vehicleExpenses.filter(v=>{const d=new Date(v.date);return d.getMonth()===curMonth&&d.getFullYear()===curYear;});
  const total=FZ_sum(vTxs);
  const gas=FZ_sum(vTxs.filter(v=>v.type==='gasolina'));
  const mant=FZ_sum(vTxs.filter(v=>!['gasolina','aparcamiento'].includes(v.type)));
  document.getElementById('vehicle-stats').innerHTML=`
    <div class="vehicle-stat"><div class="vehicle-stat-icon">💶</div><div class="vehicle-stat-val">${FZ_fmt(total)}</div><div class="vehicle-stat-lbl">Total mes</div></div>
    <div class="vehicle-stat"><div class="vehicle-stat-icon">⛽</div><div class="vehicle-stat-val">${FZ_fmt(gas)}</div><div class="vehicle-stat-lbl">Combustible</div></div>
    <div class="vehicle-stat"><div class="vehicle-stat-icon">🔧</div><div class="vehicle-stat-val">${FZ_fmt(mant)}</div><div class="vehicle-stat-lbl">Mantenimiento</div></div>`;
  const ICONS={gasolina:'⛽',seguro:'🛡️',revision:'🔧',itv:'🔍',aparcamiento:'🅿️',multa:'🚨',otro:'📦'};
  const el=document.getElementById('vehicle-list');
  el.innerHTML=vTxs.length ? vTxs.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(v=>`
    <div class="tx-item">
      <div class="tx-icon" style="background:var(--amber-dim);color:var(--amber)">${ICONS[v.type]||'📦'}</div>
      <div class="tx-info"><div class="tx-name">${v.notes||v.type}</div><div class="tx-meta">${v.type.charAt(0).toUpperCase()+v.type.slice(1)} · ${FZ_fmtDate(v.date)}</div></div>
      <div class="tx-amount red">-${FZ_fmt(v.amount)}</div>
      <button class="tx-del" style="opacity:1" onclick="FZ_delVeh('${v.id}')">✕</button>
    </div>`).join('') : FZ_emptyState('🚗','Sin gastos de vehículo este mes.');
}

function FZ_delVeh(id){ S.vehicleExpenses=S.vehicleExpenses.filter(v=>v.id!==id); FZ_save(); FZ_renderVehiculo(); }

// ======= METAS =======
function FZ_renderMetas() {
  const el=document.getElementById('metas-list');
  if(!S.goals.length){ el.innerHTML=FZ_emptyState('🏆','Sin metas. ¡Define tu primer objetivo de ahorro!'); return; }
  el.innerHTML=S.goals.map(g=>{
    const pct=Math.min(g.saved/g.target,1);
    const bc=pct>=1?'var(--green)':pct>=.5?'var(--blue)':'var(--amber)';
    const today=new Date(), target=g.date?new Date(g.date):null;
    const months=target?Math.max(Math.ceil((target-today)/864e5/30),0):null;
    const monthly=months&&months>0?Math.ceil((g.target-g.saved)/months):null;
    return `<div class="meta-item">
      <div class="meta-header">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:1.2rem">${g.icon||'🎯'}</span>
          <div><div style="font-size:.88rem;font-weight:500">${g.name}</div>
            ${monthly?`<div style="font-size:.72rem;color:var(--text3)">Ahorra ${FZ_fmt(monthly)}/mes para llegar</div>`:''}
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
          <span style="font-family:'DM Mono',monospace;font-size:.8rem;color:var(--text2)">${FZ_fmt(g.saved)} / ${FZ_fmt(g.target)}</span>
          <button class="btn btn-ghost btn-sm" onclick="FZ_addMeta('${g.id}')">+ Añadir</button>
          <button class="tx-del" style="opacity:1" onclick="FZ_delMeta('${g.id}')">✕</button>
        </div>
      </div>
      <div class="prog-bar" style="height:8px"><div class="prog-fill" style="width:${pct*100}%;background:${bc}"></div></div>
      <div style="font-size:.7rem;color:var(--text3);margin-top:4px">${Math.round(pct*100)}% completado${target?' · Fecha: '+FZ_fmtDate(g.date):''}</div>
    </div>`;
  }).join('');
}

function FZ_delMeta(id){ S.goals=S.goals.filter(g=>g.id!==id); FZ_save(); FZ_renderMetas(); }
function FZ_addMeta(id){ const a=parseFloat(prompt('¿Cuánto añades?')); if(isNaN(a)||a<=0) return; const g=S.goals.find(g=>g.id===id); if(g){g.saved=Math.min(g.saved+a,g.target);FZ_save();FZ_renderMetas();} }

// ======= MODALS =======
function FZ_openModal(type) {
  if(type==='gasto'){
    FZ_buildCatGrid('cat-grid', id=>{selCat=id;});
    selCat=''; txType='gasto';
    document.getElementById('cat-group').style.display='block';
    document.getElementById('tx-date').value=FZ_today();
    document.getElementById('tx-amount').value='';
    document.getElementById('tx-desc').value='';
    document.querySelectorAll('#modal-gasto .tab').forEach((t,i)=>t.classList.toggle('active',i===0));
  }
  if(type==='presupuesto') FZ_openBudgetModal();
  if(type==='suscripcion'){ document.getElementById('sub-renew').value=FZ_futureDate(1); ['sub-name','sub-icon','sub-price'].forEach(id=>document.getElementById(id).value=''); }
  if(type==='vehiculo'){ document.getElementById('veh-date').value=FZ_today(); document.getElementById('veh-amount').value=''; document.getElementById('veh-notes').value=''; }
  if(type==='meta'){ ['meta-name','meta-icon','meta-target','meta-saved'].forEach(id=>document.getElementById(id).value=''); document.getElementById('meta-date').value=FZ_futureDate(6); }
  if(type==='cc-gasto'){ FZ_buildCatGrid('cc-cat-grid',id=>{ccSelCat=id;}); ccSelCat=''; document.getElementById('cc-date').value=FZ_today(); document.getElementById('cc-amount').value=''; document.getElementById('cc-desc').value=''; }
  if(type==='cuota'){ ['cuota-desc','cuota-amount','cuota-remaining','cuota-day'].forEach(id=>document.getElementById(id).value=''); }
  document.getElementById(`modal-${type}`).classList.add('open');
}

function FZ_closeModal(type){ document.getElementById(`modal-${type}`).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

function FZ_buildCatGrid(gridId, onSelect) {
  const grid=document.getElementById(gridId);
  grid.innerHTML=CATS.map(c=>`<div class="cat-btn" id="${gridId}-${c.id}" onclick="FZ_selectCatIn('${gridId}','${c.id}')"><span class="ce">${c.e}</span><span>${c.l}</span></div>`).join('');
  grid._onSelect = onSelect;
}

function FZ_selectCatIn(gridId, catId) {
  document.querySelectorAll(`#${gridId} .cat-btn`).forEach(b=>b.classList.remove('selected'));
  document.getElementById(`${gridId}-${catId}`)?.classList.add('selected');
  const grid=document.getElementById(gridId);
  if(grid._onSelect) grid._onSelect(catId);
}

function FZ_setTxType(type,btn){
  txType=type;
  document.querySelectorAll('#modal-gasto .tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('cat-group').style.display=type==='gasto'?'block':'none';
}

function FZ_saveTx(){
  const amount=parseFloat(document.getElementById('tx-amount').value);
  const desc=document.getElementById('tx-desc').value.trim();
  const date=document.getElementById('tx-date').value;
  if(!amount||amount<=0){alert('Ingresa un importe válido');return;}
  // categoría opcional
  if(!date){alert('Selecciona una fecha');return;}
  S.transactions.push({id:FZ_uid(),type:txType,amount,desc,category:selCat||'otros',date});
  FZ_save(); FZ_closeModal('gasto'); FZ_renderPage(FZ_curPage());
}

function FZ_saveSub(){
  const name=document.getElementById('sub-name').value.trim();
  const price=parseFloat(document.getElementById('sub-price').value);
  const freq=document.getElementById('sub-freq').value;
  const renew=document.getElementById('sub-renew').value;
  const icon=document.getElementById('sub-icon').value||'📱';
  if(!name||!price||price<=0){alert('Completa nombre e importe');return;}
  S.subscriptions.push({id:FZ_uid(),name,price,freq,renew,icon});
  FZ_save(); FZ_closeModal('suscripcion'); FZ_renderSubs();
}

function FZ_saveVehiculo(){
  const type=document.getElementById('veh-type').value;
  const amount=parseFloat(document.getElementById('veh-amount').value);
  const notes=document.getElementById('veh-notes').value.trim();
  const date=document.getElementById('veh-date').value;
  if(!amount||amount<=0){alert('Ingresa un importe válido');return;}
  S.vehicleExpenses.push({id:FZ_uid(),type,amount,notes,date});
  FZ_save(); FZ_closeModal('vehiculo'); FZ_renderVehiculo();
}

function FZ_saveMeta(){
  const name=document.getElementById('meta-name').value.trim();
  const target=parseFloat(document.getElementById('meta-target').value);
  const saved=parseFloat(document.getElementById('meta-saved').value)||0;
  const date=document.getElementById('meta-date').value;
  const icon=document.getElementById('meta-icon').value||'🎯';
  if(!name||!target||target<=0){alert('Completa nombre y objetivo');return;}
  S.goals.push({id:FZ_uid(),name,target,saved,date,icon});
  FZ_save(); FZ_closeModal('meta'); FZ_renderMetas();
}

function FZ_saveCCGasto(){
  const desc=document.getElementById('cc-desc').value.trim();
  const amount=parseFloat(document.getElementById('cc-amount').value);
  const date=document.getElementById('cc-date').value;
  if(!amount||amount<=0){alert('Ingresa un importe válido');return;}
  if(!ccSelCat){alert('Selecciona una categoría');return;}
  S.ccTransactions.push({id:FZ_uid(),desc,amount,category:ccSelCat,date});
  FZ_save(); FZ_closeModal('cc-gasto'); FZ_renderTarjeta();
}

function FZ_saveCuota(){
  const desc=document.getElementById('cuota-desc').value.trim();
  const amount=parseFloat(document.getElementById('cuota-amount').value);
  const remaining=parseInt(document.getElementById('cuota-remaining').value);
  const day=parseInt(document.getElementById('cuota-day').value)||0;
  if(!desc||!amount||amount<=0||!remaining||remaining<=0){alert('Completa todos los campos');return;}
  S.ccCuotas.push({id:FZ_uid(),desc,amount,remaining,total:remaining,day});
  FZ_save(); FZ_closeModal('cuota'); FZ_renderTarjeta();
}

// ======= UTILS =======
function FZ_fmt(n){ return (S.currency||'€')+new Intl.NumberFormat('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2}).format(n||0); }
function FZ_sum(arr){ return arr.reduce((a,t)=>a+(t.amount||0),0); }
function FZ_uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2); }
function FZ_today(){ return new Date().toISOString().split('T')[0]; }
function FZ_futureDate(months){ const d=new Date(); d.setMonth(d.getMonth()+months); return d.toISOString().split('T')[0]; }
function FZ_fmtDate(str){ if(!str) return ''; return new Date(str).toLocaleDateString('es-ES',{day:'numeric',month:'short',year:'numeric'}); }
function FZ_emptyState(icon,text){ return `<div class="empty-state"><div class="empty-icon">${icon}</div><div class="empty-text">${text}</div></div>`; }

// ======= AJUSTES =======
function FZ_renderAjustes() {
  document.getElementById('cfg-currency').value = S.currency || '€';
  document.getElementById('btn-informe-mes').textContent = MONTHS[curMonth] + ' ' + curYear;
}

function FZ_saveCurrency() {
  const v = document.getElementById('cfg-currency').value.trim();
  if (!v) return;
  S.currency = v;
  FZ_save();
  document.getElementById('sidebar-currency-label').textContent = 'Moneda: ' + S.currency;
  FZ_showStatus('✅ Moneda actualizada a "' + v + '"');
}

function FZ_showStatus(msg) {
  const el = document.getElementById('backup-status');
  if (el) { el.textContent = msg; setTimeout(() => { el.textContent = ''; }, 4000); }
}

// ---- EXPORT JSON ----
function FZ_exportJSON() {
  const data = JSON.stringify(S, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const date = new Date().toISOString().split('T')[0];
  a.href = url;
  a.download = `finanzas-backup-${date}.json`;
  a.click();
  URL.revokeObjectURL(url);
  FZ_showStatus('✅ Datos exportados correctamente. ¡Guarda el archivo en un lugar seguro!');
}

// ---- IMPORT JSON ----
function FZ_importJSON(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.transactions && !data.subscriptions) throw new Error('Archivo no válido');
      if (!confirm(`¿Importar datos de ${file.name}? Esto reemplazará tus datos actuales.`)) return;
      S = { ...FZ_defaultState(), ...data };
      FZ_save();
      FZ_showStatus('✅ Datos importados correctamente. ¡Bienvenido de vuelta!');
      setTimeout(() => { FZ_initApp(); FZ_showPage('dashboard'); }, 1000);
    } catch(err) {
      FZ_showStatus('❌ Error al importar. Asegúrate de que el archivo es un backup válido.');
    }
  };
  reader.readAsText(file);
  input.value = '';
}

// ---- RESET ----
function FZ_resetApp() {
  if (!confirm('⚠️ ¿Seguro que quieres borrar TODOS los datos? Esta acción es irreversible.')) return;
  if (!confirm('Última confirmación: ¿borrar todo?')) return;
  localStorage.removeItem('fz_v2');
  S = FZ_defaultState();
  location.reload();
}

// ---- INFORME MENSUAL ----
function FZ_generarInforme() {
  const txs = FZ_monthTxs();
  const gastos = txs.filter(t => t.type === 'gasto');
  const ingresos = txs.filter(t => t.type === 'ingreso');
  const tGasto = FZ_sum(gastos);
  const tIngreso = FZ_sum(ingresos) + (S.income || 0);
  const balance = tIngreso - tGasto;
  const subsCost = S.subscriptions.reduce((a, s) => a + FZ_mPrice(s), 0);
  const score = FZ_calcScore(txs, tIngreso > 0 ? tGasto / tIngreso : 0);

  // Gastos por categoria
  const byCat = {};
  gastos.forEach(t => { byCat[t.category] = (byCat[t.category] || 0) + t.amount; });
  const catRows = Object.entries(byCat).sort((a, b) => b[1] - a[1])
    .map(([cid, amt]) => {
      const cat = CATS.find(c => c.id === cid) || { e: '📦', l: cid };
      const pct = tGasto > 0 ? Math.round(amt / tGasto * 100) : 0;
      return `<div class="informe-cat"><span>${cat.e} ${cat.l}</span><span><b>${FZ_fmt(amt)}</b> (${pct}%)</span></div>`;
    }).join('');

  // Ultimas transacciones
  const txRows = [...txs].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 20)
    .map(t => {
      const cat = CATS.find(c => c.id === t.category) || { e: '📦', l: 'Otros' };
      const isIng = t.type === 'ingreso';
      return `<tr>
        <td>${FZ_fmtDate(t.date)}</td>
        <td>${t.desc || cat.l}</td>
        <td>${isIng ? 'Ingreso' : cat.e + ' ' + cat.l}</td>
        <td style="text-align:right;font-weight:600;color:${isIng ? '#16a34a' : '#dc2626'}">${isIng ? '+' : '-'}${FZ_fmt(t.amount)}</td>
      </tr>`;
    }).join('');

  // Suscripciones
  const subRows = S.subscriptions.map(s =>
    `<tr><td>${s.icon || '📱'} ${s.name}</td><td>${s.freq}</td><td style="text-align:right">${FZ_fmt(FZ_mPrice(s))}/mes</td></tr>`
  ).join('');

  // Cuotas tarjeta
  const cuotaRows = S.hasCC && S.ccCuotas.length ? S.ccCuotas.filter(c => c.remaining > 0).map(c =>
    `<tr><td>${c.desc}</td><td style="text-align:center">${c.remaining} restantes</td><td style="text-align:right">${FZ_fmt(c.amount)}/mes</td></tr>`
  ).join('') : '';

  const scoreClass = score >= 70 ? 'g' : score >= 40 ? 'a' : 'r';
  const scoreLabel = score >= 70 ? 'Excelente' : score >= 40 ? 'Regular' : 'Mejorable';

  const html = `
  <div class="informe-wrap">
    <div class="informe-header">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div class="informe-title">📊 Informe Financiero</div>
          <div class="informe-sub">${MONTHS[curMonth]} ${curYear} · Generado el ${new Date().toLocaleDateString('es-ES', {day:'numeric',month:'long',year:'numeric'})}</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:11px;color:#888;margin-bottom:4px">Puntuación del mes</div>
          <div class="informe-score ${scoreClass}">${score}/100 — ${scoreLabel}</div>
        </div>
      </div>
    </div>

    <div class="informe-kpis">
      <div class="informe-kpi">
        <div class="informe-kpi-label">💸 Gastos totales</div>
        <div class="informe-kpi-val r">${FZ_fmt(tGasto)}</div>
        <div style="font-size:10px;color:#888;margin-top:4px">${gastos.length} movimientos</div>
      </div>
      <div class="informe-kpi">
        <div class="informe-kpi-label">💰 Ingresos totales</div>
        <div class="informe-kpi-val g">${FZ_fmt(tIngreso)}</div>
        <div style="font-size:10px;color:#888;margin-top:4px">${S.income > 0 ? 'Salario incluido' : ingresos.length + ' registros'}</div>
      </div>
      <div class="informe-kpi">
        <div class="informe-kpi-label">${balance >= 0 ? '📈' : '📉'} Balance</div>
        <div class="informe-kpi-val ${balance >= 0 ? 'g' : 'r'}">${FZ_fmt(balance)}</div>
        <div style="font-size:10px;color:#888;margin-top:4px">${balance >= 0 ? 'Positivo ✓' : 'Negativo ✗'}</div>
      </div>
    </div>

    ${catRows ? `
    <div class="informe-section">
      <div class="informe-section-title">Gastos por categoría</div>
      <div class="informe-cat-grid">${catRows}</div>
    </div>` : ''}

    ${txRows ? `
    <div class="informe-section">
      <div class="informe-section-title">Movimientos del mes (últimos 20)</div>
      <table class="informe-table">
        <thead><tr><th>Fecha</th><th>Descripción</th><th>Categoría</th><th style="text-align:right">Importe</th></tr></thead>
        <tbody>${txRows}</tbody>
      </table>
    </div>` : ''}

    ${subRows ? `
    <div class="informe-section">
      <div class="informe-section-title">Suscripciones activas · Total: ${FZ_fmt(subsCost)}/mes</div>
      <table class="informe-table">
        <thead><tr><th>Nombre</th><th>Frecuencia</th><th style="text-align:right">Coste mensual</th></tr></thead>
        <tbody>${subRows}</tbody>
      </table>
    </div>` : ''}

    ${cuotaRows ? `
    <div class="informe-section">
      <div class="informe-section-title">Cuotas tarjeta pendientes · ${FZ_fmt(S.ccCuotas.filter(c=>c.remaining>0).reduce((a,c)=>a+c.amount,0))}/mes</div>
      <table class="informe-table">
        <thead><tr><th>Descripción</th><th style="text-align:center">Cuotas</th><th style="text-align:right">Importe</th></tr></thead>
        <tbody>${cuotaRows}</tbody>
      </table>
    </div>` : ''}

    <div class="informe-footer">
      Generado por Finanzas — Tu dinero, tu control · Los datos se almacenan localmente en tu dispositivo
    </div>
  </div>`;

  document.getElementById('informe-print').innerHTML = html;
  setTimeout(() => window.print(), 100);
}

// ======= INIT =======
function FZ_initApp() {
  document.getElementById('month-label').textContent = MONTHS[curMonth].slice(0,3)+' '+curYear;
  document.getElementById('sidebar-currency-label').textContent = 'Moneda: '+S.currency;
  document.getElementById('nav-vehiculo').style.display='flex';
  document.getElementById('nav-tarjeta').style.display='flex';
  FZ_renderDash();
}

function FZ_init() {
  if(!S.onboarded) {
    S.onboarded = true;
    S.currency = S.currency || '$';
    FZ_save();
  }
  document.getElementById('onboarding').classList.add('hidden');
  FZ_initApp();
}

// startFinanzas() se llama desde la plataforma

function selectCardColor(el,color){
  document.querySelectorAll('#modal-add-card [onclick^="selectCardColor"]').forEach(e=>e.style.border='none');
  el.style.border='2px solid #E8C547';
  window._selCardColor=color;
}
function saveCard(){
  const bank=document.getElementById('card-bank').value.trim();
  const digits=document.getElementById('card-digits').value.trim();
  const limit=parseFloat(document.getElementById('card-limit').value)||0;
  const closeDay=parseInt(document.getElementById('card-close-day').value)||0;
  if(!bank){alert('Ingresá el nombre del banco');return;}
  if(!S.cards)S.cards=[];
  S.cards.push({bank,digits,limit,closeDay,color:window._selCardColor||'#2d2d3a'});
  FZ_save();FZ_closeModal('add-card');FZ_renderTarjeta();
  ['card-bank','card-digits','card-limit','card-close-day'].forEach(id=>document.getElementById(id).value='');
}
function delCard(idx){
  if(!confirm('¿Eliminar esta tarjeta?'))return;
  S.cards.splice(idx,1);FZ_save();FZ_renderTarjeta();
}

window.startFinanzas = async function() {
  await FZ_cloudLoad();
  FZ_init();
};
</script>

</body>
</html>